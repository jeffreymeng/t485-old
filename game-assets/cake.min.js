Array.prototype.deleteFirst=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return this.splice(e,1),!0;return!1},Array.prototype.equals=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0;e<this.length;e++){var i=this[e],n=t[e];if(i.equals&&"function"==typeof i.equals){if(!i.equals(n))return!1}else if(i!=n)return!1}return!0},Array.prototype.rotate=function(t){return t?(this.unshift(this.pop()),this[0]):(this.push(this.shift()),this[this.length-1])},Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]},Array.prototype.flatten=function(){for(var t=[],e=0;e<this.length;e++){var i=this[e];if(i.flatten)for(var n=i.flatten(),r=0;r<n.length;r++)t[t.length]=n[r];else t[t.length]=i}return t},Array.prototype.take=function(){for(var t=[],e=0;e<this.length;e++){for(var i=[],n=0;n<arguments.length;n++)i[n]=this[e][arguments[n]];t[e]=i}return t},Array.prototype.pluck||(Array.prototype.pluck=function(t){for(var e=[],i=0;i<this.length;i++)e[i]=this[i][t];return e}),Array.prototype.set=function(t,e){for(var i=0;i<this.length;i++)this[i][t]=e},Array.prototype.allWith=function(){var t=[];t:for(var e=0;e<this.length;e++){for(var i=this[e],n=0;n<arguments.length;n++)if(!this[e][arguments[n]])continue t;t[t.length]=i}return t},Element.prototype.append=function(){for(var t=0;t<arguments.length;t++)this.appendChild("string"==typeof arguments[t]?T(arguments[t]):arguments[t])},Function.prototype.bind||(Function.prototype.bind=function(t){var e=this;return function(){return e.apply(t,arguments)}}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t){for(var e=0;e<this.length;e++)if(t==this[e])return e;return-1}),Array.prototype.map=function(t){var e=new Array(this.length);if(t)for(var i=0;i<this.length;i++)e[i]=t(this[i],i,this);else for(var i=0;i<this.length;i++)e[i]=this[i];return e},Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t(this[e],e,this)},Array.prototype.reduce||(Array.prototype.reduce=function(t,e){var i=0;for(1==arguments.length&&(e=this[0],i++);i<this.length;i++)e=t(e,this[i],i,this);return e}),Array.prototype.find||(Array.prototype.find=function(t){for(var e=0;e<this.length;e++)if(t(this[e],e,this))return this[e]}),String.prototype.capitalize||(String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())}),String.prototype.escape||(String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'}),String.prototype.splice||(String.prototype.splice=function(t,e,i){return this.slice(0,t)+i+this.slice(t+e)}),String.prototype.strip||(String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")}),window.$A||($A=function(t){for(var e=new Array(t.length),i=0;i<t.length;i++)e[i]=t[i];return e}),window.$||($=function(t){return document.getElementById(t)}),Math.sinh||(Math.sinh=function(t){return.5*(Math.exp(t)-Math.exp(-t))},Math.asinh=function(t){return Math.log(t+Math.sqrt(t*t+1))}),Math.cosh||(Math.cosh=function(t){return.5*(Math.exp(t)+Math.exp(-t))},Math.acosh=function(t){return Math.log(t+Math.sqrt(t*t-1))}),E=function(t,e,i){var n=document.createElement(t);if(e&&("string"==typeof e?(n.innerHTML=e,e=i):e.DOCUMENT_NODE&&(n.appendChild(e),e=i),e)){if(e.style){var r=e.style;e=Object.clone(e),delete e.style,Object.forceExtend(n.style,r)}e.content&&(n.appendChild("string"==typeof e.content?T(e.content):e.content),e=Object.clone(e),delete e.content),Object.forceExtend(n,e)}return n},E.lastCanvasId=0,E.canvas=function(t,e,i){var n="canvas-uuid-"+E.lastCanvasId;return E.lastCanvasId++,i||(i={}),E("canvas",Object.extend(i,{id:n,width:t,height:e}))},T=function(t){return document.createTextNode(t)},Object.forceExtend=function(t,e){for(var i in e)try{t[i]=e[i]}catch(n){}return t},Object.extend||(Object.extend=Object.forceExtend),Object.conditionalExtend=function(t,e){for(var i in e)null==t[i]&&(t[i]=e[i]);return t},Object.clone=function(src){if(!src||1==src)return src;switch(typeof src){case"string":return Object.extend(src+"",src);case"number":return src;case"function":return obj=eval(src.toSource()),Object.extend(obj,src);case"object":return src instanceof Array?Object.extend([],src):Object.extend({},src)}},Object.loadImage=function(t,e){var i=new Image;return e&&(i.onload=e),i.src=t,i},Object.isImageLoaded=function(t){return"CANVAS"==t.tagName?!0:t.complete?null==t.naturalWidth?!0:!!t.naturalWidth:!1},Object.sum=function(t,e){if(t instanceof Array){if(e instanceof Array){for(var i=[],n=0;n<t.length;n++)i[n]=t[n]+e[n];return i}return t.map(function(t){return t+e})}return e instanceof Array?e.map(function(e){return e+t}):t+e},Object.sub=function(t,e){if(t instanceof Array){if(e instanceof Array){for(var i=[],n=0;n<t.length;n++)i[n]=t[n]-e[n];return i}return t.map(function(t){return t-e})}return e instanceof Array?e.map(function(e){return t-e}):t-e},window.Mouse||(Mouse={}),Mouse.getRelativeCoords=function(t,e){for(var i={x:0,y:0},n=0,r=0,s=t;s;)n+=s.offsetLeft,r+=s.offsetTop,s=s.offsetParent;return i.x=e.pageX-n,i.y=e.pageY-r,i},Browser=function(){var t=window.navigator.userAgent,e=t.match(/KHTML/),i=t.match(/Gecko/),n=t.match(/WebKit\/\d+/),r=t.match(/Explorer/);return e?"KHTML":i?"Gecko":n?"Webkit":r?"IE":"UNKNOWN"}(),Mouse.LEFT=0,Mouse.MIDDLE=1,Mouse.RIGHT=2,"IE"==Browser&&(Mouse.LEFT=1,Mouse.MIDDLE=4),Klass=function(){var t=function(){this.initialize.apply(this,arguments)};t.ancestors=$A(arguments),t.prototype={};for(var e=0;e<arguments.length;e++){var i=arguments[e];i.prototype?Object.extend(t.prototype,i.prototype):Object.extend(t.prototype,i)}return Object.extend(t,t.prototype),t},Curves={angularDistance:function(t,e){var i=2*Math.PI,n=(e-t)%i;return n>Math.PI&&(n-=i),n<-Math.PI&&(n+=i),n},linePoint:function(t,e,i){return[t[0]+(e[0]-t[0])*i,t[1]+(e[1]-t[1])*i]},quadraticPoint:function(t,e,i,n){var r=t[0]+(e[0]-t[0])*n,s=e[0]+(i[0]-e[0])*n,a=r+(s-r)*n,o=t[1]+(e[1]-t[1])*n,h=e[1]+(i[1]-e[1])*n,l=o+(h-o)*n;return[a,l]},cubicPoint:function(t,e,i,n,r){var s=3*t[0],a=3*e[0],o=3*i[0],h=3*t[1],l=3*e[1],u=3*i[1];return[t[0]+r*(a-s+r*(s-2*a+o+r*(a-t[0]-o+n[0]))),t[1]+r*(l-h+r*(h-2*l+u+r*(l-t[1]-u+n[1])))]},linearValue:function(t,e,i){return t+(e-t)*i},quadraticValue:function(t,e,i,n){var r=t+(e-t)*n,s=e+(i-e)*n;return r+(s-r)*n},cubicValue:function(t,e,i,n,r){var s=3*t,a=3*e,o=3*i;return t+r*(a-s+r*(s-2*a+o+r*(a-t-o+n)))},catmullRomPoint:function(t,e,i,n,r){var s=((-r+2)*r-1)*r*.5,a=.5*((3*r-5)*r*r+2),o=((-3*r+4)*r+1)*r*.5,h=(r-1)*r*r*.5;return[t[0]*s+e[0]*a+i[0]*o+n[0]*h,t[1]*s+e[1]*a+i[1]*o+n[1]*h]},catmullRomAngle:function(t,e,i,n,r){var s=.5*(i[0]-t[0]+2*r*(2*t[0]-5*e[0]+4*i[0]-n[0])+3*r*r*(3*e[0]+n[0]-t[0]-3*i[0])),a=.5*(i[1]-t[1]+2*r*(2*t[1]-5*e[1]+4*i[1]-n[1])+3*r*r*(3*e[1]+n[1]-t[1]-3*i[1]));return Math.atan2(a,s)},catmullRomPointAngle:function(t,e,i,n,r){var s=this.catmullRomPoint(t,e,i,n,r),t=this.catmullRomAngle(t,e,i,n,r);return{point:s,angle:t}},lineAngle:function(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])},quadraticAngle:function(t,e,i,n){var r=this.linePoint(t,e,n),s=this.linePoint(e,i,n);return this.lineAngle(r,s)},cubicAngle:function(t,e,i,n,r){var s=this.quadraticPoint(t,e,i,r),a=this.quadraticPoint(e,i,n,r);return this.lineAngle(s,a)},lineLength:function(t,e){var i=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(i*i+n*n)},squareLineLength:function(t,e){var i=e[0]-t[0],n=e[1]-t[1];return i*i+n*n},quadraticLength:function(t,e,i,n){var r=this.linePoint(t,e,2/3),s=this.linePoint(e,i,1/3);return this.cubicLength(t,r,s,i,n)},cubicLength:function(){var t=function(t){for(var e=[t.slice(0)],i=1;4>i;i++){e[i]=[[],[],[],[]];for(var n=0;4-i>n;n++)e[i][n][0]=.5*(e[i-1][n][0]+e[i-1][n+1][0]),e[i][n][1]=.5*(e[i-1][n][1]+e[i-1][n+1][1])}for(var r=[],s=[],n=0;4>n;n++)r[n]=e[n][0],s[n]=e[3-n][n];return[r,s]},e=function(i,n){for(var r=0,s=0;3>s;s++)r+=Curves.lineLength(i[s],i[s+1]);var a=Curves.lineLength(i[0],i[3]);if(r-a>n){var o=t(i);r=e(o[0],n)+e(o[1],n)}return r};return function(t,i,n,r,s){return s||(s=1),e([t,i,n,r],s)}}(),quadraticLengthPointAngle:function(t,e,i,n,r){var s=this.linePoint(t,e,2/3),a=this.linePoint(e,i,1/3);return this.cubicLengthPointAngle(t,s,a,i,r)},cubicLengthPointAngle:function(t,e,i,n,r,s){for(var a=this.cubicLength(t,e,i,n,s),o=t,h=t,l=0,u=0,c=r*a,d=20,f=1/d,p=1;d>=p;p++)if(h=o,o=this.cubicPoint(t,e,i,n,f*p),l=u,u+=this.lineLength(h,o),u>=c){if(u==l)return{point:o,angle:this.lineAngle(t,e)};var g=u-c,v=g/(u-l);return{point:this.linePoint(h,o,1-v),angle:this.cubicAngle(t,e,i,n,f*(p-v))}}return{point:n.slice(0),angle:this.lineAngle(i,n)}}},Colors={hsl2rgb:function(t,e,i){var n,r,s;if(0==e)n=r=s=v;else{var a=.5>i?i*(1+e):i+e-i*e,o=2*i-a,h=t%360/360,l=h+1/3,u=h,c=h-1/3;0>l&&l++,l>1&&l--,0>u&&u++,u>1&&u--,0>c&&c++,c>1&&c--,n=1/6>l?o+6*(a-o)*l:.5>l?a:2/3>l?o+6*(a-o)*(2/3-l):o,r=1/6>u?o+6*(a-o)*u:.5>u?a:2/3>u?o+6*(a-o)*(2/3-u):o,s=1/6>c?o+6*(a-o)*c:.5>c?a:2/3>c?o+6*(a-o)*(2/3-c):o}return[n,r,s]},hsv2rgb:function(t,e,i){var n,r,s;if(0==e)n=r=s=i;else{t=t%360/60;var a=Math.floor(t),o=t-a,h=i*(1-e),l=i*(1-e*o),u=i*(1-e*(1-o));switch(a){case 0:n=i,r=u,s=h;break;case 1:n=l,r=i,s=h;break;case 2:n=h,r=i,s=u;break;case 3:n=h,r=l,s=i;break;case 4:n=u,r=h,s=i;break;case 5:n=i,r=h,s=l}}return[n,r,s]},parseColorStyle:function(t,e){if("string"==typeof t)return t;if(t.compiled)return t.compiled;if(t.isPattern)return t.compile(e);if(3==t.length)return"rgba("+t.map(Math.round).join(",")+", 1)";if(4==t.length)return"rgba("+Math.round(t[0])+","+Math.round(t[1])+","+Math.round(t[2])+","+t[3]+")";throw"Bad style: "+t}},CanvasSupport={DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,getSupportsWebkitTransform:function(){if(null==this.supportsWebKitTransform){var t=window.navigator.userAgent,e=t.match(/WebKit\/\d+/),i=!1;e&&parseInt(e[0].split("/")[1])>=525&&(i=!0),this.supportsWebKitTransform=i}return this.supportsWebKitTransform},getTestContext:function(){if(!this.testContext){var t=E.canvas(1,1);this.testContext=t.getContext("2d")}return this.testContext},getSupportsAudioTag:function(){var t=E("audio");return!!t.play},getSupportsSoundManager:function(){return window.soundManager&&soundManager.enabled},soundId:0,getSoundObject:function(){var t=null;return this.getSupportsAudioTag()?t=this.getAudioTagSoundObject():this.getSupportsSoundManager()&&(t=this.getSoundManagerSoundObject()),t},getAudioTagSoundObject:function(){var t="sound-"+this.soundId++,e=E("audio",{id:t});return e.load=function(t){this.src=t},e.addEventListener("canplaythrough",function(){this.onready&&this.onready()},!1),e.setVolume=function(t){this.volume=t},e.setPan=function(t){this.pan=t},e},getSoundManagerSoundObject:function(){var t="sound-"+this.soundId++,e={volume:100,pan:0,sid:t,load:function(t){return soundManager.load(this.sid,{url:t,autoPlay:!1,volume:this.volume,pan:this.pan})},_onload:function(){this.onload&&this.onload(),this.onready&&this.onready()},_onerror:function(){this.onerror&&this.onerror()},_onfinish:function(){this.onfinish&&this.onfinish()},play:function(){return soundManager.play(this.sid)},stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(t){return this.volume=100*t,soundManager.setVolume(this.sid,100*t)},setPan:function(t){return this.pan=100*t,soundManager.setPan(this.sid,100*t)}};return soundManager.createSound(t,"null.mp3"),e.sound=soundManager.getSoundById(t),e.sound.options.onfinish=e._onfinish.bind(e),e.sound.options.onload=e._onload.bind(e),e.sound.options.onerror=e._onerror.bind(e),e},ContextSetterAugment:{setFillStyle:function(t){this.fillStyle=t},setStrokeStyle:function(t){this.strokeStyle=t},setGlobalAlpha:function(t){this.globalAlpha=t},setLineWidth:function(t){this.lineWidth=t},setLineCap:function(t){this.lineCap=t},setLineJoin:function(t){this.lineJoin=t},setMiterLimit:function(t){this.miterLimit=t},setGlobalCompositeOperation:function(t){this.globalCompositeOperation=t},setShadowColor:function(t){this.shadowColor=t},setShadowBlur:function(t){this.shadowBlur=t},setShadowOffsetX:function(t){this.shadowOffsetX=t},setShadowOffsetY:function(t){this.shadowOffsetY=t},setMozTextStyle:function(t){this.mozTextStyle=t}},ContextJSImplAugment:{identity:function(){CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(t){return Object.conditionalExtend(t,this.ContextSetterAugment),Object.conditionalExtend(t,this.ContextJSImplAugment),t},getContext:function(t,e){var i=t.getContext(e||"2d");return this.augment(i),i},tMatrixMultiply:function(t,e){var i=t[0]*e[0]+t[2]*e[1],n=t[1]*e[0]+t[3]*e[1],r=t[0]*e[2]+t[2]*e[3],s=t[1]*e[2]+t[3]*e[3],a=t[0]*e[4]+t[2]*e[5]+t[4],o=t[1]*e[4]+t[3]*e[5]+t[5];return t[0]=i,t[1]=n,t[2]=r,t[3]=s,t[4]=a,t[5]=o,t},tMatrixMultiplyPoint:function(t,e,i){return[e*t[0]+i*t[2]+t[4],e*t[1]+i*t[3]+t[5]]},tInvertMatrix:function(t){var e=1/(t[0]*t[3]-t[1]*t[2]);return[t[3]*e,-t[1]*e,-t[2]*e,t[0]*e,e*(t[2]*t[5]-t[3]*t[4]),e*(t[1]*t[4]-t[0]*t[5])]},transform:function(t,e){if(t.transform)return t.transform.apply(t,e);if(t.translate(e[4],e[5]),Math.abs(e[1])<1e-6&&Math.abs(e[2])<1e-6)return void t.scale(e[0],e[3]);var i=this.svdTransform({xx:e[0],xy:e[2],yx:e[1],yy:e[3],dx:e[4],dy:e[5]});t.rotate(i.angle2),t.scale(i.sx,i.sy),t.rotate(i.angle1)},brokenSvd:function(t){var e=[t[0],t[2],t[1],t[3],0,0],i=[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],0,0],n=1,r=-(i[0]+i[3]),s=-(i[1]*i[2])+i[0]*i[3],a=Math.sqrt(r*r-4*n*s),o=(-r+a)/(2*n),h=(-r-a)/(2*n);if(h>o)var l=o,o=h,h=l;var u=Math.sqrt(o),c=Math.sqrt(h),d=[1/u,0,0,1/c,0,0],f=(i[0]-o)/i[2],p=Math.sqrt(1+f*f),g=1/p,v=f/p,m=g,y=-v,x=[g,y,v,m,0,0],b=t.slice(0);return this.tMatrixMultiply(b,x),this.tMatrixMultiply(b,d),[b,[u,0,0,c,0,0],[g,v,y,m,0,0]]},svdTransform:function(){var t={};t.Matrix2D=function(e){if(e)if("number"==typeof e)this.xx=this.yy=e;else if(e instanceof Array){if(e.length>0){for(var i=t.normalize(e[0]),n=1;n<e.length;++n){var r=i,s=t.normalize(e[n]);i=new t.Matrix2D,i.xx=r.xx*s.xx+r.xy*s.yx,i.xy=r.xx*s.xy+r.xy*s.yy,i.yx=r.yx*s.xx+r.yy*s.yx,i.yy=r.yx*s.xy+r.yy*s.yy,i.dx=r.xx*s.dx+r.xy*s.dy+r.dx,i.dy=r.yx*s.dx+r.yy*s.dy+r.dy}Object.extend(this,i)}}else Object.extend(this,e)},t.normalize=function(e){return e instanceof t.Matrix2D?e:new t.Matrix2D(e)},t.multiply=function(e){for(var i=t.normalize(e),n=1;n<arguments.length;++n){var r=i,s=t.normalize(arguments[n]);i=new t.Matrix2D,i.xx=r.xx*s.xx+r.xy*s.yx,i.xy=r.xx*s.xy+r.xy*s.yy,i.yx=r.yx*s.xx+r.yy*s.yx,i.yy=r.yx*s.xy+r.yy*s.yy,i.dx=r.xx*s.dx+r.xy*s.dy+r.dx,i.dy=r.yx*s.dx+r.yy*s.dy+r.dy}return i},t.invert=function(e){var i=t.normalize(e),n=i.xx*i.yy-i.xy*i.yx,i=new t.Matrix2D({xx:i.yy/n,xy:-i.xy/n,yx:-i.yx/n,yy:i.xx/n,dx:(i.xy*i.dy-i.yy*i.dx)/n,dy:(i.yx*i.dx-i.xx*i.dy)/n});return i},Object.extend(t.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var e=function(t,e){return Math.abs(t-e)<=1e-6*(Math.abs(t)+Math.abs(e))},i=function(t,e){return isFinite(t)?isFinite(e)?(t+e)/2:t:e},n=function(e){var i=new t.Matrix2D(e);return Object.extend(i,{dx:0,dy:0,xy:i.yx,yx:i.xy})},r=function(t){return t.xx*t.yy<0||t.xy*t.yx>0?-1:1},s=function(i){var n=t.normalize(i),r=-n.xx-n.yy,s=n.xx*n.yy-n.xy*n.yx,a=Math.sqrt(r*r-4*s),o=-(r+(0>r?-a:a))/2,h=s/o,l=n.xy/(o-n.xx),u=1,c=n.xy/(h-n.xx),d=1;e(o,h)&&(l=1,u=0,c=0,d=1),isFinite(l)||(l=1,u=(o-n.xx)/n.xy,isFinite(u)||(l=(o-n.yy)/n.yx,u=1,isFinite(l)||(l=1,u=n.yx/(o-n.yy)))),isFinite(c)||(c=1,d=(h-n.xx)/n.xy,isFinite(d)||(c=(h-n.yy)/n.yx,d=1,isFinite(c)||(c=1,d=n.yx/(h-n.yy))));var f=Math.sqrt(l*l+u*u),p=Math.sqrt(c*c+d*d);return isNaN(l/=f)&&(l=0),isNaN(u/=f)&&(u=0),isNaN(c/=p)&&(c=0),isNaN(d/=p)&&(d=0),{value1:o,value2:h,vector1:{x:l,y:u},vector2:{x:c,y:d}}},a=function(t,e){var n=r(t),s=e.angle1=(Math.atan2(t.yx,t.yy)+Math.atan2(-n*t.xy,n*t.xx))/2,a=Math.cos(s),o=Math.sin(s);return e.sx=i(t.xx/a,-t.xy/o),e.sy=i(t.yy/a,t.yx/o),e},o=function(t,e){var n=r(t),s=e.angle2=(Math.atan2(n*t.yx,n*t.xx)+Math.atan2(-t.xy,t.yy))/2,a=Math.cos(s),o=Math.sin(s);return e.sx=i(t.xx/a,t.yx/o),e.sy=i(t.yy/a,-t.xy/o),e};return function(i){var r=t.normalize(i),h={dx:r.dx,dy:r.dy,sx:1,sy:1,angle1:0,angle2:0};if(e(r.xy,0)&&e(r.yx,0))return Object.extend(h,{sx:r.xx,sy:r.yy});if(e(r.xx*r.yx,-r.xy*r.yy))return a(r,h);if(e(r.xx*r.xy,-r.yx*r.yy))return o(r,h);var l=n(r),u=s([r,l]),c=s([l,r]),d=new t.Matrix2D({xx:u.vector1.x,xy:u.vector2.x,yx:u.vector1.y,yy:u.vector2.y}),f=new t.Matrix2D({xx:c.vector1.x,xy:c.vector1.y,yx:c.vector2.x,yy:c.vector2.y}),p=new t.Matrix2D([t.invert(d),r,t.invert(f)]);return a(f,h),p.xx*=h.sx,p.yy*=h.sy,o(d,h),p.xx*=h.sx,p.yy*=h.sy,Object.extend(h,{sx:p.xx,sy:p.yy})}}(),setTransform:function(t,e,i){return t.setTransform?t.setTransform.apply(t,e):(this.transform(t,this.tInvertMatrix(i)),void this.transform(t,e))},skewX:function(t,e){return this.transform(t,this.tSkewXMatrix(e))},skewY:function(t,e){return this.transform(t,this.tSkewYMatrix(e))},tRotate:function(t,e){var i=Math.cos(e),n=Math.sin(e),r=t[0]*i+t[2]*n,s=t[1]*i+t[3]*n,a=t[0]*-n+t[2]*i,o=t[1]*-n+t[3]*i;return t[0]=r,t[1]=s,t[2]=a,t[3]=o,t},tTranslate:function(t,e,i){return t[4]+=t[0]*e+t[2]*i,t[5]+=t[1]*e+t[3]*i,t},tScale:function(t,e,i){return t[0]*=e,t[1]*=e,t[2]*=i,t[3]*=i,t},tSkewX:function(t,e){return this.tMatrixMultiply(t,this.tSkewXMatrix(e))},tSkewY:function(t,e){return this.tMatrixMultiply(t,this.tSkewYMatrix(e))},tSkewXMatrix:function(t){return[1,0,Math.tan(t),1,0,0]},tSkewYMatrix:function(t){return[1,Math.tan(t),0,1,0,0]},tRotationMatrix:function(t){var e=Math.cos(t),i=Math.sin(t);return[e,i,-i,e,0,0]},tTranslationMatrix:function(t,e){return[1,0,0,1,t,e]},tScalingMatrix:function(t,e){return[t,0,0,e,0,0]},getTextBackend:function(){return null==this.textBackend&&(this.textBackend=this.detectTextBackend()),this.textBackend},detectTextBackend:function(){var t=this.getTestContext();return t.mozDrawText?"MozText":t.drawString?"DrawString":"NONE"},getSupportsPutImageData:function(){if(null==this.supportsPutImageData){var t=this.getTestContext(),e=t.putImageData;if(e)try{t.putImageData({width:1,height:1,data:[255,0,255,255]},0,0);var i=t.getImageData(0,0,1,1);[255,0,255,255].equals(i.data)||(e=!1)}catch(n){e=!1}this.supportsPutImageData=e}return e},getSupportsIsPointInPath:function(){return null==this.supportsIsPointInPath&&(this.supportsIsPointInPath=!!this.getTestContext().isPointInPath),this.supportsIsPointInPath},getIsPointInPathMode:function(){return null==this.isPointInPathMode&&(this.isPointInPathMode=this.detectIsPointInPathMode()),this.isPointInPathMode},detectIsPointInPathMode:function(){var t,e=this.getTestContext();return e.isPointInPath?(e.save(),e.translate(1,0),e.beginPath(),e.rect(0,0,1,1),t=e.isPointInPath(.3,.3)?this.USER_SPACE:this.DEVICE_SPACE,e.restore(),t):this.USER_SPACE},isPointInPath:function(t,e,i,n,r){var s;if(t.isPointInPath){if(this.getIsPointInPathMode()==this.USER_SPACE)if(t.setTransform)t.save(),t.setTransform(1,0,0,1,0,0),s=t.isPointInPath(e,i),t.restore();else{var a=this.tMatrixMultiplyPoint(this.tInvertMatrix(n),e,i);s=t.isPointInPath(a[0],a[1])}else s=t.isPointInPath(e,i);return s}if(r&&r.isPointInPath){var a=this.tMatrixMultiplyPoint(this.tInvertMatrix(n),e,i);return r.isPointInPath(a[0],a[1])}return!1}},RecordingContext=Klass({objectId:0,commands:[],isMockObject:!0,initialize:function(t){this.commands=t||[],Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!RecordingContext.MockContext){var t=E.canvas(1,1),e=CanvasSupport.getContext(t,"2d"),i={};for(var n in e)i[n]="function"==typeof e[n]?this.createRecordingFunction(n):e[n];i.isPointInPath=null,i.transform=null,i.setTransform=null,RecordingContext.MockContext=i}return RecordingContext.MockContext},createRecordingFunction:function(t){if(-1!=t.search(/^set[A-Z]/)&&"setTransform"!=t){var e=t.charAt(3).toLowerCase()+t.slice(4);return function(){this[e]=arguments[0],this.commands.push([t,$A(arguments)])}}return function(){this.commands.push([t,$A(arguments)])}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(t,e){return"("+{width:t,height:e,commands:this.getRecording()}.toSource()+")"},play:function(t){RecordingContext.play(t,this.getRecording())},createLinearGradient:function(){var t=this.objectId++;return this.commands.push([t,"=","createLinearGradient",$A(arguments)]),new MockGradient(this,t)},createRadialGradient:function(){var t=this.objectId++;return this.commands.push([t,"=","createRadialGradient",$A(arguments)]),new this.MockGradient(this,t)},createPattern:function(){var t=this.objectId++;return this.commands.push([t,"=","createPattern",$A(arguments)]),new this.MockGradient(this,t)},MockGradient:Klass({isMockObject:!0,initialize:function(t,e){this.recorder=t,this.id=e},addColorStop:function(){this.recorder.commands.push([this.id,"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:!0}.toSource()}})}),RecordingContext.play=function(t,e){for(var i=[],n=0;n<e.length;n++){var r=e[n];if(2==r.length){var s=r[1];s[0]&&s[0].isMockObject?t[r[0]](i[s[0].id]):t[r[0]].apply(t,r[1])}else if(3==r.length){var a=i[r[0]];a[r[1]].apply(a,r[2])}else{if(4!=r.length)throw"Malformed command: "+r.toString();i[r[0]]=t[r[2]].apply(t,r[3])}}},Transformable=Klass({needMatrixUpdate:!0,transform:function(t){var e=this.absoluteMatrix,i=this.x||this.y,n=this.rotation,r=null!=this.scale,s=this.skewX,a=this.skewY,o=this.matrix,h=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(this.currentMatrix||(this.currentMatrix=[1,0,0,1,0,0]),this.parent?this.__copyMatrix(this.parent.currentMatrix):this.__identityMatrix(),e&&this.__setMatrixMatrix(this.absoluteMatrix),i&&this.__translateMatrix(this.x,this.y),n&&this.__rotateMatrix(this.rotation),s&&this.__skewXMatrix(this.skewX),a&&this.__skewYMatrix(this.skewY),r&&this.__scaleMatrix(this.scale),o&&this.__matrixMatrix(this.matrix),h)for(var l=0;l<this.transformList.length;l++){var h=this.transformList[l];this["__"+h[0]+"Matrix"](h[1])}this.needMatrixUpdate=!1}if(t&&(e&&this.__setMatrix(t,this.absoluteMatrix),i&&this.__translate(t,this.x,this.y),n&&this.__rotate(t,this.rotation),s&&this.__skewX(t,this.skewX),a&&this.__skewY(t,this.skewY),r&&this.__scale(t,this.scale),o&&this.__matrix(t,this.matrix),h))for(var l=0;l<this.transformList.length;l++){var h=this.transformList[l];this["__"+h[0]](t,h[1])}},distanceTo:function(t){return Curves.lineLength([this.x,this.y],[t.x,t.y])},angleTo:function(t){return Curves.lineAngle([this.x,this.y],[t.x,t.y])},__setMatrixMatrix:function(t){this.previousMatrix||(this.previousMatrix=[]);var e=this.previousMatrix,i=this.currentMatrix;e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e=this.currentMatrix,i=t,e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5]},__copyMatrix:function(t){var e=this.currentMatrix,i=t;e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5]},__identityMatrix:function(){var t=this.currentMatrix;t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0},__translateMatrix:function(t,e){t.length?CanvasSupport.tTranslate(this.currentMatrix,t[0],t[1]):CanvasSupport.tTranslate(this.currentMatrix,t,e)},__rotateMatrix:function(t){if(t.length){if(t[0]%Math.PI*2==0)return;t[1]||t[2]?(CanvasSupport.tTranslate(this.currentMatrix,t[1],t[2]),CanvasSupport.tRotate(this.currentMatrix,t[0]),CanvasSupport.tTranslate(this.currentMatrix,-t[1],-t[2])):CanvasSupport.tRotate(this.currentMatrix,t[0])}else{if(t%Math.PI*2==0)return;CanvasSupport.tRotate(this.currentMatrix,t)}},__skewXMatrix:function(t){t.length&&t[0]?CanvasSupport.tSkewX(this.currentMatrix,t[0]):CanvasSupport.tSkewX(this.currentMatrix,t)},__skewYMatrix:function(t){t.length&&t[0]?CanvasSupport.tSkewY(this.currentMatrix,t[0]):CanvasSupport.tSkewY(this.currentMatrix,t)},__scaleMatrix:function(t){if(2==t.length){if(1==t[0]&&1==t[1])return;CanvasSupport.tScale(this.currentMatrix,t[0],t[1])}else if(3==t.length){if(1==t[0]||t[0].length&&1==t[0][0]&&1==t[0][1])return;CanvasSupport.tTranslate(this.currentMatrix,t[1],t[2]),t[0].length?CanvasSupport.tScale(this.currentMatrix,t[0][0],t[0][1]):CanvasSupport.tScale(this.currentMatrix,t[0],t[0]),CanvasSupport.tTranslate(this.currentMatrix,-t[1],-t[2])}else 1!=t&&CanvasSupport.tScale(this.currentMatrix,t,t)},__matrixMatrix:function(t){CanvasSupport.tMatrixMultiply(this.currentMatrix,t)},__setMatrix:function(t,e){CanvasSupport.setTransform(t,e,this.previousMatrix)},__translate:function(t,e,i){null!=e.length?t.translate(e[0],e[1]):t.translate(e,i)},__rotate:function(t,e){if(e.length)if(e[1]||e[2]){if(e[0]%Math.PI*2==0)return;t.translate(e[1],e[2]),t.rotate(e[0]),t.translate(-e[1],-e[2])}else t.rotate(e[0]);else t.rotate(e)},__skewX:function(t,e){e.length&&e[0]?CanvasSupport.skewX(t,e[0]):CanvasSupport.skewX(t,e)},__skewY:function(t,e){e.length&&e[0]?CanvasSupport.skewY(t,e[0]):CanvasSupport.skewY(t,e)},__scale:function(t,e){2==e.length?t.scale(e[0],e[1]):3==e.length?(t.translate(e[1],e[2]),e[0].length?t.scale(e[0][0],e[0][1]):t.scale(e[0],e[0]),t.translate(-e[1],-e[2])):t.scale(e,e)},__matrix:function(t,e){CanvasSupport.transform(t,e)}}),Timeline=Klass({startTime:null,repeat:!1,initialize:function(t){this.repeat=t,this.keyframes=[]},addKeyframe:function(t,e,i){this.keyframes.push(1==arguments.length?t:{time:t,target:e,tween:i})},evaluate:function(t,e){null==this.startTime&&(this.startTime=e);var i=e-this.startTime;if(this.keyframes.length>0){for(var n,r,s,a=0;a<this.keyframes.length;a++)if(this.keyframes[a].time>i){n=a;break}if(null!=n&&(r=this.keyframes[n-1],s=this.keyframes[n]),s){if(r){this.keyframes.atEnd=!1;var o=i-r.time,h=s.time-r.time,l=o/h;for(var u in s.target)null!=r.target[u]&&t.tweenVariable(u,r.target[u],s.target[u],l,s.tween)}}else this.keyframes.atEnd||(this.keyframes.atEnd=!0,r=this.keyframes[this.keyframes.length-1],Object.extend(t,Object.clone(r.target)),this.repeat&&(this.startTime=e),t.changed=!0)}}}),Animatable=Klass({tweenFunctions:{linear:function(t){return t},set:function(t){return Math.floor(t)},discrete:function(t){return Math.floor(t)},sine:function(t){return.5-.5*Math.cos(t*Math.PI)},sproing:function(t){return 1.05263157894737*(.5-.5*Math.cos(3.59261946538606*t))},square:function(t){return t*t},cube:function(t){return t*t*t},sqrt:function(t){return Math.sqrt(t)},curt:function(t){return Math.pow(t,-.333333333333)}},initialize:function(){this.timeline=[],this.keyframes=[],this.pendingKeyframes=[],this.pendingTimelineEvents=[],this.timelines=[],this.animators=[],this.addFrameListener(this.updateTimelines),this.addFrameListener(this.updateKeyframes),this.addFrameListener(this.updateTimeline),this.addFrameListener(this.updateAnimators)},updateTimelines:function(t,e){for(var i=0;i<this.timelines.length;i++)this.timelines[i].evaluate(this,t,e)},addTimeline:function(t){this.timelines.push(t)},removeTimeline:function(t){this.timelines.deleteFirst(t)},updateKeyframes:function(t){if(this.pendingKeyframes.length>0){for(;this.pendingKeyframes.length>0;){var e=this.pendingKeyframes.pop();null==e.time&&(e.time=e.relativeTime+t),this.keyframes.push(e)}this.keyframes.sort(function(t,e){return t.time-e.time})}if(this.keyframes.length>0){for(var i,n,r,s=0;s<this.keyframes.length;s++)if(this.keyframes[s].time>t){i=s;break}if(null!=i&&(n=this.keyframes[i-1],r=this.keyframes[i]),r){if(n){this.keyframes.atEnd=!1;var a=t-n.time,o=r.time-n.time,h=a/o;for(var l in r.target)null!=n.target[l]&&this.tweenVariable(l,n.target[l],r.target[l],h,r.tween)}}else this.keyframes.atEnd||(this.keyframes.atEnd=!0,n=this.keyframes[this.keyframes.length-1],Object.extend(this,Object.clone(n.target)),this.changed=!0)}},updateTimeline:function(t,e){if(this.pendingTimelineEvents.length>0){for(;this.pendingTimelineEvents.length>0;){var i=this.pendingTimelineEvents.pop();i.startTime||(i.startTime=i.relativeStartTime+t),this.timeline.push(i)}this.timeline.sort(function(t,e){return t.startTime-e.startTime})}for(;this.timeline[0]&&this.timeline[0].startTime<=t;){var n=this.timeline.shift(),r=!0;if("function"==typeof n.action?r=n.action.call(this,t,e,n):this.animators.push(n.action),null!=n.repeatEvery&&0!=r){if(null!=n.repeatTimes){if(n.repeatTimes<=0)continue;n.repeatTimes--}n.startTime+=n.repeatEvery,this.addTimelineEvent(n)}this.changed=!0}},addTimelineEvent:function(t){this.pendingTimelineEvents.push(t)},updateAnimators:function(t){for(var e=0;e<this.animators.length;e++){var i=this.animators[e];i.startTime||(i.startTime=t);var n=t-i.startTime,r=n/i.duration,s=!1;r>=1?i.repeat?(i.repeat!==!0&&(i.repeat=Math.max(0,i.repeat-1)),i.accumulate&&(i.startValue=Object.clone(i.endValue),i.endValue=Object.sum(i.difference,i.endValue)),0==i.repeat?(s=!0,r=1):(i.startTime=t,r%=1)):(r=1,s=!0):i.repeat&&i.repeat!==!0&&i.repeat<=r&&(s=!0,r=i.repeat),this.tweenVariable(i.variable,i.startValue,i.endValue,r,i.tween),s&&(this.animators.splice(e,1),e--)}},tweenVariable:function(t,e,i,n,r){"function"!=typeof r&&(r=this.tweenFunctions[r]||this.tweenFunctions.linear);var s=r(n);if("function"!=typeof t)if(e instanceof Array)for(var a=0;a<e.length;a++)this[t][a]=e[a]+s*(i[a]-e[a]);else this[t]=e+s*(i-e);else t.call(this,s,e,i);this.changed=!0},animate:function(t,e,i,n,r,s){var e=Object.clone(e),i=Object.clone(i);if(s||(s={}),s.additive){var a=Object.sub(i,e);e=Object.sum(e,this[t]),i=Object.sum(i,this[t])}"function"!=typeof t&&(this[t]=Object.clone(e));var o={id:Animatable.uid++,variable:t,startValue:e,endValue:i,difference:a,duration:n,tween:r,repeat:s.repeat,additive:s.additive,accumulate:s.accumulate,pingpong:s.pingpong};return this.animators.push(o),o},removeAnimator:function(t){this.animators.deleteFirst(t)},animateTo:function(t,e,i,n,r){return this.animate(t,this[t],e,i,n,r)},animateFrom:function(t,e,i,n,r){return this.animate(t,e,this[t],i,n,r)},animateFactor:function(t,e,i,n,r,s){var a;if(e instanceof Array){a=[];for(var o=0;o<e.length;o++)a[o]=e[o]*i}else a=e*i;return this.animate(t,e,a,n,r,s)},animateToFactor:function(t,e,i,n,r){var s=this[t];return this.animateFactor(t,s,e,i,n,r)},addKeyframe:function(t,e,i){var n={relativeTime:t,target:e,tween:i};this.pendingKeyframes.push(n)},addKeyframeAt:function(t,e,i){var n={time:t,target:e,tween:i};this.pendingKeyframes.push(n)},every:function(t,e,i){var n={action:e,relativeStartTime:i?t:0,repeatEvery:t};return this.addTimelineEvent(n),n},at:function(t,e){var i={action:e,startTime:t};return this.addTimelineEvent(i),i},after:function(t,e){var i={action:e,relativeStartTime:t};return this.addTimelineEvent(i),i},afterFrame:function(t,e){var i,n=0;return i=function(){n>=t&&(e.call(this),this.removeFrameListener(i)),n++},this.addFrameListener(i),i},everyFrame:function(t,e,i){var n,r=i?0:t;return n=function(){r>=t&&(0==e.call(this)&&this.removeFrameListener(n),r=0),r++},this.addFrameListener(n),n}}),Animatable.uid=0,CanvasNode=Klass(Animatable,Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:!0,drawable:!0,display:null,visibility:null,catchMouse:!0,pickable:!1,underCursor:!1,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,textStyle:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,mozTextStyle:null,textStyle:null,textAlign:null,textVAlign:null,cursor:null,changed:!0,tagName:"g",getNextSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+1]:null},getPreviousSibling:function(){return this.parentNode?this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1]:null},initialize:function(t){this.root=this,this.currentMatrix=[1,0,0,1,0,0],this.previousMatrix=[1,0,0,1,0,0],this.needMatrixUpdate=!0,this.childNodes=[],this.frameListeners=[],this.eventListeners={},Animatable.initialize.call(this),t&&Object.extend(this,t)},clone:function(){var t=Object.clone(this);t.parent=t.root=null;for(var e in this)"object"==typeof this[e]&&(t[e]=Object.clone(this[e]));
t.parent=t.root=null,t.childNodes=[],t.setRoot(null);for(var e=0;e<this.childNodes.length;e++){var i=this.childNodes[e].clone();t.append(i)}return t},cloneNode:function(){return this.clone()},getElementById:function(t){if(this.id==t)return this;for(var e=0;e<this.childNodes.length;e++){var i=this.childNodes[e].getElementById(t);if(i)return i}return null},$:function(t){return this.getElementById(t)},appendChild:function(){return this.append.apply(this,arguments)},append:function(){for(var t=$A(arguments),e=0;e<t.length;e++)t[e].parent&&t[e].removeSelf(),this.childNodes.push(t[e]),t[e].parent=t[e].parentNode=this,t[e].setRoot(this.root);this.changed=!0},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},remove:function(){for(var t=arguments,e=0;e<t.length;e++)this.childNodes.deleteFirst(t[e]),delete t[e].parent,delete t[e].parentNode,t[e].setRoot(null);this.changed=!0},removeSelf:function(){this.parentNode&&this.parentNode.remove(this)},contains:function(t){for(;t;){if(t==this)return!0;t=t.parentNode}return!1},setRoot:function(t){t||(t=this),this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:t}),this.root=t;for(var e=0;e<this.childNodes.length;e++)this.childNodes[e].setRoot(t)},addFrameListener:function(t){this.frameListeners.push(t)},removeFrameListener:function(t){this.frameListeners.deleteFirst(t)},addEventListener:function(t,e,i){this.eventListeners[t]||(this.eventListeners[t]={capture:[],bubble:[]}),this.eventListeners[t][i?"capture":"bubble"].push(e)},when:function(t,e,i){this.addEventListener(t,e,i||!1)},removeEventListener:function(t,e,i){this.eventListeners[t]&&(this.eventListeners[t][i?"capture":"bubble"].deleteFirst(e),0==this.eventListeners[t].capture.length&&0==this.eventListeners[t].bubble.length&&delete this.eventListeners[t])},dispatchEvent:function(t){var e=t.type;t.canvasTarget||(t.canvasTarget=0==e.search(/^(key|text)/i)?this.root.focused||this.root.target:this.root.target,t.canvasTarget||(t.canvasTarget=this));for(var i=[],n=t.canvasTarget;n&&n!=this;)i.push(n),n=n.parent;i.push(this),t.canvasPhase="capture";for(var r=i.length-1;r>=0;r--)if(!i[r].handleEvent(t))return!1;t.canvasPhase="bubble";for(var r=0;r<i.length;r++)if(!i[r].handleEvent(t))return!1;return!0},broadcastEvent:function(t){t.type;if(t.canvasPhase="capture",!this.handleEvent(t))return!1;for(var e=0;e<this.childNodes.length;e++)if(!this.childNodes[e].broadcastEvent(t))return!1;return t.canvasPhase="bubble",this.handleEvent(t)?!0:!1},handleEvent:function(t){var e=t.type,i=t.canvasPhase;this.cursor&&"capture"==i&&(t.cursor=this.cursor);var n=this.eventListeners[e];if(n=n&&n[i])for(var r=0;r<n.length;r++){var s=n[r].call(this,t);if(0==s||t.stopped)return t.stopped||t.stopPropagation(),t.stopped=!0,!1}return!0},handleUpdate:function(t,e){this.update(t,e),this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?"none"!=this.display:this.visible);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].handleUpdate(t,e);this.parent&&this.changed&&(this.parent.changed=this.changed,this.changed=!1),this.needMatrixUpdate=!0},update:function(){for(var t=this.frameListeners.slice(0),e=0;e<t.length;e++)t[e].apply(this,arguments)},handlePick:function(t){if(this.display&&(this.visible="none"!=this.display),this.visibility&&(this.drawable="hidden"!=this.visibility),this.underCursor=!1,this.visible&&this.catchMouse&&null!=this.root.absoluteMouseX){t.save(),this.transform(t,!0),this.pickable&&this.drawable?(t.isPointInPath&&(t.beginPath(),this.drawPickingPath&&this.drawPickingPath(t)),this.underCursor=CanvasSupport.isPointInPath(this.drawPickingPath?t:!1,this.root.mouseX,this.root.mouseY,this.currentMatrix,this),this.underCursor&&(this.root.target=this)):this.underCursor=!1;var e=this.__getChildrenCopy();e.sort(this.__zIndexSort);for(var i=0;i<e.length;i++)e[i].handlePick(t),this.underCursor||(this.underCursor=e[i].underCursor);t.restore()}else for(var e=this.__getChildrenCopy();e.length>0;){var n=e.pop();n.underCursor&&(n.underCursor=!1,Array.prototype.push.apply(e,n.childNodes))}},__zIndexSort:function(t,e){return t.zIndex-e.zIndex},__getChildrenCopy:function(){if(this.__childNodesCopy){for(;this.__childNodesCopy.length>this.childNodes.length;)this.__childNodesCopy.pop();for(var t=0;t<this.childNodes.length;t++)this.__childNodesCopy[t]=this.childNodes[t]}else this.__childNodesCopy=this.childNodes.slice(0);return this.__childNodesCopy},isPointInPath:!1,handleDraw:function(t){if(this.display&&(this.visible="none"!=this.display),this.visibility&&(this.drawable="hidden"!=this.visibility),this.visible){t.save();var e=t.fontFamily,i=t.fontSize,n=t.fillOn,r=t.strokeOn;if(this.fontFamily&&(t.fontFamily=this.fontFamily),this.fontSize&&(t.fontSize=this.fontSize),this.transform(t),this.clipPath)if(t.beginPath(),this.clipPath.units==this.OBJECTBOUNDINGBOX){var s=this.getSubtreeBoundingBox(!0);t.save(),t.translate(s[0],s[1]),t.scale(s[2],s[3]),this.clipPath.createSubtreePath(t,!0),t.restore(),t.clip()}else this.clipPath.createSubtreePath(t,!0),t.clip();this.drawable&&this.draw&&this.draw(t);var a=this.__getChildrenCopy();a.sort(this.__zIndexSort);for(var o=0;o<a.length;o++)a[o].handleDraw(t);t.fontFamily=e,t.fontSize=i,t.fillOn=n,t.strokeOn=r,t.restore()}},transform:function(t,e){if(Transformable.prototype.transform.call(this,t),!e){if(null!=this.fill)if(this.fill&&"none"!=this.fill){if(t.fillOn=!0,1!=this.fill){var i=Colors.parseColorStyle(this.fill,t);t.setFillStyle(i)}}else t.fillOn=!1;null!=this.stroke&&(this.stroke&&"none"!=this.stroke?(t.strokeOn=!0,1!=this.stroke&&t.setStrokeStyle(Colors.parseColorStyle(this.stroke,t))):t.strokeOn=!1),null!=this.strokeWidth&&t.setLineWidth(this.strokeWidth),null!=this.lineCap&&t.setLineCap(this.lineCap),null!=this.lineJoin&&t.setLineJoin(this.lineJoin),null!=this.miterLimit&&t.setMiterLimit(this.miterLimit),null!=this.absoluteOpacity&&t.setGlobalAlpha(this.absoluteOpacity),null!=this.opacity&&t.setGlobalAlpha(t.globalAlpha*this.opacity),null!=this.compositeOperation&&t.setGlobalCompositeOperation(this.compositeOperation),null!=this.shadowColor&&t.setShadowColor(Colors.parseColorStyle(this.shadowColor,t)),null!=this.shadowBlur&&t.setShadowBlur(this.shadowBlur),null!=this.shadowOffsetX&&t.setShadowOffsetX(this.shadowOffsetX),null!=this.shadowOffsetY&&t.setShadowOffsetY(this.shadowOffsetY),null!=this.textStyle&&t.setMozTextStyle(this.textStyle)}},drawPickingPath:!1,draw:!1,createSubtreePath:function(t,e){t.save(),e||this.transform(t,!0);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].createSubtreePath(t);t.restore()},getSubtreeBoundingBox:function(t){if(t){var e=this.parent;this.parent=null,this.needMatrixUpdate=!0}for(var i=this.getAxisAlignedBoundingBox(),n=0;n<this.childNodes.length;n++){var r=this.childNodes[n].getSubtreeBoundingBox();i?r&&this.mergeBoundingBoxes(i,r):i=r}return t&&(this.parent=e,this.needMatrixUpdate=!0),i},mergeBoundingBoxes:function(t,e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]+t[0]<e[2]+e[0]&&(t[2]=e[2]+e[0]-t[0]),t[3]+t[1]<e[3]+e[1]&&(t[3]=e[3]+e[1]-t[1])},getAxisAlignedBoundingBox:function(){if(this.transform(null,!0),!this.getBoundingBox)return null;var t=this.getBoundingBox(),e=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0],t[1]),i=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0]+t[2],t[1]+t[3]),n=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0],t[1]+t[3]),r=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,t[0]+t[2],t[1]),s=Math.min(e[0],i[0],n[0],r[0]),a=Math.max(e[0],i[0],n[0],r[0]),o=Math.min(e[1],i[1],n[1],r[1]),h=Math.max(e[1],i[1],n[1],r[1]);return[s,o,a-s,h-o]}}),Canvas=Klass(CanvasNode,{clear:!0,frameLoop:!1,recording:!1,opacity:1,frame:0,elapsed:0,frameDuration:30,time:0,fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:!1,playOnlyWhenFocused:!0,isPlaying:!0,redrawOnlyWhenChanged:!1,changed:!0,drawBoundingBoxes:!1,cursor:"default",mouseDown:!1,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,initialize:function(t,e){if(arguments.length>2){var i=arguments[0],n=arguments[1],r=arguments[2],e=arguments[3],t=E.canvas(n,r),s=E("div",t,{style:{overflow:"hidden",width:n+"px",height:r+"px",position:"relative"}});this.canvasContainer=s,i&&i.appendChild(s)}CanvasNode.initialize.call(this,e),this.mouseEventStack=[],this.canvas=t,t.canvas=this,this.width=this.canvas.width,this.height=this.canvas.height;var a=this;this.frameHandler=function(){a.onFrame()},this.canvas.addEventListener("DOMNodeInserted",function(t){t.target==this&&a.addEventListeners()},!1),this.canvas.addEventListener("DOMNodeRemoved",function(t){t.target==this&&a.removeEventListeners()},!1),this.canvas.parentNode&&this.addEventListeners(),this.startTime=(new Date).getTime(),this.isPlaying&&this.play()},removeEventListeners:function(){},addEventListeners:function(){var t=this;this.canvas.parentNode.addMouseEvent=function(e){var i=Mouse.getRelativeCoords(this,e);t.absoluteMouseX=i.x,t.absoluteMouseY=i.y;var n=document.defaultView.getComputedStyle(t.canvas,""),r=parseFloat(n.getPropertyValue("width")),s=parseFloat(n.getPropertyValue("height"));t.mouseX=t.absoluteMouseX*(r/t.canvas.width),t.mouseY=t.absoluteMouseY*(s/t.canvas.height),t.addMouseEvent(t.mouseX,t.mouseY,t.mouseDown)},this.canvas.parentNode.contains=this.contains,this.canvas.parentNode.addEventListener("mousedown",function(e){t.mouseDown=!0,t.keyTarget!=t.target&&(t.keyTarget&&t.dispatchEvent({type:"blur",canvasTarget:t.keyTarget}),t.keyTarget=t.target,t.keyTarget&&t.dispatchEvent({type:"focus",canvasTarget:t.keyTarget})),this.addMouseEvent(e)},!0),this.canvas.parentNode.addEventListener("mouseup",function(e){this.addMouseEvent(e),t.mouseDown=!1},!0),this.canvas.parentNode.addEventListener("mousemove",function(e){if(this.addMouseEvent(e),null==t.prevClientX&&(t.prevClientX=e.clientX,t.prevClientY=e.clientY),t.dragTarget){var i=document.createEvent("MouseEvents");i.initMouseEvent("drag",!0,!0,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),i.canvasTarget=t.dragTarget,i.dx=e.clientX-t.prevClientX,i.dy=e.clientY-t.prevClientY,t.dispatchEvent(i)}if(t.mouseDown){if(!t.dragTarget&&t.target){t.dragTarget=t.target;var i=document.createEvent("MouseEvents");i.initMouseEvent("dragstart",!0,!0,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),i.canvasTarget=t.dragTarget,t.dispatchEvent(i)}}else if(t.dragTarget){var i=document.createEvent("MouseEvents");i.initMouseEvent("dragend",!0,!0,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),i.canvasTarget=t.dragTarget,t.dispatchEvent(i),t.dragTarget=!1}t.prevClientX=e.clientX,t.prevClientY=e.clientY},!0),this.canvas.parentNode.addEventListener("mouseout",function(e){CanvasNode.contains.call(this,e.relatedTarget)||(t.absoluteMouseX=t.absoluteMouseY=t.mouseX=t.mouseY=null)},!0);for(var e=this.dispatchEvent.bind(this),i=["mousemove","mouseover","mouseout","mousewheel","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","mousemultiwheel","textInput","focus","blur"],n=0;n<i.length;n++)this.canvas.parentNode.addEventListener(i[n],e,!1);this.keys={},this.windowEventListeners={keydown:function(e){t.keyTarget&&(t.updateKeys(e),e.canvasTarget=t.keyTarget,t.dispatchEvent(e))},keyup:function(e){t.keyTarget&&(t.updateKeys(e),e.canvasTarget=t.keyTarget,t.dispatchEvent(e))},keypress:function(e){t.keyTarget&&(e.canvasTarget=t.keyTarget,t.dispatchEvent(e))},blur:function(){t.absoluteMouseX=t.absoluteMouseY=null,t.playOnlyWhenFocused&&t.isPlaying&&(t.stop(),t.__blurStop=!0)},focus:function(){t.__blurStop&&!t.isPlaying&&t.play()},mouseup:function(e){if(t.mouseDown=!1,t.dragTarget){var i=document.createEvent("MouseEvents");i.initMouseEvent("dragend",!0,!0,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),i.canvasTarget=t.dragTarget,t.dispatchEvent(i),t.dragTarget=!1}if(!t.canvas.parentNode.contains(e.target)){var n=t.dispatchEvent(e);return t.keyTarget&&(t.dispatchEvent({type:"blur",canvasTarget:t.keyTarget}),t.keyTarget=null),n}},mousemove:function(e){return t.__blurStop&&!t.isPlaying&&t.play(),!t.canvas.parentNode.contains(e.target)&&t.mouseDown?t.dispatchEvent(e):void 0}},this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(e){e.target==this&&t.removeWindowEventListeners()},!1),this.canvas.parentNode.addEventListener("DOMNodeInserted",function(e){e.target==this&&t.addWindowEventListeners()},!1),this.canvas.parentNode.parentNode&&this.addWindowEventListeners()},updateKeys:function(t){this.keys.shift=t.shiftKey,this.keys.ctrl=t.ctrlKey,this.keys.alt=t.altKey,this.keys.meta=t.metaKey;var e="keydown"==t.type;switch(t.keyCode){case 37:this.keys.left=e;break;case 38:this.keys.up=e;break;case 39:this.keys.right=e;break;case 40:this.keys.down=e;break;case 32:this.keys.space=e;break;case 13:this.keys.enter=e;break;case 9:this.keys.tab=e;break;case 8:this.keys.backspace=e;break;case 16:this.keys.shift=e;break;case 17:this.keys.ctrl=e;break;case 18:this.keys.alt=e}this.keys[t.keyCode]=e},addWindowEventListeners:function(){for(var t in this.windowEventListeners)window.addEventListener(t,this.windowEventListeners[t],!1)},removeWindowEventListeners:function(){for(var t in this.windowEventListeners)window.removeEventListener(t,this.windowEventListeners[t],!1)},addMouseEvent:function(t,e,i){var n=this.allocMouseEvent();n[0]=t,n[1]=e,n[2]=i,this.mouseEvents.push(n)},allocMouseEvent:function(){return this.mouseEventStack.length>0?this.mouseEventStack.pop():[null,null,null]},freeMouseEvent:function(t){this.mouseEventStack.push(t),this.mouseEventStack.length>100&&this.mouseEventStack.splice(0,this.mouseEventStack.length)},clearMouseEvents:function(){for(;this.mouseEvents.length>0;)this.freeMouseEvent(this.mouseEvents.pop())},play:function(){this.stop(),this.realTime=(new Date).getTime(),this.frameLoop=setInterval(this.frameHandler,this.frameDuration),this.isPlaying=!0},stop:function(){this.__blurStop=!1,this.frameLoop&&(clearInterval(this.frameLoop),this.frameLoop=!1),this.isPlaying=!1},dispatchEvent:function(t){var e=CanvasNode.prototype.dispatchEvent.call(this,t);return t.cursor?this.canvas.style.cursor!=t.cursor&&(this.canvas.style.cursor=t.cursor):this.canvas.style.cursor!=this.cursor&&(this.canvas.style.cursor=this.cursor),e},onFrame:function(t,e){var i=this.getContext();try{var n=(new Date).getTime();this.currentRealElapsed=n-this.realTime,this.currentRealFps=1e3/this.currentRealElapsed;var r=this.frameDuration;if(this.fixedTimestep||(r=this.currentRealElapsed),this.realTime=n,null!=t?(this.time=t,e&&(r=e)):this.time+=r,this.previousTarget=this.target,this.target=null,this.catchMouse&&this.handlePick(i),this.previousTarget!=this.target){if(this.previousTarget){var s=document.createEvent("MouseEvents");s.initMouseEvent("mouseout",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.canvasTarget=this.previousTarget,this.dispatchEvent(s)}if(this.target){var s=document.createEvent("MouseEvents");s.initMouseEvent("mouseover",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.canvasTarget=this.target,this.dispatchEvent(s)}}if(this.handleUpdate(this.time,r),this.clearMouseEvents(),!this.redrawOnlyWhenChanged||this.changed){try{this.handleDraw(i)}catch(a){throw console.log(a),a}this.changed=!1}this.currentElapsed=(new Date).getTime()-this.realTime,this.elapsed+=this.currentElapsed,this.currentFps=1e3/this.currentElapsed,this.frame++,this.frame%this.fpsFrames==0&&(this.fps=1e3*this.fpsFrames/this.elapsed,this.realFps=1e3*this.fpsFrames/((new Date).getTime()-this.startTime),this.elapsed=0,this.startTime=(new Date).getTime())}catch(a){if(i)try{for(var o=0;1e3>o;o++)i.restore()}catch(h){}throw delete this.context,a}},getContext:function(){return this.recording?this.getRecordingContext():this.useMockContext?this.getMockContext():this.get2DContext()},get2DContext:function(){if(!this.context){var t=CanvasSupport.getContext(this.canvas,"2d");this.context=t}return this.context},getMockContext:function(){if(!this.fakeContext){var t=this.get2DContext();this.fakeContext={};var e=function(){return this};for(var i in t)this.fakeContext[i]="function"==typeof t[i]?e:t[i];this.fakeContext.isMockObject=!0,this.fakeContext.addColorStop=e}return this.fakeContext},getRecordingContext:function(){return this.recordingContext||(this.recordingContext=new RecordingContext),this.recordingContext},drawPickingPath:function(t){t.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(t,e){return t>=0&&t<=this.canvas.width&&e>=0&&e<=this.canvas.height},draw:function(t){t.setGlobalAlpha(this.opacity),this.clear&&(t.fillOn?(t.beginPath(),t.rect(0,0,this.canvas.width,this.canvas.height),t.fill()):t.clearRect(0,0,this.canvas.width,this.canvas.height)),t.fillStyle="black",t.strokeStyle="black",t.fillOn=!1,t.strokeOn=!1}}),LinkNode=Klass(CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(t,e,i){this.href=t,e&&(this.target=e),CanvasNode.initialize.call(this,i),this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",function(t){if(t.button!=Mouse.RIGHT){var e=this.target;!t.ctrlKey&&t.button!=Mouse.MIDDLE||"_self"!=e||(e="_blank"),window.open(this.href,e)}},!1)}}),AudioNode=Klass(CanvasNode,{ready:!1,autoPlay:!1,playing:!1,paused:!1,pan:0,volume:1,loop:!1,transformSound:!1,initialize:function(t,e){CanvasNode.initialize.call(this,e),this.filename=t,this.when("load",this._autoPlaySound),this.loadSound()},loadSound:function(){if(this.sound=CanvasSupport.getSoundObject(),this.sound){var t=this;this.sound.onready=function(){t.ready=!0,t.root.dispatchEvent({type:"ready",canvasTarget:t})},this.sound.onload=function(){t.loaded=!0,t.root.dispatchEvent({type:"load",canvasTarget:t})},this.sound.onerror=function(){t.root.dispatchEvent({type:"error",canvasTarget:t})},this.sound.onfinish=function(){t.loop?t.play():t.stop()},this.sound.load(this.filename)}},play:function(){this.playing=!0,this.needPlayUpdate=!0},stop:function(){this.playing=!1,this.needPlayUpdate=!0},pause:function(){return this.needPauseUpdate?void(this.needPauseUpdate=!1):(this.paused=!this.paused,void(this.needPauseUpdate=!0))},setVolume:function(t){this.volume=t,this.needStatusUpdate=!0},setPan:function(t){this.pan=t,this.needStatusUpdate=!0},handleUpdate:function(){if(CanvasNode.handleUpdate.apply(this,arguments),this.willBeDrawn&&(this.transform(null,!0),this.sound||this.loadSound(),this.ready)){if(this.transformSound){{var t=this.currentMatrix[4],e=(this.currentMatrix[5],this.currentMatrix[2]),i=this.currentMatrix[3],n=this.currentMatrix[0],r=this.currentMatrix[1],s=.5*this.root.width,a=Math.sqrt(e*e+i*i);Math.sqrt(n*n+r*r)}this.setVolume(a),this.setPan((t-s)/s)}this.needPauseUpdate&&(this.needPauseUpdate=!1,this._pauseSound()),this.needPlayUpdate&&(this.needPlayUpdate=!1,this.playing?this._playSound():this._stopSound()),this.needStatusUpdate&&(this._setSoundVolume(),this._setSoundPan())}},_autoPlaySound:function(){this.autoPlay&&this.play()},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){return 0==this.sound.play()?this.playing=!1:void this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop(),this.root.dispatchEvent({type:"stop",canvasTarget:this})},_pauseSound:function(){this.sound.pause(),this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}}),ElementNode=Klass(CanvasNode,{noScaling:!1,noAlpha:!1,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(t,e){CanvasNode.initialize.call(this,e),this.content=t,this.element=E("div",t),this.element.style.webkitTransformOrigin="0,0",this.element.style.position="absolute"},clone:function(){var t=CanvasNode.prototype.clone.call(this);return this.content&&this.content.cloneNode&&(t.content=this.content.cloneNode(!0)),t.element=E("div",t.content),t.element.style.position="absolute",t.element.style.webkitTransformOrigin="0,0",t},setRoot:function(t){CanvasNode.setRoot.call(this,t),this.element&&this.element.parentNode&&this.element.parentNode.removeChild&&this.element.parentNode.removeChild(this.element)},handleUpdate:function(t,e){CanvasNode.handleUpdate.call(this,t,e),this.willBeDrawn&&this.visible&&"none"!=this.display&&"hidden"!=this.visibility&&this.drawable?"none"==this.element.style.display&&(this.element.style.display="block"):"none"!=this.element.style.display&&(this.element.style.display="none")},addEventListener:function(t,e,i){var n=this,r=function(){e.apply(n,arguments)};return this.element.addEventListener(t,r,i||!1)},removeEventListener:function(t,e,i){var n=this,r=function(){e.apply(n,arguments)};return this.element.removeEventListener(t,r,i||!1)},draw:function(t){this.cursor&&this.element.style.cursor!=this.cursor&&(this.element.style.cursor=this.cursor),this.element.style.zIndex!=this.zIndex&&(this.element.style.zIndex=this.zIndex);var e=this.currentMatrix.slice(0,4).concat([0,0]);if(xo=this.xOffset,yo=this.yOffset,this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var i=this.parent.getBoundingBox();xo+=i[0],yo+=i[1]}var n=CanvasSupport.tMatrixMultiplyPoint(e,xo,yo),r=this.currentMatrix[4]+n[0],s=this.currentMatrix[5]+n[1],a=this.currentMatrix[2],o=this.currentMatrix[3],h=this.currentMatrix[0],l=this.currentMatrix[1],u=Math.sqrt(a*a+o*o),c=Math.sqrt(h*h+l*l);null!=t.fontFamily&&(this.element.style.fontFamily=t.fontFamily);var d=CanvasSupport.getSupportsWebkitTransform();if(d&&!this.noScaling){var f,p=this.element.firstChild;if(p&&p.style&&(f=p.style.marginTop),f){var g=parseFloat(f);p.style.marginTop=u*g+(f.match(/[^\d]+$/)||"")}this.element.style.webkitTransform="matrix("+e.join(",")+")"}else this.element.style.webkitTransform="";if(this.element.style.fontSize=null!=t.fontSize?this.noScaling||d?t.fontSize+"px":t.fontSize*u+"px":this.noScaling||d?"inherit":100*u+"%",this.element.style.opacity=this.noAlpha?1:t.globalAlpha,!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden",this.root.canvas.parentNode.appendChild(this.element);var v=!0}var m=this.color||this.fill;if(this.parent&&(m&&m.length||(m=this.parent.color),m&&m.length||(m=this.parent.fill)),m&&m.length||(m=t.fillStyle),"string"==typeof m?this.element.style.color=-1!=m.search(/^rgba\(/)?"rgb("+m.match(/\d+/g).slice(0,3).join(",")+")":m:m.length&&(this.element.style.color="rgb("+m.slice(0,3).map(Math.floor).join(",")+")"),i)this.element.style.width=c*i[2]+"px",this.element.style.height=u*i[3]+"px",this.eWidth=c,this.eHeight=u;else{this.element.style.width="default",this.element.style.height="default";var y=this.align||this.textAnchor;"center"==y||"middle"==y?r-=this.element.offsetWidth/2:"right"==y&&(r-=this.element.offsetWidth);var x=this.valign;"center"==x||"middle"==x?s-=this.element.offsetHeight/2:"bottom"==x&&(s-=this.element.offsetHeight),this.eWidth=this.element.offsetWidth/c,this.eHeight=this.element.offsetHeight/u}this.element.style.left=r+"px",this.element.style.top=s+"px",v&&(this.element.style.visibility="visible")}}),Drawable=Klass(CanvasNode,{pickable:!0,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(t){CanvasNode.initialize.call(this,t)},drawPickingPath:function(t){this.drawGeometry&&(t.beginPath(),this.drawGeometry(t))},isPointInPath:function(){return!1},isVisible:function(t){var e=this.getAxisAlignedBoundingBox();if(!e)return!0;var i=e[0],n=e[0]+e[2],r=e[1],s=e[1]+e[3],a=this.root.width,o=this.root.height;if(this.root.drawBoundingBoxes){t.save();var h=this.getBoundingBox();t.beginPath(),t.rect(h[0],h[1],h[2],h[3]),t.strokeStyle="green",t.lineWidth=1,t.stroke(),t.restore(),t.save(),CanvasSupport.setTransform(t,[1,0,0,1,0,0],this.currentMatrix),t.beginPath(),t.rect(i,r,n-i,s-r),t.strokeStyle="red",t.lineWidth=1.5,t.stroke(),t.restore()}var l=!(0>n||i>a||0>s||r>o);return l},createSubtreePath:function(t,e){t.save(),e||this.transform(t,!0),this.drawGeometry&&this.drawGeometry(t);for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].createSubtreePath(t);t.restore()},draw:function(t){if(this.drawGeometry){this.root.drawBoundingBoxes&&this.isVisible(t);var e=t.fillStyle.transformList||t.fillStyle.matrix||null!=t.fillStyle.scale||t.fillStyle.rotation||t.fillStyle.x||t.fillStyle.y,i=t.strokeStyle.transformList||t.strokeStyle.matrix||null!=t.strokeStyle.scale||t.strokeStyle.rotation||t.strokeStyle.x||t.strokeStyle.y;if(t.beginPath(),this.drawGeometry(t),t.strokeOn)switch(this.strokeMode){case this.ABOVE:t.fillOn&&this.doFill(t,e),this.doStroke(t,i);break;case this.BELOW:this.doStroke(t,i),t.fillOn&&this.doFill(t,e);break;case this.INSIDE:t.fillOn&&this.doFill(t,e),t.save();var n=t.lineWidth;t.setLineWidth(1),this.doStroke(t,i),t.setLineWidth(n),t.clip(),this.doStroke(t,i),t.restore()}else t.fillOn&&this.doFill(t,e);this.drawMarkers(t),this.clip&&t.clip()}},doFill:function(t,e){if(e||this.getBoundingBox&&t.fillStyle.units==this.OBJECTBOUNDINGBOX){if(t.save(),this.getBoundingBox&&t.fillStyle.units==this.OBJECTBOUNDINGBOX){var i=this.getBoundingBox(),n=i[2],r=i[3];t.translate(i[0],i[1]),t.scale(n,r)}t.fillStyle.transform(t)}if(null!=this.fillOpacity){var s=t.globalAlpha;t.setGlobalAlpha(s*this.fillOpacity),t.fill(),t.globalAlpha=s}else t.fill();e&&t.restore()},doStroke:function(t,e){if(e||this.getBoundingBox&&t.strokeStyle.units==this.OBJECTBOUNDINGBOX){if(t.save(),this.getBoundingBox&&t.strokeStyle.units==this.OBJECTBOUNDINGBOX){var i=this.getBoundingBox(),n=i[2],r=i[3];t.translate(i[0],i[1]),t.scale(n,r)}t.strokeStyle.needMatrixUpdate=!0,t.strokeStyle.transform(t),null!=n&&CanvasSupport.tScale(t.strokeStyle.currentMatrix,n,r);var s=t.strokeStyle.currentMatrix,a=Math.sqrt(Math.max(s[0]*s[0]+s[1]*s[1],s[2]*s[2]+s[3]*s[3]));t.setLineWidth((null==t.lineWidth?1:t.lineWidth)/a)}if(null!=this.strokeOpacity){var o=t.globalAlpha;t.setGlobalAlpha(o*this.strokeOpacity),t.stroke(),t.globalAlpha=o}else t.stroke();e&&t.restore()},drawMarkers:function(t){var e=this.markerStart||this.marker,i=this.markerEnd||this.marker,n=this.markerMid||this.marker;if(e&&this.getStartPoint){var r=this.getStartPoint();null!=e.orient&&"auto"!=e.orient&&(r.angle=e.orient);var s="strokeWidth"==e.markerUnits?t.lineWidth:1;t.save(),t.translate(r.point[0],r.point[1]),t.scale(s,s),t.rotate(r.angle);var a=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),r.point[0],r.point[1]),s,s),r.angle);e.__copyMatrix(a),e.handleDraw(t),t.restore()}if(i&&this.getEndPoint){var r=this.getEndPoint();null!=i.orient&&"auto"!=i.orient&&(r.angle=i.orient);var s="strokeWidth"==i.markerUnits?t.lineWidth:1;t.save(),t.translate(r.point[0],r.point[1]),t.scale(s,s),t.rotate(r.angle);var a=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),r.point[0],r.point[1]),s,s),r.angle);i.__copyMatrix(a),i.handleDraw(t),t.restore()}if(n&&this.getMidPoints)for(var o=this.getMidPoints(),s="strokeWidth"==n.markerUnits?t.lineWidth:1,h=0;h<o.length;h++){var r=o[h];t.save(),t.translate(r.point[0],r.point[1]),t.scale(s,s),null!=n.orient&&"auto"!=n.orient&&(r.angle=i.orient),t.rotate(r.angle);var a=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),r.point[0],r.point[1]),s,s),r.angle);n.__copyMatrix(a),n.handleDraw(t),t.restore()}},getStartPoint:!1,getEndPoint:!1,getMidPoints:!1,getBoundingBox:!1}),Line=Klass(Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:!0,initialize:function(t,e,i,n,r){this.x1=t,this.y1=e,this.x2=i,this.y2=n,Drawable.initialize.call(this,r)},drawGeometry:function(t){t.moveTo(this.x1,this.y1),t.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,this.y1,this.x2-this.x1,this.y2-this.y1]},getLength:function(){return Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}}),Circle=Klass(Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:2*Math.PI,clockwise:!1,closePath:!0,includeCenter:!1,initialize:function(t,e){null!=t&&(this.radius=t),Drawable.initialize.call(this,e)},drawGeometry:function(t){if(0!=this.radius&&(this.includeCenter&&t.moveTo(this.cx,this.cy),t.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise),this.closePath)){var e=Math.cos(this.endAngle),i=Math.sin(this.endAngle);t.moveTo(this.cx+e*this.radius,this.cy+i*this.radius),t.closePath()}},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,t*t+e*e<=this.radius*this.radius},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}}),Ellipse=Klass(Circle,{radiusX:0,radiusY:0,initialize:function(t,e,i){this.radiusX=t,this.radiusY=e,Circle.initialize.call(this,1,i)},drawGeometry:function(t){if(0!=this.radiusX&&0!=this.radiusY){var e=.5522847498,i=this.cx,n=this.cy,r=e*this.radiusX,s=e*this.radiusY;t.moveTo(i+this.radiusX,n),t.bezierCurveTo(i+this.radiusX,n-s,i+r,n-this.radiusY,i,n-this.radiusY),t.bezierCurveTo(i-r,n-this.radiusY,i-this.radiusX,n-s,i-this.radiusX,n),t.bezierCurveTo(i-this.radiusX,n+s,i-r,n+this.radiusY,i,n+this.radiusY),t.bezierCurveTo(i+r,n+this.radiusY,i+this.radiusX,n+s,i+this.radiusX,n)}},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,t/=this.radiusX,e/=this.radiusY,1>=t*t+e*e},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,2*this.radiusX,2*this.radiusY]}}),Spiral=Klass(Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(t){return t},initialize:function(t,e){this.endAngle=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){var e=this.cx,i=this.cy,n=this.startAngle,r=this.startRadius+this.radiusFunction(n);if(t.moveTo(e+Math.cos(n)*r,i-Math.sin(n)*r),this.startAngle<this.endAngle)for(n+=.1,r=this.startRadius+this.radiusFunction(n);n<this.endAngle;)t.lineTo(e+Math.cos(n)*r,i-Math.sin(n)*r),n+=.1,r=this.startRadius+this.radiusFunction(n);else for(n-=.1,r=this.startRadius+this.radiusFunction(n);n>this.endAngle;)t.lineTo(e+Math.cos(n)*r,i-Math.sin(n)*r),n-=.1,r=this.startRadius+this.radiusFunction(n);n=this.endAngle,r=this.startRadius+this.radiusFunction(n),t.lineTo(e+Math.cos(n)*r,i-Math.sin(n)*r)},isPointInPath:function(){return!1}}),Rectangle=Klass(Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:!1,initialize:function(t,e,i){null!=t&&(this.width=t,this.height=t),null!=e&&(this.height=e),Drawable.initialize.call(this,i)},drawGeometry:function(t){var e=this.cx,i=this.cy,n=this.width||this.x2-e,r=this.height||this.y2-i;if(0!=n&&0!=r)if(this.centered&&(e-=.5*n,i-=.5*r),this.rx||this.ry){var s=Math.min(.5*n,this.rx||this.ry),a=Math.min(.5*r,this.ry||s),o=.5522847498,h=o*s,l=o*a;t.moveTo(e+s,i),t.lineTo(e-s+n,i),t.bezierCurveTo(e-s+n+h,i,e+n,i+a-l,e+n,i+a),t.lineTo(e+n,i+r-a),t.bezierCurveTo(e+n,i+r-a+l,e-s+n+h,i+r,e-s+n,i+r),t.lineTo(e+s,i+r),t.bezierCurveTo(e+s-h,i+r,e,i+r-a+l,e,i+r-a),t.lineTo(e,i+a),t.bezierCurveTo(e,i+a-l,e+s-h,i,e+s,i),t.closePath()}else 0>n&&(e+=n),0>r&&(i+=r),t.rect(e,i,Math.abs(n),Math.abs(r))},isPointInPath:function(t,e){return t-=this.cx,e-=this.cy,this.centered&&(t+=this.width/2,e+=this.height/2),t>=0&&t<=this.width&&e>=0&&e<=this.height},getBoundingBox:function(){var t=this.cx,e=this.cy;return this.centered&&(t-=this.width/2,e-=this.height/2),[t,e,this.width,this.height]}}),Polygon=Klass(Drawable,{segments:[],closePath:!0,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){if(this.segments&&!(this.segments.length<2)){var e=this.segments;
t.moveTo(e[0],e[1]);for(var i=2;i<e.length;i+=2)t.lineTo(e[i],e[i+1]);this.closePath&&t.closePath()}},isPointInPath:function(t,e){if(!this.segments||this.segments.length<2)return!1;var i=this.getBoundingBox();return t>=i[0]&&t<=i[0]+i[2]&&e>=i[1]&&e<=i[1]+i[3]},getStartPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var t=0;return this.segments.length>2&&(t=Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4))),{point:this.segments.slice(0,2),angle:t}},getEndPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var t=0;return this.segments.length>2&&(t=Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2))),{point:this.segments.slice(-2),angle:t}},getMidPoints:function(){if(!this.segments||this.segments.length<2)return[];for(var t=this.segments,e=[],i=2;i<t.length-2;i+=2){var n=t.slice(i-2,i),r=t.slice(i,i+2),s=t.slice(i+2,i+4),a=.5*(Curves.lineAngle(n,r)+Curves.lineAngle(r,s));e.push({point:r,angle:a})}return e},getBoundingBox:function(){for(var t=1/0,e=1/0,i=-1/0,n=-1/0,r=this.segments,s=0;s<r.length;s+=2){var a=r[s],o=r[s+1];t>a&&(t=a),a>i&&(i=a),e>o&&(e=o),o>n&&(n=o)}return[t,e,i-t,n-e]}}),CatmullRomSpline=Klass(Drawable,{segments:[],loop:!1,closePath:!1,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){var e=this.currentMatrix[0],i=this.currentMatrix[1],n=this.currentMatrix[2],r=this.currentMatrix[3],s=e*e+i*i,a=n*n+r*r,o=Math.floor(Math.sqrt(Math.max(s,a))),h=this.compiled;h&&h.scale==o||(h=this.compile(o));for(var l=0;l<h.length;l++){var u=h[l];t[u[0]].apply(t,u[1])}this.closePath&&t.closePath()},compile:function(t){t||(t=1);var e=[];if(this.segments&&this.segments.length>=(this.loop?1:4)){var i=this.segments;this.loop&&(i=i.slice(0),i.unshift(i[i.length-1]),i.push(i[1]),i.push(i[2]));var n,r,s,a,o,h,l=1/(15*(t+.5));e.push(["moveTo",i[1].slice(0)]),o=i[1];for(var u=1;u<i.length-2;u++){n=i[u-1],r=i[u],s=i[u+1],a=i[u+2];for(var c=0;1>c;c+=l)h=o,o=Curves.catmullRomPoint(n,r,s,a,c),e.push(["lineTo",o])}o=Curves.catmullRomPoint(n,r,s,a,1),e.push(["lineTo",o])}return e.scale=t,this.compiled=e,e},getBoundingBox:function(){for(var t=1/0,e=1/0,i=-1/0,n=-1/0,r=this.compiled?this.compiled:this.compile(),s=0;s<r.length;s++)for(var a=r[s][1],o=0;o<a.length;o+=2){var h=a[o],l=a[o+1];t>h&&(t=h),h>i&&(i=h),e>l&&(e=l),l>n&&(n=l)}return[t,e,i-t,n-e]},pointAt:function(t){if(!this.segments)return[0,0];if(this.segments.length>=(this.loop?1:4)){var e=this.segments;this.loop&&(e=e.slice(0),e.unshift(e[e.length-1]),e.push(e[1]),e.push(e[2]));var i=t*(e.length-3),n=Math.floor(i),r=i-n,s=e[n],a=e[n+1],o=e[n+2],h=e[n+3];return Curves.catmullRomPoint(s,a,o,h,r)}return this.segments[0]},pointAngleAt:function(t){if(!this.segments)return{point:[0,0],angle:0};if(this.segments.length>=(this.loop?1:4)){var e=this.segments;this.loop&&(e=e.slice(0),e.unshift(e[e.length-1]),e.push(e[1]),e.push(e[2]));var i=t*(e.length-3),n=Math.floor(i),r=i-n,s=e[n],a=e[n+1],o=e[n+2],h=e[n+3];return Curves.catmullRomPointAngle(s,a,o,h,r)}return{point:this.segments[0]||[0,0],angle:0}}}),Path=Klass(Drawable,{segments:[],closePath:!1,initialize:function(t,e){this.segments=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){for(var e=this.getSegments(),i=0;i<e.length;i++){var n=e[i];t[n[0]].apply(t,n[1])}this.closePath&&t.closePath()},isPointInPath:function(t,e){var i=this.getBoundingBox();return t>=i[0]&&t<=i[0]+i[2]&&e>=i[1]&&e<=i[1]+i[3]},getBoundingBox:function(){if(!this.compiled||!this.compiledBoundingBox){for(var t=1/0,e=1/0,i=-1/0,n=-1/0,r=this.getSegments(),s=0;s<r.length;s++)for(var a=r[s][1],o=0;o<a.length;o+=2){var h=a[o],l=a[o+1];t>h&&(t=h),h>i&&(i=h),e>l&&(e=l),l>n&&(n=l)}this.compiledBoundingBox=[t,e,i-t,n-e]}return this.compiledBoundingBox},getStartPoint:function(){var t=this.getSegments();if(!t||!t[0])return{point:[0,0],angle:0};var e=t[0],i=e[1],n=[i[i.length-2],i[i.length-1]],r=t[1],s=0;return r&&(c2=r[1],s=Curves.lineAngle(n,[c2[c2.length-2],c2[c2.length-1]])),{point:n,angle:s}},getEndPoint:function(){var t=this.getSegments();if(!t||!t[0])return{point:[0,0],angle:0};var e=t[t.length-1],i=e[1],n=[i[i.length-2],i[i.length-1]],r=t[t.length-2],s=0;return r&&(c2=r[1],s=Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],n)),{point:n,angle:s}},getMidPoints:function(){var t=this.getSegments();if(this.vertices)return this.vertices.slice(1,-1);for(var e=[],i=1;i<t.length-1;i++){var n=t[i-1][1].slice(-2),r=t[i][1].slice(0,2);if(t[i-1].length>2)var s=t[i-1][1].slice(-4,-2),a=.5*(Curves.lineAngle(s,n)+Curves.lineAngle(n,r));else var a=Curves.lineAngle(n,r);e.push({point:n,angle:a});var o=t[i][2];if(null!=o){for(i++;t[i]&&t[i][2]==o;)i++;i--}}return e},getSegments:function(){return"string"==typeof this.segments?this.compiled&&this.segments==this.compiledSegments||(this.compiled=this.compileSVGPath(this.segments),this.compiledSegments=this.segments):this.compiled||(this.compiled=Object.clone(this.segments)),this.compiled},compileSVGPath:function(t){for(var e,i,n,r=t.split(/(?=[a-z])/i),s=0,a=0,o=[],h=0;h<r.length;h++){var l=r[h],u=l.match(/[a-z]/i)[0],c=l.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi);switch(c&&(c=c.map(parseFloat)),u){case"M":s=c[0],a=c[1],e=i=null,o.push(["moveTo",[s,a]]);break;case"m":s+=c[0],a+=c[1],e=i=null,o.push(["moveTo",[s,a]]);break;case"L":s=c[0],a=c[1],e=i=null,o.push(["lineTo",[s,a]]);break;case"l":s+=c[0],a+=c[1],e=i=null,o.push(["lineTo",[s,a]]);break;case"H":s=c[0],e=i=null,o.push(["lineTo",[s,a]]);break;case"h":s+=c[0],e=i=null,o.push(["lineTo",[s,a]]);break;case"V":a=c[0],e=i=null,o.push(["lineTo",[s,a]]);break;case"v":a+=c[0],e=i=null,o.push(["lineTo",[s,a]]);break;case"C":s=c[4],a=c[5],e=c[2],i=c[3],o.push(["bezierCurveTo",c]);break;case"c":o.push(["bezierCurveTo",[c[0]+s,c[1]+a,c[2]+s,c[3]+a,c[4]+s,c[5]+a]]),e=s+c[2],i=a+c[3],s+=c[4],a+=c[5];break;case"S":null!=e&&n.match(/[sc]/i)||(e=s,i=a),o.push(["bezierCurveTo",[s-(e-s),a-(i-a),c[0],c[1],c[2],c[3]]]),e=c[0],i=c[1],s=c[2],a=c[3];break;case"s":null!=e&&n.match(/[sc]/i)||(e=s,i=a),o.push(["bezierCurveTo",[s-(e-s),a-(i-a),s+c[0],a+c[1],s+c[2],a+c[3]]]),e=s+c[0],i=a+c[1],s+=c[2],a+=c[3];break;case"Q":e=c[0],i=c[1],s=c[2],a=c[3],o.push(["quadraticCurveTo",c]);break;case"q":o.push(["quadraticCurveTo",[c[0]+s,c[1]+a,c[2]+s,c[3]+a]]),e=s+c[0],i=a+c[1],s+=c[2],a+=c[3];break;case"T":null!=e&&n.match(/[qt]/i)?(e=s-(e-s),i=a-(i-a)):(e=s,i=a),o.push(["quadraticCurveTo",[e,i,c[0],c[1]]]),e=s-(e-s),i=a-(i-a),s=c[0],a=c[1];break;case"t":null!=e&&n.match(/[qt]/i)?(e=s-(e-s),i=a-(i-a)):(e=s,i=a),o.push(["quadraticCurveTo",[e,i,s+c[0],a+c[1]]]),s+=c[0],a+=c[1];break;case"A":for(var d=this.solveArc(s,a,c),f=0;f<d.length;f++)d[f][2]=h;o.push.apply(o,d),s=c[5],a=c[6];break;case"a":c[5]+=s,c[6]+=a;for(var d=this.solveArc(s,a,c),f=0;f<d.length;f++)d[f][2]=h;o.push.apply(o,d),s=c[5],a=c[6];break;case"Z":o.push(["closePath",[]]);break;case"z":o.push(["closePath",[]])}n=u}return o},solveArc:function(t,e,i){for(var n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],h=i[5],l=i[6],u=this.arcToSegments(h,l,n,r,a,o,s,t,e),c=[],d=0;d<u.length;d++)c.push(["bezierCurveTo",this.segmentToBezier.apply(this,u[d])]);return c},arcToSegments:function(t,e,i,n,r,s,a,o,h){var l=a*(Math.PI/180),u=Math.sin(l),c=Math.cos(l);i=Math.abs(i),n=Math.abs(n);var d=c*(o-t)*.5+u*(h-e)*.5,f=c*(h-e)*.5-u*(o-t)*.5,p=d*d/(i*i)+f*f/(n*n);p>1&&(p=Math.sqrt(p),i*=p,n*=p);var g=c/i,v=u/i,m=-u/n,y=c/n,x=g*o+v*h,b=m*o+y*h,M=g*t+v*e,w=m*t+y*e,S=(M-x)*(M-x)+(w-b)*(w-b),k=1/S-.25;0>k&&(k=0);var P=Math.sqrt(k);s==r&&(P=-P);var T=.5*(x+M)-P*(w-b),A=.5*(b+w)+P*(M-x),C=Math.atan2(b-A,x-T),E=Math.atan2(w-A,M-T),_=E-C;0>_&&1==s?_+=2*Math.PI:_>0&&0==s&&(_-=2*Math.PI);for(var O=Math.ceil(Math.abs(_/(.5*Math.PI+.001))),N=[],L=0;O>L;L++){var I=C+L*_/O,B=C+(L+1)*_/O;N[L]=[T,A,I,B,i,n,u,c]}return N},segmentToBezier:function(t,e,i,n,r,s,a,o){var h=o*r,l=-a*s,u=a*r,c=o*s,d=.5*(n-i),f=8/3*Math.sin(.5*d)*Math.sin(.5*d)/Math.sin(d),p=t+Math.cos(i)-f*Math.sin(i),g=e+Math.sin(i)+f*Math.cos(i),v=t+Math.cos(n),m=e+Math.sin(n),y=v+f*Math.sin(n),x=m-f*Math.cos(n);return[h*p+l*g,u*p+c*g,h*y+l*x,u*y+c*x,h*v+l*m,u*v+c*m]},getLength:function(){var t=this.getSegments();if(null==t.arcLength){t.arcLength=0;for(var e=0,i=0,n=0;n<t.length;n++){var r=t[n][1];if(!(r.length<2)){switch(t[n][0]){case"bezierCurveTo":t[n][3]=Curves.cubicLength([e,i],[r[0],r[1]],[r[2],r[3]],[r[4],r[5]]);break;case"quadraticCurveTo":t[n][3]=Curves.quadraticLength([e,i],[r[0],r[1]],[r[2],r[3]]);break;case"lineTo":t[n][3]=Curves.lineLength([e,i],[r[0],r[1]])}t[n][3]&&(t.arcLength+=t[n][3]),e=r[r.length-2],i=r[r.length-1]}}}return t.arcLength},pointAngleAt:function(t,e){for(var i=[],n=this.getSegments(),r=this.getLength(),s=0,a=0,o=0;o<n.length;o++){var h=n[o];h[1].length<2||("moveTo"!=h[0]&&i.push([s,a,h]),s=h[1][h[1].length-2],a=h[1][h[1].length-1])}if(i.length<1)return{point:[s,a],angle:0};if(t>=1)var l=1,h=i[i.length-1];else if(e&&e.discrete)var u=Math.floor(t*i.length),h=i[u],l=0;else if(e&&e.linear)var u=t*i.length,l=u-Math.floor(u),h=i[Math.floor(u)];else{for(var u,l,c=t*r,d=0,o=0;o<i.length;o++){if(d+i[o][2][3]>c){u=o,l=(c-d)/i[o][2][3];break}d+=i[o][2][3]}var h=i[u]}var f=0,p=h[2][0],g=h[2][1];switch(p){case"bezierCurveTo":return Curves.cubicLengthPointAngle([h[0],h[1]],[g[0],g[1]],[g[2],g[3]],[g[4],g[5]],l);case"quadraticCurveTo":return Curves.quadraticLengthPointAngle([h[0],h[1]],[g[0],g[1]],[g[2],g[3]],l);case"lineTo":s=Curves.linearValue(h[0],g[0],l),a=Curves.linearValue(h[1],g[1],l),f=Curves.lineAngle([h[0],h[1]],[g[0],g[1]],l)}return{point:[s,a],angle:f}}}),ImageNode=Klass(Drawable,{centered:!1,usePattern:!1,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(t,e){this.image=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){if(Object.isImageLoaded(this.image)){var e=null==this.dWidth?this.image.width:this.dWidth,i=null==this.dHeight?this.image.height:this.dHeight,n=this.dX+(this.centered?.5*-e:0),r=this.dY+(this.centered?.5*-i:0);if(null!=this.dWidth)null!=this.sWidth?t.drawImage(this.image,this.sX,this.sY,this.sWidth,this.sHeight,n,r,e,i):t.drawImage(this.image,n,r,e,i);else if(e=this.image.width,i=this.image.height,this.usePattern){this.imagePattern||(this.imagePattern=new Pattern(this.image,"repeat"));var s=this.imagePattern.compiled;s||(s=this.imagePattern.compile(t)),t.save(),t.beginPath(),t.rect(n,r,e,i),t.setFillStyle(s),t.fill(),t.restore(),t.beginPath()}else t.drawImage(this.image,n,r)}else{var e=this.dWidth,i=this.dHeight;if(!e||!i)return;var n=this.dX+(this.centered?.5*-e:0),r=this.dY+(this.centered?.5*-i:0)}t.rect(n,r,e,i)},drawPickingPath:function(t){var e=this.dX+(this.centered?.5*-this.image.width:0),i=this.dY+(this.centered?.5*-this.image.height:0),n=this.dWidth,r=this.dHeight;null==this.dWidth&&(n=this.image.width,r=this.image.height),t.rect(e,i,n,r)},isPointInPath:function(t,e){t-=this.dX,e-=this.dY,this.centered&&(t+=.5*this.image.width,e+=.5*this.image.height);var i=this.dWidth,n=this.dHeight;return null==this.dWidth&&(i=this.image.width,n=this.image.height),t>=0&&i>=t&&e>=0&&n>=e},getBoundingBox:function(){x=this.dX,y=this.dY,this.centered&&(x-=.5*this.image.width,y-=.5*this.image.height);var t=this.dWidth,e=this.dHeight;return null==this.dWidth&&(t=this.image.width,e=this.image.height),[x,y,t,e]}}),TextNode=Klass(Drawable,{text:"Text",asPath:!1,align:"left",accuratePicking:!1,pathGeometry:null,width:0,height:20,cx:0,cy:0,__drawMethodName:"draw"+CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+CanvasSupport.getTextBackend(),initialize:function(t,e){this.lastText=this.text,this.text=t,Drawable.initialize.call(this,e)},drawGeometry:function(t){this.drawUsing(t,this.__drawMethodName)},drawPickingPath:function(t){this.drawUsing(t,this.__pickingMethodName)},drawUsing:function(t,e){this.text&&0!=this.text.length&&((this.lastText!=this.text||this.lastStyle!=t.textStyle)&&(this.dimensions=this.measureText(t),this.lastText=this.text,this.lastStyle=t.textStyle),this[e]&&this[e](t))},measureText:function(t){var e="measureText"+CanvasSupport.getTextBackend().capitalize();return this[e]?this[e](t):{width:0,height:0}},computeXForAlign:function(){return"left"==this.align?0:"right"==this.align?-this.dimensions.width:"center"==this.align?.5*-this.dimensions.width:void 0},measureTextMozText:function(t){return{width:t.mozMeasureText(this.text),height:20}},drawMozText:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;this.pathGeometry?(this.pathGeometry.draw(t),t.mozDrawTextAlongPath(this.text,this.path)):(t.save(),t.translate(e,i),this.asPath?t.mozPathText(this.text):t.mozDrawText(this.text),t.restore())},drawPickingPathMozText:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;if(this.pathGeometry)this.pathGeometry.draw(t);else if(this.accuratePicking)t.save(),t.translate(e,i),t.mozPathText(this.text),t.restore();else{var n=15,r=i-n;t.rect(e,r,this.dimensions.width,this.dimensions.height)}},drawDrawString:function(t){var e=this.cx+this.computeXForAlign(),i=this.cy+0;t.drawString(e,i,this.text)},measureTextPerfectWorld:function(t){return t.measureText(this.text)},drawPerfectWorld:function(t){this.pathGeometry?(this.pathGeometry.draw(t),this.asPath?t.pathTextAlongPath(this.text):t.drawTextAlongPath(this.text)):this.asPath?t.pathText(this.text):t.drawText(this.text)},drawPickingPathPerfectWorld:function(t){this.accuratePicking?this.pathGeometry?t.pathTextAlongPath(this.text):t.pathText(this.text):this.pathGeometry?t.textRectAlongPath(this.text):t.textRect(this.text)}}),Gradient=Klass({type:"linear",isPattern:!0,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(t){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]],t&&Object.extend(this,t)},compile:function(t){if("linear"==this.type)var e=t.createLinearGradient(this.startX,this.startY,this.endX,this.endY);else var e=t.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius);for(var i=0;i<this.colorStops.length;i++){var n=this.colorStops[i];if("string"==typeof n[1])e.addColorStop(n[0],n[1]);else{var r=n[1],s=3==r.length?1:r[3],a="rgba("+r.slice(0,3).join(",")+", "+s+")";e.addColorStop(n[0],a)}}return Object.extend(e,Transformable.prototype),e.transformList=this.transformList,e.scale=this.scale,e.x=this.x,e.y=this.y,e.matrix=this.matrix,e.rotation=this.rotation,e.units=this.units,e.isMockObject||(this.compiled=e),e}}),Pattern=Klass({isPattern:!0,repeat:"repeat",initialize:function(t,e){this.image=t,e&&(this.repeat=e)},compile:function(t){var e=t.createPattern(this.image,this.repeat);return Object.extend(e,Transformable.prototype),e.transformList=this.transformList,e.scale=this.scale,e.x=this.x,e.y=this.y,e.matrix=this.matrix,e.rotation=this.rotation,e.units=this.units,e.isMockObject||(this.compiled=e),e}}),SVGParser={load:function(t,e){if(!e.onSuccess)throw"Need to provide an onSuccess function.";e.filename||(e.filename=t);var i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");i.open("GET",t,!0),i.overrideMimeType("text/xml");var n=!1;i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status||0==i.status){try{var r=i.responseXML,s=SVGParser.parse(r,e);s.svgRootElement=r}catch(a){return void(e.onFailure&&e.onFailure(i,a,t,e))}e.onSuccess(s,i,t,e)}else e.onFailure&&!n&&e.onFailure(i,null,t,e);else 3==i.readyState&&e.onLoading&&e.onLoading(i,t,e)};try{i.send(null)}catch(r){e.onFailure&&(e.onFailure(i,r,t,e),n=!0),i.abort()}},parse:function(t,e){var i=new CanvasNode,n=e.width,r=e.height,s=e.fontSize;i.innerWidth=n||window.innerWidth,i.innerHeight=r||window.innerHeight,i.innerSize=Math.sqrt(n*n+r*r)/Math.sqrt(2),i.fontSize=s||12,i.filename=e.filename||".";var a={},o={ids:{},classes:{},tags:{}};return i.color=e.currentColor||"black",this.parseChildren(t,i,a,o),i.defs=a,i.style=o,i},parsePreserveAspectRatio:function(t,e,i,n,r){var t=t||"",s=t.split(/\s+/),a="defer"==s[0];a&&s.shift();var o=s[0]||"xMidYMid",h=s[1]||"meet",l=e/n,u=i/r,c={x:0,y:0,w:l,h:u};if("none"==o)return c;c.w=c.h=("meet"==h?Math.min:Math.max)(l,u);var d=o.slice(1,4).toLowerCase(),f=o.slice(5,8).toLowerCase(),p=this.SVGAlignMap[d]||0,g=this.SVGAlignMap[f]||0;return c.x=p*(e-n*c.w),c.y=g*(i-r*c.h),c},SVGAlignMap:{min:0,mid:.5,max:1},SVGTagMapping:{svg:function(t,e){var i=new Rectangle;i.width=0,i.height=0,i.doFill=function(){},i.doStroke=function(){},i.drawMarkers=function(){},i.fill="black",i.stroke="none";var n=t.getAttribute("viewBox"),r=t.getAttribute("width"),s=t.getAttribute("height");if(r?s||(s=r):r=s,r)var a=this.parseUnit(r,e,"x"),o=this.parseUnit(s,e,"y");if(n){xywh=n.match(/[-+]?\d+/g).map(parseFloat),i.cx=xywh[0],i.cy=xywh[1],i.width=xywh[2],i.height=xywh[3];var h=e.innerWidth=i.width,l=e.innerHeight=i.height;e.innerSize=Math.sqrt(h*h+l*l)/Math.sqrt(2),"visible"!=t.getAttribute("overflow")&&(i.clip=!0)}if(r){if(n){var u=t.getAttribute("preserveAspectRatio"),c=this.parsePreserveAspectRatio(u,a,o,i.width,i.height);i.cx-=c.x/c.w,i.cy-=c.y/c.h,i.width=a/c.w,i.height=o/c.h,i.x+=c.x,i.y+=c.y,i.scale=[c.w,c.h]}e.docWidth=a,e.docHeight=o}return i},marker:function(t,e){var i=new CanvasNode;i.draw=function(t){"hidden"!=this.overflow&&this.viewBox||(t.beginPath(),t.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]),t.clip())};var n=-this.parseUnit(t.getAttribute("refX"),e,"x")||0,r=-this.parseUnit(t.getAttribute("refY"),e,"y")||0;if(i.transformList=[["translate",[n,r]]],i.markerUnits=t.getAttribute("markerUnits")||"strokeWidth",i.markerWidth=this.parseUnit(t.getAttribute("markerWidth"),e,"x")||3,i.markerHeight=this.parseUnit(t.getAttribute("markerHeight"),e,"y")||3,i.overflow=t.getAttribute("overflow")||"hidden",i.viewBox=t.getAttribute("viewBox"),i.orient=t.getAttribute("orient")||0,i.orient&&"auto"!=i.orient&&(i.orient=parseFloat(i.orient)*SVGMapping.DEG_TO_RAD_FACTOR),i.viewBox){i.viewBox=i.viewBox.strip().split(/[\s,]+/g).map(parseFloat);var s=i.viewBox[2]-i.viewBox[0],a=i.viewBox[3]-i.viewBox[1];if(i.markerWidth){var o=sy=Math.min(i.markerWidth/s,i.markerHeight/a);i.transformList.unshift(["scale",[o,sy]])}}return i},clipPath:function(t){var e=new CanvasNode;return e.units=t.getAttribute("clipPathUnits"),e},title:function(t,e){e.root.title=t.textContent},desc:function(t,e){e.root.description=t.textContent},metadata:function(t,e){e.root.metadata=t},parseAnimateTag:function(t,e){var i=SVGParser.SVGTagMapping.parseTime(t.getAttribute("begin")),n=SVGParser.SVGTagMapping.parseTime(t.getAttribute("dur")),r=SVGParser.SVGTagMapping.parseTime(t.getAttribute("end"));null==n&&(n=r-i),n=isNaN(n)?0:n;var s=t.getAttribute("attributeName"),a=t.getAttribute("fill");"rect"==e.tagName&&("x"==s&&(s="cx"),"y"==s&&(s="cy"));var o="sum"==t.getAttribute("accumulate"),h=t.getAttribute("additive");h=h?"sum"==h:o;var l=t.getAttribute("repeatCount");if(l="indefinite"==l?!0:parseFloat(l),!l&&n>0){var u=t.getAttribute("repeatDur");l="indefinite"==u?!0:SVGParser.SVGTagMapping.parseTime(u)/n}return{after:isNaN(i)?0:i,duration:n,restart:t.getAttribute("restart"),calcMode:t.getAttribute("calcMode"),additive:h,accumulate:o,repeat:l,variable:s,fill:a}},parseTime:function(t){if(!t)return null;if(t.match(/[0-9]$/)){var e=t.split(":"),i=e[e.length-1]||0,n=e[e.length-2]||0,r=e[e.length-3]||0;return 1e3*(3600*parseFloat(r)+60*parseFloat(n)+parseFloat(i))}var s=60;return t.match(/s$/i)?s=1:t.match(/h$/i)&&(s=3600),parseFloat(t)*s*1e3},animate:function(t,e){var i=this.parseUnit(t.getAttribute("from"),e,"x"),n=this.parseUnit(t.getAttribute("to"),e,"x"),r=this.parseUnit(t.getAttribute("by"),e,"x"),s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);if(t.getAttribute("values")){var a=this,o=t.getAttribute("values");o=o.split(";").map(function(t){var i=t.split(/[, ]+/);return i.length>2?i.map(function(t){return a.parseUnit(t,e,"x")}):i.length>1?[a.parseUnit(i[0],e,"x"),a.parseUnit(i[1],e,"y")]:a.parseUnit(t,e,"x")})}else null==n&&(n=i+r);e.after(s.after,function(){if("remove"==s.fill){var t=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=t})}if(o){if(s.additive){var e=this[s.variable];o=o.map(function(t){return Object.sum(t,e)})}var a=0,h=[];if(o[0]instanceof Array)for(var l=1;l<o.length;l++){var u=Object.sub(o[l]-o[l-1]),c=Math.sqrt(u.reduce(function(t,e){return t+e*e},0));h.push(c),a+=c}else for(var l=1;l<o.length;l++){var c=Math.abs(o[l]-o[l-1]);h.push(c),a+=c}var d=function(t){if(1==t)this[s.variable]=o[o.length-1];else{if("paced"==s.calcMode){for(var e,i,n=t*a,r=0,l=0;l<h.length;l++){if(r+h[l]>n){e=l,i=(n-r)/h[l];break}r+=h[l]}var u=e,c=u+1}else var e=t*(o.length-1),u=Math.floor(e),i=e-u,c=u+1;this.tweenVariable(s.variable,o[u],o[c],i,s.calcMode)}};this.animate(d,i,n,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}else null==i&&(i=this[s.variable],null!=r&&(n=i+r)),s.additive&&(i=Object.sum(i,this[s.variable]),n=Object.sum(n,this[s.variable])),this.animate(s.variable,i,n,s.duration,s.calcMode,{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})})},set:function(t,e){var i=t.getAttribute("to"),n=SVGParser.SVGTagMapping.parseAnimateTag(t,e);e.after(n.after,function(){if("remove"==n.fill){var t=Object.clone(this[n.variable]);this.after(n.duration,function(){this[n.variable]=t})}this[n.variable]=i})},animateMotion:function(t,e){var i;if(t.getAttribute("path"))i=new Path(t.getAttribute("path"));else if(t.getAttribute("values")){var n=t.getAttribute("values");i=new Path("M"+n.split(";").join("L"))}else if(t.getAttribute("from")||t.getAttribute("to")||t.getAttribute("by")){var r=t.getAttribute("from"),s=t.getAttribute("to"),a=t.getAttribute("by");r||(r="0,0"),s=s?"L"+s:"l"+a,i=new Path("M"+r+s)}var o=new CanvasNode;o.__motionPath=i;var h=t.getAttribute("rotate"),l=SVGParser.SVGTagMapping.parseAnimateTag(t,e);return e.after(l.after,function(){if("remove"==l.fill){var t=this.x,e=this.y;this.after(l.duration,function(){this.x=t,this.y=e})}var i=function(t){var e=o.__motionPath.pointAngleAt(t,{discrete:"discrete"==l.calcMode,linear:"linear"==l.calcMode});this.x=e.point[0],this.y=e.point[1],"auto"==h?this.rotation=e.angle:"auto-reverse"==h&&(this.rotation=e.angle+Math.PI)};this.animate(i,0,1,l.duration,"linear",{repeat:l.repeat,additive:l.additive,accumulate:l.accumulate})}),o},mpath:function(t,e,i){var n=t.getAttribute("xlink:href");n=n.replace(/^#/,""),this.getDef(i,n,function(t){e.__motionPath=t})},animateColor:function(t,e,i){var n=t.getAttribute("from"),r=t.getAttribute("to");n=SVGParser.SVGMapping.__parseStyle(n,null,i),r=SVGParser.SVGMapping.__parseStyle(r,null,i);var s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);e.after(s.after,function(){if("remove"==s.fill){var t=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=t})}this.animate(s.variable,n,r,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})})},animateTransform:function(t,e){var i=t.getAttribute("from"),n=t.getAttribute("to"),r=t.getAttribute("by"),s=SVGParser.SVGTagMapping.parseAnimateTag(t,e);i&&(i=i.split(/[ ,]+/).map(parseFloat)),n&&(n=n.split(/[ ,]+/).map(parseFloat)),r&&(r=r.split(/[ ,]+/).map(parseFloat)),s.variable=t.getAttribute("type"),"rotate"==s.variable?(s.variable="rotation",i&&(i=i.map(function(t){return t*Math.PI/180})),n&&(n=n.map(function(t){return t*Math.PI/180})),r&&(r=r.map(function(t){return t*Math.PI/180}))):s.variable.match(/^skew/)&&(i&&(i=i.map(function(t){return t*Math.PI/180})),n&&(n=n.map(function(t){return t*Math.PI/180})),r&&(r=r.map(function(t){return t*Math.PI/180}))),null==n&&(n=Object.sum(i,r)),e.after(s.after,function(){if("translate"==s.variable){if(null==i&&(i=[this.x,this.y],null!=r&&(n=Object.sum(i,r))),"remove"==s.fill){var t=this.x,e=this.y;this.after(s.duration,function(){this.x=t,this.y=e})}this.animate("x",i[0],n[0],s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate}),null!=i[1]&&this.animate("y",i[1],n[1],s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}else{if(i&&1==i.length&&(i=i[0]),n&&1==n.length&&(n=n[0]),r&&1==r.length&&(r=r[0]),null==i&&(i=this[s.variable],null!=r&&(n=Object.sum(i,r))),"scale"==s.variable&&s.additive&&(s.additive=!1),"remove"==s.fill){var a=Object.clone(this[s.variable]);this.after(s.duration,function(){this[s.variable]=a})}this.animate(s.variable,i,n,s.duration,"linear",{repeat:s.repeat,additive:s.additive,accumulate:s.accumulate})}})},a:function(t){var e=t.getAttribute("xlink:href")||t.getAttribute("href"),i=t.getAttribute("target"),n=new LinkNode(e,i);return n},use:function(t,e,i){var n=t.getAttribute("xlink:href")||t.getAttribute("href"),r=new CanvasNode;return n&&(n=n.replace(/^#/,""),this.getDef(i,n,function(t){var e=t.clone(),i=r.parent;i?(r.stroke&&(e.stroke=r.stroke),r.fill&&(e.fill=r.fill),r.append(e)):r=e})),r},image:function(t,e){var i=t.getAttribute("xlink:href")||t.getAttribute("href");i&&0!=i.search(/^[a-z]+:/i)&&(i=e.root.filename.split("/").slice(0,-1).join("/")+"/"+i);var n=new ImageNode(i?Object.loadImage(i):null);return n.fill="none",n.dX=this.parseUnit(t.getAttribute("x"),e,"x")||0,n.dY=this.parseUnit(t.getAttribute("y"),e,"y")||0,n.srcWidth=this.parseUnit(t.getAttribute("width"),e,"x"),n.srcHeight=this.parseUnit(t.getAttribute("height"),e,"y"),n},path:function(t){return new Path(t.getAttribute("d"))},polygon:function(t){return new Polygon(t.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},polyline:function(t){return new Polygon(t.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:!1})},rect:function(t,e){var i=new Rectangle(this.parseUnit(t.getAttribute("width"),e,"x"),this.parseUnit(t.getAttribute("height"),e,"y"));return i.cx=this.parseUnit(t.getAttribute("x"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("y"),e,"y")||0,i.rx=this.parseUnit(t.getAttribute("rx"),e,"x")||0,i.ry=this.parseUnit(t.getAttribute("ry"),e,"y")||0,i},line:function(t,e){var i=this.parseUnit(t.getAttribute("x1"),e,"x")||0,n=this.parseUnit(t.getAttribute("y1"),e,"y")||0,r=this.parseUnit(t.getAttribute("x2"),e,"x")||0,s=this.parseUnit(t.getAttribute("y2"),e,"y")||0,a=new Line(i,n,r,s);return a},circle:function(t,e){var i=new Circle(this.parseUnit(t.getAttribute("r"),e)||0);return i.cx=this.parseUnit(t.getAttribute("cx"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("cy"),e,"y")||0,i},ellipse:function(t,e){var i=new Ellipse(this.parseUnit(t.getAttribute("rx"),e,"x")||0,this.parseUnit(t.getAttribute("ry"),e,"y")||0);return i.cx=this.parseUnit(t.getAttribute("cx"),e,"x")||0,i.cy=this.parseUnit(t.getAttribute("cy"),e,"y")||0,i},text:function(t,e){var i,n=E("div",t.textContent.strip());n.style.marginTop="-1em",n.style.whiteSpace="nowrap";var i=new ElementNode(n);return i.xOffset=this.parseUnit(t.getAttribute("x"),e,"x")||0,i.yOffset=this.parseUnit(t.getAttribute("y"),e,"y")||0,i},style:function(t,e,i,n){this.parseStyle(t,n)},defs:function(){return new CanvasNode({visible:!1})},linearGradient:function(t,e,i,n){var r=new Gradient({type:"linear"});r.color=e.color,t.getAttribute("color")&&SVGParser.SVGMapping.color(r,t.getAttribute("color"),i,n),r.svgNode=t;var s=t.getAttribute("x1"),a=t.getAttribute("y1"),o=t.getAttribute("x2"),h=t.getAttribute("y2"),l=t.getAttribute("gradientTransform");return r.units=t.getAttribute("gradientUnits")||"objectBoundingBox",s&&(r.startX=parseFloat(s)*("%"==s.charAt(s.length-1)?.01:1)),a&&(r.startY=parseFloat(a)*("%"==a.charAt(a.length-1)?.01:1)),o&&(r.endX=parseFloat(o)*("%"==o.charAt(o.length-1)?.01:1)),h&&(r.endY=parseFloat(h)*("%"==h.charAt(h.length-1)?.01:1)),l&&this.applySVGTransform(r,l,i,n),this.parseStops(r,t,i,n),r},radialGradient:function(t,e,i,n){var r=new Gradient({type:"radial"});r.color=e.color,t.getAttribute("color")&&SVGParser.SVGMapping.color(r,t.getAttribute("color"),i,n),r.svgNode=t;var s=t.getAttribute("r"),a=t.getAttribute("fx"),o=t.getAttribute("fy"),h=t.getAttribute("cx"),l=t.getAttribute("cy"),u=t.getAttribute("gradientTransform");return r.units=t.getAttribute("gradientUnits")||"objectBoundingBox",s&&(r.endRadius=parseFloat(s)*("%"==s.charAt(s.length-1)?.01:1)),a&&(r.startX=parseFloat(a)*("%"==a.charAt(a.length-1)?.01:1)),o&&(r.startY=parseFloat(o)*("%"==o.charAt(o.length-1)?.01:1)),h&&(r.endX=parseFloat(h)*("%"==h.charAt(h.length-1)?.01:1)),l&&(r.endY=parseFloat(l)*("%"==l.charAt(l.length-1)?.01:1)),u&&this.applySVGTransform(r,u,i,n),this.parseStops(r,t,i,n),r}},parseChildren:function(t,e,i,n){for(var r=e,s=0;s<t.childNodes.length;s++){var a=t.childNodes[s],o=!1;if(a.childNodes){if(a.tagName&&(o=this.SVGTagMapping[a.tagName]?this.SVGTagMapping[a.tagName].call(this,a,e,i,n):new CanvasNode)){if(o.root=e.root,o.fontSize=r.fontSize,o.strokeWidth=r.strokeWidth,a.attributes)for(var h=0;h<a.attributes.length;h++){var l=a.attributes[h];this.SVGMapping[l.nodeName]&&this.SVGMapping[l.nodeName](o,l.nodeValue,i,n)}o.id&&this.setDef(i,o.id,o),o.tagName=a.tagName,this.applySVGTransform(o,a.getAttribute("transform"),i,n),this.applySVGStyle(o,a.getAttribute("style"),i,n),o.tagName&&n.tags[o.tagName]&&this.applySVGStyle(o,n.tags[o.tagName],i,n),o.className&&n.classes[o.className]&&this.applySVGStyle(o,n.classes[o.className],i,n),o.id&&n.ids[o.id]&&this.applySVGStyle(o,n.ids[o.id],i,n),o.marker||(o.marker=r.marker),o.markerStart||(o.markerStart=r.markerStart),o.markerEnd||(o.markerEnd=r.markerEnd),o.markerMid||(o.markerMid=r.markerMid)}o&&o.setRoot&&(o.zIndex=s,e.append(o),this.parseChildren(a,o,i,n))}}},parseStyle:function(t,e){for(var i=t.textContent,n=i.split(/\}/m),r=0;r<n.length;r++){var s=n[r],a=s.split(/\{/m);if(!(a.length<2)){var o=a[0].strip(),h=a[1].strip();switch(o.charAt(0)){case".":e.classes[o.slice(1)]=h;break;case"#":e.ids[o.slice(1)]=h;break;default:e.tags[o]=h}}}},parseStops:function(t,e,i,n){var r=e.getAttribute("xlink:href");t.colorStops=[],r&&(r=r.replace(/^#/,""),this.getDef(i,r,function(e){0==t.colorStops.length&&(t.colorStops=e.colorStops)}));for(var s=[],a=0;a<e.childNodes.length;a++){var o=e.childNodes[a];if("stop"==o.tagName){var h=parseFloat(o.getAttribute("offset"));-1!=o.getAttribute("offset").search(/%/)&&(h*=.01);var l=[h];l.color=t.color;for(var u=0;u<o.attributes.length;u++){var c=o.attributes[u];this.SVGMapping[c.nodeName]&&this.SVGMapping[c.nodeName](l,c.nodeValue,i,n)}this.applySVGStyle(l,o.getAttribute("style"),i,n);var d=o.getAttribute("id");d&&this.setDef(i,d,l),s.push(l)}}s.length>0&&(t.colorStops=s)},applySVGTransform:function(t,e,i,n){if(e){t.transformList=[];for(var r=e.match(/[a-z]+\s*\([^)]*\)/gi),s=0;s<r.length;s++){var a=r[s].split("("),o=a[0].strip();if(this.SVGMapping[o]){var h=a[1].strip().slice(0,-1);this.SVGMapping[o](t,h,i,n)}}this.breakDownTransformList(t)}},breakDownTransformList:function(t){var e=t.transformList;if(1==t.transformList.length){var i=e[0];if("translate"==i[0])t.x=i[1][0],t.y=i[1][1];else if("scale"==i[0])t.scale=i[1];else if("rotate"==i[0])t.rotation=i[1];else if("matrix"==i[0])t.matrix=i[1];else if("skewX"==i[0])t.skewX=i[1][0];else{if("skewY"!=i[0])return;t.skewY=i[1][0]}t.transformList=null}},applySVGStyle:function(t,e,i,n){if(e)for(var r=e.split(";"),s=0;s<r.length;s++){var a=r[s].split(":"),o=a[0].strip();if(this.SVGMapping[o]){var h=a[1].strip();this.SVGMapping[o](t,h,i,n)}}},getDef:function(t,e,i){t[e]&&t[e]instanceof Array?t[e].push(i):t[e]?i(t[e]):t[e]=[i]},setDef:function(t,e,i){if(t[e]&&t[e]instanceof Array)for(var n=0;n<t[e].length;n++)t[e][n](i);t[e]=i},parseUnit:function(t,e,i){return null==t?null:this.parseUnitMultiplier(t,e,i)*parseFloat(t.strip())},parseUnitMultiplier:function(t,e,i){var n=this.getCmInPixels();return-1!=t.search(/cm$/i)?n:-1!=t.search(/mm$/i)?.1*n:-1!=t.search(/pt$/i)?.0352777778*n:-1!=t.search(/pc$/i)?.4233333333*n:-1!=t.search(/in$/i)?2.54*n:-1!=t.search(/em$/i)?e.fontSize:-1!=t.search(/ex$/i)?e.fontSize/2:-1!=t.search(/%$/i)?"x"==i?.01*e.root.innerWidth:"y"==i?.01*e.root.innerHeight:.01*e.root.innerSize:1},getCmInPixels:function(){if(!this.cmInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});
document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.cmInPixels=e||38}return this.cmInPixels},getEmInPixels:function(){if(!this.emInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.emInPixels=e||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var t=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});document.body.appendChild(t);var e=t.offsetWidth;document.body.removeChild(t),this.exInPixels=e||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(t,e,i){return SVGParser.parseUnit(t,e,i)},"class":function(t,e){t.className=e},marker:function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(e){t.marker=e})},"marker-start":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(e){t.markerStart=e})},"marker-end":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(e){t.markerEnd=e})},"marker-mid":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(e){t.markerMid=e})},"clip-path":function(t,e,i){SVGParser.getDef(i,e.replace(/^url\(#|\)$/g,""),function(e){t.clipPath=e})},id:function(t,e){t.id=e},translate:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat);t.transformList.push(["translate",[i[0],i[1]||0]])},rotate:function(t,e){if("auto"!=e&&"auto-reverse"!=e){var i=e.split(/[\s,]+/).map(parseFloat),n=i[0]*this.DEG_TO_RAD_FACTOR;t.transformList.push(i.length>1?["rotate",[n,i[1],i[2]||0]]:["rotate",[n]])}},scale:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat),n=["scale"];n[1]=i.length>1?[i[0],i[1]]:[i[0],i[0]],t.transformList.push(n)},matrix:function(t,e){var i=e.split(/[\s,]+/).map(parseFloat);t.transformList.push(["matrix",i])},skewX:function(t,e){var i=parseFloat(e)*this.DEG_TO_RAD_FACTOR;t.transformList.push(["skewX",[i]])},skewY:function(t,e){var i=parseFloat(e)*this.DEG_TO_RAD_FACTOR;t.transformList.push(["skewY",[i]])},opacity:function(t,e){t.opacity=parseFloat(e)},display:function(t,e){t.display=e},visibility:function(t,e){t.visibility=e},"stroke-miterlimit":function(t,e){t.miterLimit=parseFloat(e)},"stroke-linecap":function(t,e){t.lineCap=e},"stroke-linejoin":function(t,e){t.lineJoin=e},"stroke-width":function(t,e){t.strokeWidth=this.parseUnit(e,t)},fill:function(t,e,i){t.fill=this.__parseStyle(e,t.fill,i,t.color)},stroke:function(t,e,i){t.stroke=this.__parseStyle(e,t.stroke,i,t.color)},color:function(t,e,i){"inherit"!=e&&(t.color=this.__parseStyle(e,!1,i,t.color))},"stop-color":function(t,e,i){t[1]="none"==e?[0,0,0,0]:this.__parseStyle(e,t[1],i,t.color)},"fill-opacity":function(t,e){t.fillOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stroke-opacity":function(t,e){t.strokeOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stop-opacity":function(t,e){t[1]=t[1]||[0,0,0],t[1][3]=Math.min(1,Math.max(0,parseFloat(e)))},"text-anchor":function(t,e){t.textAnchor=e,t.setAlign&&t.setAlign("middle"==e?"center":e)},"font-family":function(t,e){t.fontFamily=e},"font-size":function(t,e){t.fontSize=this.parseUnit(e,t)},__parseStyle:function(t,e,i,n){if("#"==t.charAt(0)){4==t.length&&(t=t.replace(/([^#])/g,"$1$1"));var r=t.slice(1).match(/../g).map(function(t){return parseInt(t,16)});return r}if(-1!=t.search(/^rgb\(/)){for(var r=t.slice(4,-1).split(","),s=0;s<r.length;s++){var a=r[s].strip();r[s]="%"==a.charAt(a.length-1)?Math.round(2.55*parseFloat(a.slice(0,-1))):parseInt(a)}return r}if(-1!=t.search(/^rgba\(/)){for(var r=t.slice(5,-1).split(","),s=0;3>s;s++){var a=r[s].strip();r[s]="%"==a.charAt(a.length-1)?Math.round(2.55*parseFloat(a.slice(0,-1))):parseInt(a)}var a=r[3].strip();return r[3]="%"==a.charAt(a.length-1)?Math.round(.01*parseFloat(a.slice(0,-1))):Math.max(0,Math.min(1,parseFloat(a))),r}if(-1!=t.search(/^url\(/)){var o=t.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,"");return i[o]?i[o]:"rgba(255,0,255,1)"}return"currentColor"==t?n:"none"==t?"none":"freeze"==t?null:"remove"==t?null:t}}};