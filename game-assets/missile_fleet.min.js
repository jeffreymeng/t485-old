DEFAULT_CURSOR="default",MOVE_TO_CURSOR="url(moveto.png) 9 9, move",TARGET_CURSOR="crosshair",SELECT_CURSOR="pointer",M={rotation:function(t){return CanvasSupport.tRotationMatrix(t)},scaling:function(t,e){return CanvasSupport.tScalingMatrix(t,e)},translation:function(t,e){return CanvasSupport.tTranslationMatrix(t,e)}},V={rotate:function(t,e){return V.multiply(t,M.rotation(e))},add:function(t,e){return[e[0]+t[0],e[1]+t[1]]},multiply:function(t,e){return CanvasSupport.tMatrixMultiplyPoint(e,t[0],t[1])}},Player=function(){this.target=Player.targets[this.id];var t=this;if(Player.useTargettingAI&&(!Player.targets[this.id]||this.target.health<=0)&&(!this.target||this.target.health<=0||Math.random()<.3&&this.distanceTo(this.target)>this.weapon.range)&&(this.target=this.enemies.sort(function(e,i){return Math.abs(t.weapon.optimalRange-t.distanceTo(e))-Math.abs(t.weapon.optimalRange-t.distanceTo(i))})[0]),this.movementMode||(this.movementMode=this.weapon instanceof Railgun?"defensive":"normal"),Player.useMovementAI&&"manual"!=this.movementMode&&!this.waypoint&&this.target&&this.target.health>0){var e=this.angleTo(this.target),i=this.distanceTo(this.target),s=i<this.weapon.range,a=i<this.weapon.optimalRange,n=this.target.weapon&&i<this.target.weapon.range;"defensive"==this.movementMode||"aggressive"!=this.movementMode&&Player.targets[this.id]!=this.target||(this.turnToward(e),s&&this.turnToward(e+Math.PI/6),a&&this.turnToward(e+Math.PI),this.moveAt(1)),s&&!n&&(this.turnToward(e+Math.PI),this.moveAt(1))}},Player.useMovementAI=!0,Player.useTargettingAI=!0,Player.targets={},Player.selection=[],Player.toggleSelect=function(t){-1==this.selection.indexOf(t.id)?this.select(t):this.deselect(t)},Player.clearSelection=function(){for(this.selection.dict;this.selection.length>0;)this.deselect(this.selection.dict[this.selection[0]])},Player.select=function(t){this.selection.dict||(this.selection.dict={}),this.selection.formation||(this.selection.formation=new Formation),t.root.dispatchEvent({type:"select",canvasTarget:t}),this.selection.dict[t.id]=t,this.selection.formation.addShip(t),this.selection.push(t.id)},Player.deselect=function(t){this.selection.dict||(this.selection.dict={}),this.selection.formation||(this.selection.formation=new Formation),t.root.dispatchEvent({type:"deselect",canvasTarget:t}),delete this.selection.dict[t.id],this.selection.formation.removeShip(t),this.selection.deleteFirst(t.id)},Player.setWaypoint=function(t){this.selection.formation||(this.selection.formation=new Formation);var e=this.getSelectionCenter(),i=Curves.lineAngle(e,t);this.selection.formation.setWaypoint(t,i)},Player.getSelectionCenter=function(){for(var t=0,e=0,i=0;i<this.selection.length;i++){var s=this.selection.dict[this.selection[i]];t+=s.x,e+=s.y}return[t/this.selection.length,e/this.selection.length]},Player.setTarget=function(t){this.selection.forEach(function(e){Player.useMovementAI&&delete Player.selection.dict[e].waypoint,Player.targets[e]=t})},FleetAI=function(t){if(FleetAI.targetByThreat){if(FleetAI.previousTime!=t){FleetAI.previousTime=t;var e=this.enemies.sort(function(t,e){return FleetAI.threatRating(e)-FleetAI.threatRating(t)});if(e.length>0){var i={},s={};FleetAI.updateEstimates(t),e.forEach(function(t){i[t.id]=FleetAI.damageEstimates[t.id]||0,s[t.id]=[]});for(var a=0;a<this.friends.length;a++){var n=this.friends[a],h=e.find(function(t){return(FleetAI.useDamageEstimates?i[t.id]<t.health:t.health>0)&&n.weapon.range>=n.distanceTo(t)});h?(s[h.id].push(n),i[h.id]=(FleetAI.damageEstimates[h.id]||0)+FleetAI.estimateDamage(h,s[h.id])):h=e[0],n.target=h}for(var a in s)s[a].length>0&&FleetAI.estimateTimeouts.push([t+2e3,a,i[a]]);FleetAI.damageEstimates=i}}}else if(!this.target||this.target.health<=0||Math.random()<.3&&this.distanceTo(this.target)>this.weapon.range){var n=this;this.target=this.enemies.sort(function(t,e){return Math.abs(n.weapon.optimalRange-n.distanceTo(t))-Math.abs(n.weapon.optimalRange-n.distanceTo(e))})[0]}if(!this.waypoint&&this.target&&this.target.health>0){var o=this.angleTo(this.target),r=this.distanceTo(this.target),l=r<this.weapon.range,p=r<this.weapon.optimalRange,c=this.target.weapon&&r<this.target.weapon.range;this.turnToward(o),l&&this.turnToward(o+Math.PI/6),p&&this.turnToward(o+Math.PI),this.moveAt(1),l&&!c&&(this.turnToward(o+Math.PI*(FleetAI.runAway?1:.5)),this.moveAt(1))}},FleetAI.runAway=!1,FleetAI.targetByThreat=!0,FleetAI.useDamageEstimates=!0,FleetAI.damageEstimates={},FleetAI.estimateTimeouts=[],FleetAI.threatRating=function(t){var e=t.weapon.damage*t.weapon.salvos*t.weapon.range/t.weapon.reloadTime;if(t.target&&t.target.health>0){var i=t.distanceTo(t.target),s=t.weapon.range-i;e*=s>=0?1e3:1e3/Math.max(1,10*(-s/t.weapon.range))}return e},FleetAI.updateEstimates=function(t){for(;FleetAI.estimateTimeouts.length>0&&FleetAI.estimateTimeouts[0][0]<=t;){var e=FleetAI.estimateTimeouts.shift();FleetAI.damageEstimates[e[1]]&&(FleetAI.damageEstimates[e[1]]-=FleetAI.damageEstimates[e[2]])}},FleetAI.estimateDamage=function(t,e){var i=1.5*t.pointDefense.salvos,s=t.pointDefense.damage,a=!1;return e.reduce(function(e,n){var h=i;if(i-=n.weapon.freeSalvos*Math.max(1,n.weapon.projectileHealth/s),0>=i){if(a)var o=n.weapon.freeSalvos;else{a=!0;var o=n.weapon.freeSalvos-h*Math.floor(s/n.weapon.projectileHealth)}return e+n.weapon.damage*o}if(n.weapon.movementSpeed>t.pointDefense.movementSpeed){var r=t.pointDefense.hitRadius>=5,l=s>=n.weapon.projectileHealth;r&&l||(e+=n.weapon.damage)}return e},0)},Formation=Klass({initialize:function(){this.ships=[];for(var t=0;t<arguments.length;t++)this.ships.push(arguments[t])},addShip:function(t){-1==this.ships.indexOf(t)&&this.ships.push(t)},removeShip:function(t){this.ships.deleteFirst(t)},formationFunction:function(t){return t.map(function(t,e){return[-70*(e/3),70*(e%3)]})},setWaypoint:function(t,e){for(var i=this.formationFunction(this.ships),s=0;s<i.length;s++){var a=i[s],n=this.ships[s],h=V.add(t,V.rotate(a,e));n.waypoint={x:h[0],y:h[1],rotation:e}}}}),Explosion=Klass(CanvasNode,{catchMouse:!1,cursor:"default",circleGradient:new Gradient({type:"radial",endRadius:15,colorStops:[[0,"rgba(190,105,90,1)"],[.25,"rgba(5,30,80,0.4)"],[1,"rgba(10,0,40,0)"]]}),initialize:function(t){CanvasNode.initialize.call(this);var e=new Circle(15);e.fill=this.circleGradient,e.compositeOperation="lighter",this.zIndex=10,this.main=e,this.append(e),this.size=t,this.addFrameListener(this.blowup),this.after(500,this.removeSelf)},blowup:function(t){null==this.startTime&&(this.startTime=t);var e=Math.min(500,t-this.startTime),i=.00192*Math.PI;this.main.scale=1+this.size*(Explosion.fastExplosions?1:Math.tan(e*i))}}),ControlledNode=Klass(CanvasNode,{rotation:0,targetAngle:0,catchMouse:!1,turningSpeed:1,movementSpeed:20,moveSpeedFactor:0,frame:0,id:0,initialize:function(){this.id=ControlledNode.id++,CanvasNode.initialize.apply(this,arguments),this.addFrameListener(this.callAI),this.addFrameListener(this.updatePosition),this.addFrameListener(this.updateHealth)},callAI:function(t,e){this.frame%10==0&&(0==this.frame&&(this.frame+=Math.floor(10*Math.random())),this.moveSpeedFactor=0,this.targetAngle=this.rotation,this.ai(t,e)),this.hitDetect(t,e),this.frame++},ai:function(){},hitDetect:function(){},predictAngleToTarget:function(t){var e=Math.cos(this.target.rotation),i=Math.sin(this.target.rotation),s=this.target.movementSpeed*this.target.moveSpeedFactor,a=[e*s,i*s],n=this.target.x-this.x,h=this.target.y-this.y,o=n*n+h*h,r=2*n*a[0]+2*h*a[1],l=a[0]*a[0]+a[1]*a[1]-t*t,p=r*r-4*o*l;if(0>p)return this.angleTo(this.target);var c=2*o/(-r+Math.sqrt(p)),d=[this.target.x+a[0]*c,this.target.y+a[1]*c];return Math.atan2(d[1]-this.y,d[0]-this.x)},turnToward:function(t){this.targetAngle=t},moveAt:function(t){this.moveSpeedFactor=Math.min(1,Math.max(-1,t))},updateHealth:function(){this.healthBar&&(this.healthBar.width=Math.max(0,parseInt(this.health/2.5)),this.healthBar.opacity=this.opacity,this.healthBar.x=this.x,this.healthBar.y=this.y)},updatePosition:function(t,e){var i=Curves.angularDistance(this.rotation,this.targetAngle);i=i>0?Math.min(i,this.turningSpeed*(e/1e3)):Math.max(i,-this.turningSpeed*(e/1e3)),this.rotation+=i;var s=Math.cos(this.rotation),a=Math.sin(this.rotation);this.x+=s*this.movementSpeed*this.moveSpeedFactor*(e/1e3),this.y+=a*this.movementSpeed*this.moveSpeedFactor*(e/1e3)}}),Ship=Klass(ControlledNode,{isShip:!0,target:null,health:100,catchMouse:!0,turningSpeed:1,movementSpeed:40,z:0,initialize:function(t,e,i,s,a,n,h){ControlledNode.initialize.call(this),this.zIndex=0+.001*(Ship.z++%1e3),this.stroke=t,this.team=t,this.weapon=e,this.weapon.ship=this,this.pointDefense=i,this.pointDefense.ship=this,this.x=s,this.y=a,h&&(this.health=h),this.rotation=Math.random()*Math.PI*2,this.model=new Polygon([20,0,-10,15,-10,-15]),this.model.strokeWidth=2,this.hardpoint=this.model.clone(),Object.extend(this.hardpoint,{scale:.2+.1*this.weapon.techLevel,centered:!0,stroke:!1,fill:this.weapon.color}),this.append(this.weapon),this.append(this.pointDefense),this.model.append(this.hardpoint),this.append(this.model),this.healthBar=new Rectangle(20,2,{fill:t,stroke:!1,centered:!0,cy:30}),this.selected=new Circle(35,{opacity:0}),this.targetMarker=new Rectangle(40,40,{rotation:Math.PI/4,centered:!0,stroke:this.stroke,visible:!1,opacity:.5,catchMouse:!1}),this.targetLine=new Line(0,0,0,0,{stroke:this.stroke,visible:!1,opacity:.5,catchMouse:!1}),this.waypointLine=new Line(0,0,0,0,{stroke:"#448866",visible:!1,opacity:.5,catchMouse:!1}),this.append(this.selected),this.maxHealth||(this.maxHealth=this.health),this.addEventListener("mousedown",function(t){this.strategicAI==Player?(t.shiftKey||Player.clearSelection(),Player.toggleSelect(this)):Player.setTarget(this)},!1),this.addEventListener("select",function(){this.selected.opacity=.5,this.waypointLine.opacity=.5,this.targetLine.opacity=.5},!1),this.addEventListener("deselect",function(){this.selected.opacity=0,this.waypointLine.opacity=.15,this.targetLine.opacity=.1},!1),n||this.warpIn()},warpIn:function(){this.opacity=0,this.aiDisabled=!0,this.warpModel=new Spiral(0,{stroke:"blue",zIndex:-1}),this.warpModel.animateTo("endAngle",40,500,"square"),this.warpModel.after(500,function(){this.animateTo("endAngle",0,500,"square"),this.after(500,this.removeSelf)}),this.animateTo("opacity",1,1e3,"sine"),this.model.animate("rotation",-10,0,1e3,"sqrt"),this.after(1e3,function(){this.aiDisabled=!1})},tacticalAI:function(){if(!this.aiDisabled){var t=this.parentNode.childNodes,e=this,i=[];if(this.pointDefense.readyToFire){var s=t.filter(function(t){return t.isMissile}),a=s.filter(function(t){return t.target.team==e.team}).sort(function(t,i){return e.pointDefense.optimalRange-Math.abs(e.distanceTo(t)-e.distanceTo(i))}),n=a.filter(function(t){return t.target==e}).sort(function(t,i){return Math.abs(e.pointDefense.optimalRange-e.distanceTo(t))-Math.abs(e.pointDefense.optimalRange-e.distanceTo(i))}),i=n.concat(a).concat(this.enemies).filter(function(t){return(!t.target||t.target.health>0)&&(t.isMissile?e.distanceTo(t)<e.pointDefense.range:e.distanceTo(t)<e.pointDefense.optimalRange)});this.intercept(i)}var h=this.target||i[0];if(h&&h.health>0){var o=this.distanceTo(h);o<this.weapon.range&&this.weapon.readyToFire&&Math.random()<.7&&this.fireAt(h)}this.waypoint&&(this.distanceTo(this.waypoint)<5?(this.moveAt(0),Math.abs(Curves.angularDistance(this.rotation,this.waypoint.rotation))<.1?delete this.waypoint:this.turnToward(this.waypoint.rotation)):(this.turnToward(this.angleTo(this.waypoint)),this.moveAt(this.distanceTo(this.waypoint)/this.movementSpeed)))}},strategicAI:function(){if(!this.aiDisabled){var t=this;if((!this.target||this.target.health<=0||Math.random()<.3&&this.distanceTo(this.target)>this.weapon.range)&&(this.target=this.enemies.sort(function(e,i){return Math.abs(t.weapon.optimalRange-t.distanceTo(e))-Math.abs(t.weapon.optimalRange-t.distanceTo(i))})[0]),this.target&&this.target.health>0){var e=this.angleTo(this.target),i=this.distanceTo(this.target);i<this.weapon.range?this.turnToward(e+Math.PI/6):i>this.weapon.optimalRange?this.turnToward(e):Math.random()<.8&&this.turnToward(e+Math.PI/2),i<this.weapon.optimalRange&&this.turnToward(e+.85*Math.PI),this.moveAt(1)}}},hitDetect:function(){ControlledNode.hitDetect.apply(this,arguments),this.health<=0?(Player.deselect(this),this.selected.opacity=0,this.targetLine.removeSelf(),this.targetMarker.removeSelf(),this.waypointLine.removeSelf(),this.healthBar.removeSelf()):(this.healthBar.parent!=this.parent&&this.parent.append(this.healthBar),this.cursor=this.strategicAI==Player?SELECT_CURSOR:Player.selection.length>0?TARGET_CURSOR:DEFAULT_CURSOR,this.healthBar.cursor=this.cursor,this.target&&this.target.health>0&&(this.strategicAI==Player||this.target.strategicAI==Player)?(this.targetMarker.parent||this.parent.append(this.targetMarker,this.targetLine),this.targetLine.x1=this.x,this.targetLine.y1=this.y,this.targetLine.x2=this.targetMarker.x=this.target.x,this.targetLine.y2=this.targetMarker.y=this.target.y,this.targetLine.visible=Player.targets[this.id]==this.target&&!this.waypoint,this.targetMarker.visible=!0):this.targetLine.visible=this.targetMarker.visible=!1,this.waypoint&&this.strategicAI==Player?(this.waypointLine.parent||this.parent.append(this.waypointLine),this.waypointLine.x1=this.x,this.waypointLine.y1=this.y,this.waypointLine.x2=this.waypoint.x,this.waypointLine.y2=this.waypoint.y,this.waypointLine.visible=!0):this.waypointLine.visible=!1)},ai:function(t,e){if((this.x<-50||this.y<-50||this.x>this.parent.width+50||this.y>this.parent.height+50)&&(this.health-=3),this.health>0){var i=this.parentNode.childNodes,s=this;this.enemies=i.filter(function(t){return t.isShip&&t.team!=s.team}),this.friends=i.filter(function(t){return t.isShip&&t.team==s.team}),this.strategicAI(t,e),this.tacticalAI(t,e)}else if(!this.blowup){var a=this.maxHealth/20*(1+.1*this.weapon.techLevel),n=new Explosion(.25*a+Math.random());n.x=this.x,n.y=this.y,this.parent.append(n);for(var h=.2*a+Math.random()*a,o=(Math.sqrt(a/5),0);h>o;o++)this.parent.after(200+60*o*Math.random(),function(t){return function(){var e=new Explosion(Math.random()*a/5),i=Math.random();i*=i,i+=t/h,i*=Math.random()<.5?-1:1,e.x=n.x+5*i*a;var i=Math.random();i*=i,i+=t/h,i*=Math.random()<.5?-1:1,e.y=n.y+5*i*a,this.append(e)}}(o));this.root.dispatchEvent({type:"destroyed",canvasTarget:this}),this.removeSelf(),this.blowup=!0}},intercept:function(t){if(0!=t.length)for(var e=0,i=0;this.pointDefense.readyToFire;)if(this.pointDefense.fireAt(t[e]),e=(e+1)%t.length,0==e&&i++,1==i)return},shotsFired:0,fireAt:function(t){for(var e=0;e<this.weapon.salvos;e++)this.weapon.readyToFire&&(this.weapon.fireAt(t),this.shotsFired++)}}),Projectile=Klass(ControlledNode,{zIndex:2,catchMouse:!1,initialize:function(t,e,i,s,a){this.targetingFunction=this.angleTo,Object.extend(this,e),ControlledNode.initialize.call(this),this.elapsed=0,this.target=t,this.x=i,this.y=s,this.rotation=a,this.model=new Rectangle(this.movementSpeed/16,this.height,{centered:!0}),this.append(this.model),this.fill=this.color,this.projectileHealth&&(this.health=this.projectileHealth),this.maxHealth=this.health,this.initAI()},selfDestruct:function(){if(this.parent){var t=new Explosion(.01*this.maxHealth);return t.x=this.x,t.y=this.y,this.parent.append(t),this.removeSelf(),!1}},ai:function(){if(this.target){var t=this.targetingFunction(this.target);this.turnToward(t),this.moveAt(1)}},hitDetect:function(t,e){if(this.elapsed+=e,this.target){var i=this.distanceTo(this.target);return i<this.hitRadius&&this.hit(),this.health<=0?this.selfDestruct():!0}},hit:function(){this.target.health-=this.damage,this.health-=this.hitDamageToSelf;var t=new Explosion(.01*this.damage);t.x=this.x,t.y=this.y,this.parent&&this.parent.append(t)}}),Weapon=Klass(CanvasNode,{catchMouse:!1,movementSpeed:100,turningSpeed:1,health:20,projectileHealth:1,hitDamageToSelf:1,range:200,optimalRange:100,reloadTime:1e3,salvos:5,techLevel:0,rotation:0,shotsFired:0,height:2,color:"white",x:0,y:0,rotation:0,projectile:Projectile,readyToFire:!0,initialize:function(t){CanvasNode.initialize.call(this),this.freeSalvos=this.salvos,t&&(this.techLevel=t)},fireAt:function(t){if(this.freeSalvos<1)return!1;this.freeSalvos--,this.rx=this.x+this.ship.x,this.ry=this.y+this.ship.y,this.rrot=this.rotation+this.ship.rotation,this.shotsFired++;var e=this.createProjectile(t);this.ship.parent.append(e),this.after(this.reloadTime,this.reload),this.readyToFire=this.freeSalvos>0},reload:function(){this.freeSalvos++,this.readyToFire=this.freeSalvos>0},createProjectile:function(t){return new this.projectile(t,this,this.rx,this.ry,this.rrot)}}),RapidFireRailgun=Klass(Weapon,{isMissile:!0,movementSpeed:500,turningSpeed:0,projectileHealth:1,hitRadius:10,damage:100,range:500,optimalRange:250,reloadTime:200,salvos:1,color:"#5533ff",height:2,damageType:"kinetic",initialize:function(){Weapon.initialize.apply(this,arguments),this.reloadTime*=Math.pow(.8,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.hitRadius*=Math.pow(1.1,this.techLevel),this.range*=Math.pow(1.1,this.techLevel)},initAI:function(){this.rotation=this.predictAngleToTarget(this.movementSpeed),this.after(1e3,this.removeSelf);var t=new CanvasNode({stroke:"#ba88ba",x:this.x,y:this.y,rotation:this.rotation}),e=40+10*Math.random();t.append(new Circle(5,{x:e,scale:[.2,1]})),t.animate("opacity",.7,0,300,"sqrt"),t.childNodes[0].animateTo("x",e-.01*this.movementSpeed,300,"sqrt"),t.childNodes[0].animateToFactor("scale",1+this.movementSpeed*(.004+.003*Math.random()),300,"sqrt"),t.after(300,t.removeSelf),this.afterFrame(1,function(){this.parentNode&&this.parentNode.append(t)})},ai:function(){this.moveAt(1)},hit:function(){if(Projectile.hit.apply(this,arguments),this.parent){var t=this.movementSpeed*this.moveSpeedFactor*(.5+.5*Math.random()),e=new CanvasNode({x:this.x,y:this.y,rotation:this.rotation});e.after(300,e.removeSelf),this.parent.append(e);var i=new Circle(6,{x:30,scale:[.2,1],strokeWidth:5,fill:"none",stroke:"#ba88ba"});1>=t&&(t=1),i.animateTo("x",30+.04*t,.4*t,"sqrt"),i.animateToFactor("radius",2+.005*t*Math.random()*2,.3*t,"sqrt"),i.animate("opacity",1,0,.4*t,"sqrt"),e.append(i)}}}),Missiles=Klass(Weapon,{isMissile:!0,movementSpeed:160,turningSpeed:3,projectileHealth:1,hitRadius:10,damage:20,range:500,optimalRange:250,reloadTime:1e3,salvos:3,color:"#22ccff",height:1.5,damageType:"explosive",initialize:function(){Weapon.initialize.apply(this,arguments),this.techLevel>=5&&(this.salvos+=2,this.freeSalvos=this.salvos),this.reloadTime*=Math.pow(.7,this.techLevel),this.turningSpeed*=Math.pow(1.1,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.damage*=Math.pow(1.25,this.techLevel)},initAI:function(){this.model.width*=2,this.rotation+=Math.PI*(.5+this.shotsFired%2),this.x+=4*Math.cos(this.rotation)*(this.shotsFired%8),this.y+=4*Math.sin(this.rotation)*(this.shotsFired%8),this.techLevel>=4&&(this.targetingFunction=this.predictAngleTo),this.after(5e3,this.removeSelf)},predictAngleTo:function(){return this.predictAngleToTarget(this.movementSpeed)},hitDetect:function(t,e){if(this.target){if(!Projectile.hitDetect.apply(this,arguments))return!1;this.movementSpeed+=.06*e;var i=this.distanceTo(this.target);if(75>i){if(this.techLevel>=3){var s=this.targetingFunction(this.target);this.turnToward(s)}}else 150>i&&this.techLevel>=3&&(this.targetAngle+=.4*(Math.random()-.5)*Math.max(1,i)*.01)}},hit:function(){if(Projectile.hit.apply(this,arguments),!Explosion.fastExplosions&&this.parent){var t=new Circle(4*Math.random()+.18*this.damage,{rotation:this.rotation,x:this.x,y:this.y,strokeWidth:1.5,scale:[1,1],stroke:"#da88fa"});t.animate("opacity",.8,0,400,"sqrt"),t.animateTo("scale",[1,7],400,"sqrt"),t.after(400,t.removeSelf),this.parent.append(t)}}}),Beam=Klass(Weapon,{movementSpeed:200,turningSpeed:6,health:1,range:200,optimalRange:50,reloadTime:500,hitRadius:6,damage:15,salvos:3,color:"#cc44ff",sdTime:1250,height:1,isMissile:!0,damageType:"electric",initialize:function(){Weapon.initialize.apply(this,arguments),this.techLevel>=5&&(this.salvos+=2,this.freeSalvos=this.salvos),this.range*=Math.pow(1.1,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel),this.reloadTime*=Math.pow(.9,this.techLevel),this.damage*=Math.pow(1.1,this.techLevel),this.techLevel>=1&&(this.turningSpeed*=1.5),this.techLevel>=2&&(this.hitRadius*=1.5),this.techLevel>=3&&(this.range*=1.25),this.techLevel>=4&&(this.damage*=1.5,this.turningSpeed*=1.5)},initAI:function(){this.after(this.sdTime,this.removeSelf),this.rotation=this.techLevel>=3?this.predictAngleToTarget(this.movementSpeed):this.angleTo(this.target),this.rotation+=.5*(Math.random()-.5)},ai:function(){var t=this.angleTo(this.target),e=this.distanceTo(this.target);if(this.turnToward(t),this.moveAt(1),100>e&&this.target.health>0&&Math.random()<.5){var i=this.sdTime-this.elapsed-250;if(i>0){var s=new Projectile(this.target,this,this.x,this.y,this.rotation);s.sdTime=i,s.after(s.sdTime,s.removeSelf),s.rotation+=2*Math.random()-1,this.parentNode.append(s)}}},hitDetect:function(){return Beam.fastBeams&&this.target.health<=0?this.removeSelf():void Projectile.hitDetect.apply(this,arguments)},hit:function(){var t=10*(1-this.elapsed/this.sdTime);if(this.target.health-=this.damage+t,this.health=0,!Explosion.fastExplosions&&this.parent){var e=this.damage+t;e>this.target.maxHealth&&(e=this.target.maxHealth);var i=new Circle(5*Math.random()+.1*e,{rotation:this.rotation,x:this.x,y:this.y,strokeWidth:1,scale:1,compositeOperation:"lighter",stroke:"#a500a5"});i.animate("opacity",.8,0,300,"sqrt"),i.animateToFactor("scale",5,300,"sqrt"),i.after(300,i.removeSelf),this.parent.append(i)}}}),Railgun=Klass(Weapon,{isMissile:!0,movementSpeed:550,turningSpeed:.2,projectileHealth:5,range:600,optimalRange:400,reloadTime:4e3,salvos:1,color:"orange",hitRadius:10,damageType:"kinetic",initialize:function(){Weapon.initialize.apply(this,arguments),this.techLevel>=1&&(this.movementSpeed+=50,this.reloadTime*=.75),this.techLevel>=2&&(this.turningSpeed*=1.5),this.techLevel>=3&&(this.movementSpeed*=1.2,this.hitRadius*=1.2,this.range*=1.2),this.techLevel>=4&&(this.movementSpeed*=1.3,this.hitRadius*=1.3,this.range*=1.4,this.reloadTime*=.66)},initAI:function(){var t=Math.cos(this.ship.rotation),e=Math.sin(this.ship.rotation);this.x+=4*t,this.y+=4*e,this.rotation=this.predictAngleToTarget(this.movementSpeed)+.2*(Math.random()-.5)*(1/(1+this.techLevel));var i=new CanvasNode({scale:[.2,.8],stroke:"#ba88ba",strokeWidth:2,x:this.x,y:this.y,rotation:this.rotation});i.append(new Circle(30,{x:60}));var s=400;i.animateToFactor("scale",1.4+.001*this.movementSpeed,s,"sqrt"),i.animate("opacity",1,0,s,"sqrt"),i.after(s,i.removeSelf);var a=new CanvasNode({fill:"#ba88ba",x:this.x,y:this.y,rotation:this.rotation});a.append(new Rectangle(this.movementSpeed/40,2,{centered:!0})),a.animate("opacity",1,0,600,"sqrt"),a.childNodes[0].animateTo("x",.1*-this.movementSpeed,600,"sqrt"),a.after(600,a.removeSelf),this.afterFrame(1,function(){this.parentNode.append(i),this.parentNode.append(a)}),this.after(3e3,this.removeSelf)},ai:function(){this.moveAt(1-Math.sqrt(this.elapsed/6e3));var t=this.predictAngleToTarget(this.movementSpeed*this.moveSpeedFactor);this.turnToward(t)},hit:function(){var t=this.movementSpeed*this.moveSpeedFactor,e=new CanvasNode({x:this.x,y:this.y,rotation:this.rotation});e.after(300,e.removeSelf),this.parent&&this.parent.append(e),this.rotation+=(Math.random()-.5)*(1-.0015*t),this.elapsed+=500;var i=Math.abs(.5*t);this.target.health-=i;var s=new Explosion(.25);if(s.x=this.x,s.y=this.y,this.parent&&this.parent.append(s),this.fill="darkred",this.health-=2,this.model.height=1,!this.hasHit){var a=new Circle(10,{x:30,scale:[.2,1],strokeWidth:5,fill:"none",stroke:"#ba88ba"});1>=t&&(t=1),a.animateTo("x",30+.03*t,300,"sqrt"),a.animateToFactor("radius",2+.005*t,300,"sqrt"),a.animate("opacity",1,0,300,"sqrt"),e.append(a)}this.hasHit=!0}}),PointDefenseMissiles=Klass(Weapon,{movementSpeed:250,turningSpeed:4,health:1,range:250,optimalRange:100,reloadTime:500,damage:4,hitRadius:7,height:1,salvos:2,isMissile:!0,color:"#dd2222",damageType:"explosive",initialize:function(){Weapon.initialize.apply(this,arguments),this.salvos+=Math.max(0,Math.round(this.techLevel-2)),this.reloadTime*=Math.pow(.8,this.techLevel),this.turningSpeed*=Math.pow(1.2,this.techLevel),this.movementSpeed*=Math.pow(1.1,this.techLevel)},initAI:function(){this.rotation=this.predictAngleToTarget(this.movementSpeed)+(Math.random()-.5),this.after(1400,this.removeSelf)},ai:function(){var t=this.angleTo(this.target);this.turnToward(t),this.moveAt(1-Math.sqrt(this.elapsed/6e3))},hit:function(){this.target.rotation+=.5*Math.random()-.25,this.target.movementSpeed*=1-2/this.target.health,this.target.health-=this.damage,this.health=0}}),PointDefenseGun=Klass(Weapon,{movementSpeed:450,turningSpeed:0,health:1,range:150,height:1,optimalRange:30,reloadTime:250,hitRadius:5,damage:2,salvos:1,isMissile:!0,color:"#dd2222",damageType:"kinetic",initialize:function(){Weapon.initialize.apply(this,arguments),this.hitRadius+=this.techLevel},initAI:function(){this.x+=20*Math.cos(this.ship.rotation),this.y+=20*Math.sin(this.ship.rotation),this.model.width=4,this.rotation=this.techLevel>=2?this.predictAngleToTarget(this.movementSpeed):this.angleTo(this.target),this.after(600,this.removeSelf)},ai:function(){this.moveAt(1-Math.sqrt(this.elapsed/1200))},hit:function(){this.target.rotation+=.5*Math.random()-.25,this.target.movementSpeed*=1-1/this.target.health,this.target.health-=this.damage,this.health=0}}),Level=Klass(CanvasNode,{bgColor:"rgb(0,0,0)",bgOpacity:.15,playerTeam:"#aa2222",enemyTeam:"#2266aa",initialize:function(){CanvasNode.initialize.call(this),this.ships={},this.bg=new Rectangle(this.width,this.height),this.bg.centered=!0,this.bg.x=this.width/2,this.bg.y=this.height/2,this.bg.fill=this.bgColor,this.bg.fillOpacity=this.bgOpacity;var t,e,i,s=this,a=function(t){return s.childNodes.filter(function(e){var i=Math.min(t.cx,t.x2),s=Math.max(t.cx,t.x2),a=Math.min(t.cy,t.y2),n=Math.max(t.cy,t.y2);return e.isShip&&e.strategicAI==Player&&e.x>=i&&e.x<=s&&e.y>=a&&e.y<=n})};this.selectRect=new Rectangle(0,0,{stroke:1,strokeOpacity:.4,stroke:"#00ff00",fillOpacity:.1,fill:"#00ff00",visible:!1,zIndex:999}),this.append(this.selectRect),this.addEventListener("mousedown",function(a){a.preventDefault();var n=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(this.currentMatrix),this.root.mouseX,this.root.mouseY);e=this.root.mouseX,i=this.root.mouseY,t=n,s.selectRect.x2=s.selectRect.cx=n[0],s.selectRect.y2=s.selectRect.cy=n[1]},!1),this.addEventListener("drag",function(){var t=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(this.currentMatrix),this.root.mouseX,this.root.mouseY);if(!s.selectRect.visible){var a=e-this.root.mouseX,n=i-this.root.mouseY,h=a*a+n*n;s.selectRect.visible=h>81}s.selectRect.visible&&(s.selectRect.x2=t[0],s.selectRect.y2=t[1])},!1),this.mouseupHandler=function(e){var i=CanvasSupport.tMatrixMultiplyPoint(CanvasSupport.tInvertMatrix(s.currentMatrix),s.root.mouseX,s.root.mouseY);if(t&&s.selectRect.visible){s.selectRect.visible=!1;var n=a(s.selectRect);e.shiftKey?n.forEach(Player.select.bind(Player)):e.altKey?n.forEach(Player.deselect.bind(Player)):(Player.clearSelection(),n.forEach(Player.select.bind(Player))),t=null}else(e.canvasTarget==s.selectRect||e.canvasTarget==s.bg)&&Player.setWaypoint(i)},this.addEventListener("rootChanged",function(t){t.canvasTarget==this&&(this.root&&this.root.removeEventListener("mouseup",this.mouseupHandler,!1),t.relatedTarget.addEventListener("mouseup",this.mouseupHandler,!1))},!1),this.addFrameListener(function(){if(this.root&&this.root.width&&this.width){var t=this.root.width/this.width,e=this.root.height/this.height;this.scale=Math.min(t,e),this.bg.scale=Math.max(t,e)/this.scale,this.x=(this.root.width-this.width*this.scale)/2,this.y=(this.root.height-this.height*this.scale)/2,this.messageLayer.x=this.width/2,this.messageLayer.scale=this.width/640}}),this.bg.zIndex=-100,this.messageLayer=new CanvasNode({zIndex:1e3}),this.append(this.bg,this.messageLayer),this.addFrameListener(function(){this.cursor=Player.selection.length>0?MOVE_TO_CURSOR:DEFAULT_CURSOR}),this.destroyedHandler=this.destroyed.bind(this),this.when("teamDestroyed",function(t){t.detail==this.enemyTeam?this.enemyTeamDestroyed(t.detail):t.detail==this.playerTeam&&this.gameOver()}),this.showDescription()},enemyTeamDestroyed:function(){this.levelCompleted()},showDescription:function(){var t=E("div");t.appendChild(E("h1",this.name)),t.appendChild(E("div",this.description)),this.query(t,"Start level",function(){this.root.dispatchEvent({type:"started",canvasTarget:this})},"Back to main menu",function(){this.parentNode.gameOver()})},query:function(t){var e=E("div",{className:"message"}),i=new ElementNode(e,{x:0,y:30,align:"center"}),s=E("div",t);e.appendChild(s);for(var a=E("div"),n=this,h=1;h<arguments.length;h+=2){var o=arguments[h],r=arguments[h+1];a.appendChild(E("h2",o,{onclick:function(t){return function(){this.clicked||(t.call(n),this.clicked=!0,i.after(500,i.removeSelf),i.animateTo("opacity",0,500,"sine"))}}(r),style:{cursor:"pointer"}}))}e.appendChild(a),i.opacity=0,i.animateTo("opacity",1,500,"sine"),this.messageLayer.append(i)},notify:function(t,e,i){e||(e=0),this.after(e,function(){var e=new ElementNode(E("h3",t),{x:0,y:30,align:"center"});i||(i=3500+10*e.element.textContent.length),e.opacity=0,e.animateTo("opacity",1,500,"sine"),e.after(i,function(){this.animateTo("opacity",0,500,"sine")}),e.after(i+500,e.removeSelf),this.messageLayer.append(e)})},gameOver:function(){this.completed||(this.failed=!0,this.after(1e3,function(){this.query(E("h1","Your fleet was destroyed"),"Try again",function(){this.parentNode.tryAgain()},"Back to main menu",function(){this.parentNode.gameOver()})}))},levelCompleted:function(){this.failed||this.after(1e3,function(){this.failed||(this.completed=!0,this.query(E("h1","Level complete"),"Next level",function(){this.parentNode.nextLevel()},"Play again",function(){this.parentNode.tryAgain()},"Back to main menu",function(){this.parentNode.gameOver()}))})},createShip:function(t,e,i,s,a,n,h){this.ships[t]||(this.ships[t]=0);var o;if(i.length&&(i[1]&&(o=i[1]),i=i[0]),!o)switch(i){case Missiles:o=PointDefenseMissiles;break;case Beam:o=Beam;break;case RapidFireRailgun:o=RapidFireRailgun;break;default:o=PointDefenseGun}var r=new Ship(t,new i(e),new o(e),s,a,n,h);return r.strategicAI=t==this.playerTeam?Player:FleetAI,r.when("destroyed",this.destroyedHandler),this.ships[t]++,r},createGroup:function(t,e,i,s,a,n,h){var o=0,r=this,l=2*Math.PI/(a.length-1);return a.map(function(a){if(0==o)var p=0,c=0;else var d=o*l,m=Math.max(80,100/l),p=Math.cos(d)*m,c=Math.sin(d)*m;return o++,r.createShip(t,e,a,i+p,s+c,n,h)})},ship:function(){this.append(this.createShip.apply(this,arguments))},shipAfter:function(t,e,i,s,a,n,h,o){this.ships[e]||(this.ships[e]=0),this.ships[e]++,this.after(t,function(){this.ships[e]--,this.ship(e,i,s,a,n,h,o)})},group:function(){this.append.apply(this,this.createGroup.apply(this,arguments))},groupAfter:function(t,e,i,s,a,n,h,o){this.ships[e]||(this.ships[e]=0),this.ships[e]+=n.length,this.after(t,function(){this.ships[e]-=n.length,this.group(e,i,s,a,n,h,o)})},destroyed:function(t){this.ships[t.canvasTarget.team]--,this.ships[t.canvasTarget.team]<1&&this.root.dispatchEvent({type:"teamDestroyed",detail:t.canvasTarget.team,canvasTarget:this})}}),Level1=Klass(Level,{width:640,height:480,name:"Run like the wind",description:"Try not to get blown up.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.shipAfter(0,this.playerTeam,0,Missiles,100,100),this.shipAfter(5e3,this.enemyTeam,0,PointDefenseGun,680,300,!0),this.shipAfter(1e4,this.enemyTeam,0,PointDefenseMissiles,-40,220,!0),this.shipAfter(15e3,this.enemyTeam,0,[Beam,PointDefenseGun],400,520,!0)})}}),Level2=Klass(Level,{width:1280,height:960,scale:.5,name:"What doesn't hit you, can't hurt you",description:"Take care not to get overwhelmed.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.shipAfter(500,this.playerTeam,1,Beam,700,500),this.shipAfter(1e3,this.playerTeam,1,Beam,600,300),this.notify("Reinforcements are on the way",2e4),this.shipAfter(23e3,this.playerTeam,1,Beam,640,480),this.shipAfter(3e3,this.enemyTeam,0,Missiles,1320,800),this.shipAfter(17e3,this.enemyTeam,0,Missiles,1100,-40),this.shipAfter(32e3,this.enemyTeam,0,Missiles,810,1e3),this.shipAfter(6e3,this.enemyTeam,0,Missiles,-40,300),this.shipAfter(22e3,this.enemyTeam,0,Missiles,200,1e3),this.shipAfter(24e3,this.enemyTeam,0,PointDefenseGun,100,1e3)
})}}),Level3=Klass(Level,{width:1280,height:960,name:"Formation",description:"It may be a bit tricky, luck helps.",initialize:function(){Level.initialize.call(this),this.when("started",function(){this.ship(this.playerTeam,2,Railgun,600,400),this.ship(this.playerTeam,0,Missiles,650,460),this.groupAfter(5e3,this.enemyTeam,0,400,-40,[Beam,Beam]),this.groupAfter(25e3,this.enemyTeam,0,-40,520,[Beam,Beam]),this.shipAfter(15e3,this.enemyTeam,4,Missiles,1310,1e3)})}}),Level4=Klass(Level,{name:"Against smaller numbers",description:"This should be easy, right?",reinforcementMessage:"Reinforcements are on the way.",width:1280,height:960,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.enemyTeam,1,1e3,180,[Beam,Missiles,Railgun],!0),this.groupAfter(2500,this.playerTeam,1,200,800,[Missiles,PointDefenseMissiles,PointDefenseMissiles,PointDefenseGun,PointDefenseGun,PointDefenseGun]),this.notify(this.reinforcementMessage,17e3),this.groupAfter(2e4,this.playerTeam,1,200,800,[Beam,PointDefenseGun])})}}),Level5=Klass(Level,{name:"Not fair",description:"Well, that's life.",width:1280,height:960,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.groupAfter(3e3,this.enemyTeam,1,.9*this.width,.85*this.height,[RapidFireRailgun,RapidFireRailgun,RapidFireRailgun]),this.group(this.playerTeam,4,200,200,[PointDefenseMissiles,PointDefenseGun,PointDefenseGun,PointDefenseGun,Missiles,Missiles,Missiles])})}}),Level6=Klass(Level,{name:"Ye Good Ole Slug-Out",description:"Tactics, schmactics.",width:1280,height:960,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.enemyTeam,0,.9*this.width,.85*this.height,[Railgun,Railgun,Missiles,Beam,RapidFireRailgun]),this.group(this.playerTeam,0,.1*this.width,.15*this.height,[Railgun,Railgun,Missiles,Beam,RapidFireRailgun])})}}),Level7=Klass(Level,{name:"Missiles are awesome",description:"And make the computer slow doooown.",width:1600,height:1200,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,2,.5*this.width,.15*this.height,[Missiles,Missiles,Missiles,Missiles,Missiles]);for(var t=1;10>=t;t++)this.groupAfter(3e3*t,this.enemyTeam,0,Math.random()*this.width,this.height+40,[Beam,Beam],!0)})}}),Level8=Klass(Level,{name:"Railguns are awesome too",description:"But take oh so long to reload.",width:1600,height:1200,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,4,.2*this.width,.5*this.height,[Railgun,Railgun,Railgun,Railgun,Railgun,Railgun]);for(var t=1;8>=t;t++)this.groupAfter(3e3*t,this.enemyTeam,4,-100,Math.random()*this.height,[Missiles,Missiles],!0);this.groupAfter(27e3,this.enemyTeam,4,.5*this.width,this.height+50,[Missiles,Missiles],!0),this.groupAfter(3e4,this.enemyTeam,4,.5*this.width,-50,[Missiles,Missiles],!0)})}}),Level9=Klass(Level,{name:"Duels",description:"Cheese is awesome as well.",width:1600,height:1200,initialize:function(){Level.initialize.call(this),this.when("started",function(){for(var t=1;10>=t;t++)this.groupAfter(3e3*t-1500,this.playerTeam,4,.8*this.width,this.height*(.1+.8*Math.random()),[6>=t?RapidFireRailgun:PointDefenseGun]),this.groupAfter(3e3*t,this.enemyTeam,4,.2*this.width,this.height*Math.random(),[RapidFireRailgun])})}}),Level10=Klass(Level,{name:"Relaaax",description:"An intermission.",width:1600,height:1200,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,5,.5*this.width,.5*this.height,[RapidFireRailgun,RapidFireRailgun,RapidFireRailgun]);for(var t=1;3>=t;t++)this.groupAfter(3e3*t,this.enemyTeam,2,this.width*Math.random(),this.height*Math.random(),[Railgun,PointDefenseMissiles,PointDefenseMissiles]);for(var t=5;7>=t;t++)this.groupAfter(3e3*t,this.enemyTeam,2,this.width*Math.random(),this.height*Math.random(),[Beam,PointDefenseMissiles,PointDefenseMissiles]);for(var t=9;12>=t;t++)this.groupAfter(3e3*t,this.enemyTeam,4,this.width*Math.random(),this.height*Math.random(),[Missiles,PointDefenseMissiles,PointDefenseMissiles]);this.groupAfter(45e3,this.enemyTeam,5,this.width*Math.random(),this.height*Math.random(),[Missiles,Missiles,Missiles,Missiles,Missiles,Missiles,Missiles])})}}),Level11=Klass(Level,{name:"Encounter",description:"Even fight.",width:2e3,height:1500,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.group(this.playerTeam,5,.2*this.width,.8*this.height,[Railgun,Railgun,Railgun,Missiles,Missiles,Missiles,Beam,Beam,Beam]),this.group(this.enemyTeam,5,.8*this.width,.2*this.height,[Railgun,Railgun,Railgun,Missiles,Missiles,Missiles,Beam,Beam,Beam])})}}),Level12=Klass(Level,{name:"Skirmish",description:"Take out the blue ships.",width:1600,height:1200,wave:20,initialize:function(){Level.initialize.call(this),this.when("started",function(){this.ships[this.playerTeam]=100,this.ships[this.enemyTeam]=100,this.newShips(),this.every(4e3,this.newShips)})},newShips:function(t){if(t||(t=0),this.wave--,1==this.wave)this.ships[this.playerTeam]-=100,this.ships[this.enemyTeam]-=100;else if(0==this.wave)return!1;var e=this.ships[this.playerTeam]||0,i=this.ships[this.enemyTeam]||0,s=new Array(Math.max(1,i-e)).map(this.randomWeapon),a=new Array(Math.max(1,e-i)).map(this.randomWeapon);this.groupAfter(t,this.playerTeam,6*Math.random(),this.width*(.2+.6*Math.random()),this.height*(.2+.6*Math.random()),s),this.groupAfter(t,this.enemyTeam,6*Math.random(),this.width*(.2+.6*Math.random()),this.height*(.2+.6*Math.random()),a)},weapons:[Beam,Missiles,Railgun],randomWeapon:function(){return Math.random()<.02?RapidFireRailgun:Level12.weapons.pick()}}),Level13=Klass(Level,{name:"Random encounter",description:"How will you cope?",width:1600,height:1200,initialize:function(){Level.initialize.call(this),this.when("started",function(){var t=6*Math.random(),e=3+Math.floor(7*Math.random()),i=new Array(e).map(Level12.randomWeapon),s=new Array(e).map(Level12.randomWeapon);this.group(this.playerTeam,t,.2*this.width,.8*this.height,i),this.group(this.enemyTeam,t,.8*this.width,.2*this.height,s)})}}),MenuLevel=Klass(Level,{width:1280,height:960,playerTeam:null,enemyTeam:null,initialize:function(){Level.initialize.call(this),this.menu=new CanvasNode,this.menu.scale=2,this.menu.zIndex=100,this.append(this.menu),this.setupMenu(),this.newShip(),this.every(1e4,this.newShip),this.selectRect.opacity=0},showDescription:function(){},newShip:function(){var t="#2266aa",e="#aa2222",i=this.childNodes.filter(function(e){return e.team==t}).length,s=this.childNodes.filter(function(t){return t.team==e}).length,a=1+3*Math.ceil(Math.max(0,(i-s)/3));this.taskforce(e,Math.random()*this.width,Math.random()*this.height,a);var a=1+3*Math.ceil(Math.max(0,(s-i)/3));this.taskforce(t,Math.random()*this.width,Math.random()*this.height,a)},taskforce:function(t,e,i,s){for(var a=[Missiles,Beam,Railgun],n=6*Math.random(),h=0;s>h;h++){var o=a[Math.floor(a.length*Math.random())],r=o==Missiles?PointDefenseMissiles:PointDefenseGun;o==Beam&&(r=Beam),Math.random()<.05&&(o=r=RapidFireRailgun);var l=new Ship(t,new o(n),new r(n),e+100*Math.random()-50,i+100*Math.random()-50);"#2266aa"==t&&(l.strategicAI=FleetAI),this.append(l)}},setupMenu:function(){var t=E("h1");t.appendChild(T("MISSILE FLEET"));var e=new ElementNode(t,{x:320,y:40,zIndex:1002,align:"center",cursor:"default"}),i=this,s=new CanvasNode,a=new ElementNode(E("div",{style:{width:"640px",height:"480px",backgroundColor:this.bgColor,opacity:.5}}),{zIndex:1001});s.append(a),s.display="none",s.opacity=0;var n=E("ol");MissileFleet.levels.slice(1).forEach(function(t,e){var s=E("li",E("h3",e+1+". "+t.prototype.name));s.onclick=function(){i.clicked||(i.clicked=!0,i.menu.controls.animateTo("opacity",0,300,"sine"),i.after(300,function(){this.parentNode.jumpToLevel(MissileFleet.levels.indexOf(t))}))},s.style.cursor="pointer",n.appendChild(s)});var h=E("h2","JUMP TO LEVEL"),o=new ElementNode(h,{zIndex:1002,x:320,y:120,align:"center"}),r=new ElementNode(n,{zIndex:1002,x:320,y:164,align:"center"}),l=new Rectangle(540,1,{centered:!0,x:320,y:87.5,fill:"red"});s.append(o,r,l),this.menu.title=e,this.menu.controls=s,this.menu.append(e),this.menu.append(s),this.bg.addEventListener("click",function(){i.menuVisible||i.showMenu()},!1)},showMenu:function(){if(!this.menuVisible){this.menuVisible=!0;var t=this;this.menu.controls.display="block",this.menu.controls.animateTo("opacity",1,500,"sine"),this.menu.after(1e4,function(){this.controls.animateTo("opacity",0,500,"sine"),this.after(500,function(){this.controls.display="none",t.menuVisible=!1})})}}}),MissileFleet=Klass(CanvasNode,{levelIndex:0,levels:[MenuLevel,Level1,Level2,Level3,Level4,Level5,Level6,Level7,Level8,Level9,Level10,Level11,Level12,Level13],initialize:function(t){CanvasNode.initialize.call(this),this.canvas=new Canvas(t),this.canvas.frameDuration=30,this.canvas.append(this),this.canvas.fixedTimestep=!0,this.canvas.clear=!1,this.gameOver(),this.setupEtc()},gameOver:function(){this.levelIndex=0,this.changeLevel(this.levels[this.levelIndex])},nextLevel:function(){this.levelIndex++;var t=this.levels[this.levelIndex%this.levels.length];this.changeLevel(t)},jumpToLevel:function(t){this.levelIndex=t;var e=this.levels[this.levelIndex%this.levels.length];this.changeLevel(e)},tryAgain:function(){this.changeLevel(this.levels[this.levelIndex])},changeLevel:function(t){Player.waypoints={},Player.targets={},Player.selection=[],this.level&&this.level.removeSelf(),t&&(this.level=new t,this.append(this.level))},fastExplosions:!1,setFastExplosions:function(t){this.fastExplosions=t,Explosion.fastExplosions=t},noExplosions:!1,setNoExplosions:function(t){this.noExplosions=t,Explosion.prototype.visible=!t},fastBeams:!1,setFastBeams:function(t){this.fastBeams=t,Beam.fastBeams=t},setupEtc:function(){this.canvas.updateFps=!0;var t=E("div"),e=-1,i=E.canvas(200,10),s=T(""),a=T(""),n=T(""),h=T("");E.append(t,s," fps (",a," ms to draw scene)",E("br"),n," real fps (",h," ms between frames)",E("br"),i);var o=i.getContext("2d");o.globalCompositeOperation="copy",o.fillStyle="#828292",this.canvas.addFrameListener(function(t){if(this.updateFps&&(o.drawImage(i,-1,0),o.clearRect(199,0,1,10),o.fillRect(199,0,1,Math.min(100,this.currentRealFps)/3.3),Math.floor(t/500)!=e)){e=Math.floor(t/500);var r=Math.floor(10*this.fps)/10,l=Math.floor(1e3/this.fps),p=Math.floor(10*this.realFps)/10,c=Math.floor(1e3/this.realFps);s.textContent=r,a.textContent=l,n.textContent=p,h.textContent=c}}),this.canvasControlPanel=new GuiConfig({object:this.canvas,container:$("debug"),title:"Debug",controls:["updateFps","playOnlyWhenFocused","drawBoundingBoxes",["useMockContext","boolean",{title:"Turn off drawing. Useful for benchmarking the AI."}]]}),this.canvasControlPanel.show(),this.controlPanel=new GuiConfig({object:this,container:$("debug"),title:"Graphics",controls:["fastExplosions","noExplosions","fastBeams"]}),this.controlPanel.show(),this.playerControlPanel=new GuiConfig({object:Player,container:$("debug"),title:"Support AI",controls:[["useMovementAI","boolean",{title:"Use movement AI"}],["useTargettingAI","boolean",{title:"Use targetting AI"}]]}),this.playerControlPanel.show(),this.enemyControlPanel=new GuiConfig({object:FleetAI,container:$("debug"),title:"Enemy AI",controls:[["targetByThreat","boolean"],["useDamageEstimates","boolean"],["runAway","boolean"]]}),this.enemyControlPanel.show(),$("debug").appendChild(t)}}),init=function(){var t=E.canvas(window.innerWidth,window.innerHeight),e=E("div",{id:"screen"});e.appendChild(t),document.body.appendChild(e),MF=new MissileFleet(t)};