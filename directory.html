<!DOCTYPE html>
<html>

<head>
    
    <script class="singulr-ignore" src="js/singulr-page.js"></script>
    
    <title>Directory - Troop 485</title>

</head>

<body>

    <div class="container">
        
        <div class="row" id="search">
            <div class="box col-xs-12">
                <hr>
                <h2 class="intro-text text-center">Search</h2>
                <hr>
                <p><button class="btn btn-default" onclick="Singulr.loadPage('logout.html?redir=directory.html')">Log out</button></p>
                <p>Click on the name for more information.</p>
                <div class="input-group col-xs-12">
                    <input type="text" id="search-query" class="form-control" placeholder="Type a name...">
                    <span class="input-group-btn" style="vertical-align: top">
                        <button class="btn btn-default" type="button" id="search-btn">
                            <i class="glyphicon glyphicon-search"></i>
                        </button>
                    </span>
                </div>
                
                <table class="table" id="results" style="display: none;">
                    <thead>
                        <tr>
                            <th class="col-xs-1">Name</th>
                            <th class="col-xs-1">Cell Phone</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p id="no-result" style="display: none;"></p>
                <div id="detail" style="display: none;"></div>
            </div>
        </div>

        <div class="row" id="spreadsheet-confirm">
            <div class="box">
                <button type="button" id="spreadsheet-confirm-btn" class="btn btn-default">Show spreadsheet</button>
            </div>
        </div>

        <div class="row" id="spreadsheet" style="display: none;">
            <div class="box">
                <ul class="nav nav-tabs no-fancy-navbar">
                    <li class="active"><a data-toggle="tab" href="#cacti">Cacti</a></li>
                    <li><a data-toggle="tab" href="#wildcats">Wildcats</a></li>
                    <li><a data-toggle="tab" href="#hawks">Hawks</a></li>
                    <li><a data-toggle="tab" href="#serpents">Serpents</a></li>
                    <li><a data-toggle="tab" href="#blobfish">Blobfish</a></li>
                    <li><a data-toggle="tab" href="#dragons">Dragons</a></li>
                </ul>

                <div class="tab-content" id="spreadsheet-content"></div>
            </div>
        </div>
        
    <script src="https://static.getclicky.com/js"></script>
    <script>try{clicky.init(100869133)}catch(e){}</script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="https://in.getclicky.com/100869133ns.gif"></p></noscript>
    
    </div>
    <!-- /.container -->

    
    
    <script src="js/sjcl.min.js"></script>
    <script src="js/tabletop.min.js"></script>
    
    <script>
        /* global Tabletop */
        
        
        
        auth(function() {
            let text = '{"iv":"u94eK78S4EOGQqpYNDLrGw==","v":1,"iter":1000,"ks":128,"ts":64,"mode":"ccm","adata":"","cipher":"aes","salt":"g17ODbhwHcY=","ct":"66YjjNZp1zkWyBjPUD4XTHy2aHx8v2wPxywiPhbCxjCF8YWkhLzYnVgojeMZV2zbuQHjmrRLVbR+DTdeJzy0Xv70w1ez/eX4uX5nfiBCzi2kO4NwSLXUvJiIcuPGL7BLnXXXw893c0ADbqJUj6fS2nCfi0n9BT' +
            'koU9U8fDNXrsnRUkD0Oqd7khInVvOBoa4c1hjGx1P8cI3WXn29l0ezln2GPH1xqDenWQJTC+tAZ12a2e0uIb+zHIHJkTtjiZPGPBlZDe5/mFeqzr3e6qvZyawlOyI+NlrlQ3a10txli8P9M65UgfPhRDSMdGmeTuhiYkOhvUayWXg/DqMzabBem7cBcflxl8EzNuneoQ43E3ACqr/PdWyC5FBeNKTktyUQR6ypHQIWQwng0d5D7N9ZdfhGTzBDr3IYFaczaBATUuTnlMnBvhF/Jxvs5Rf8uiobblIrP1J25p9kzLe8acU="}';
            let secretInfo = JSON.parse(sjcl.decrypt('XH7uDeHIOFaJvizWBhA', text));
            
            
            $('#search-query').focus();
            
            $('#spreadsheet-confirm-btn').click(function () {
                $('#spreadsheet-confirm').hide();
                $('#spreadsheet-content').html(
                    '<div id="cacti" class="tab-pane fade in active">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.cacti + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.cacti + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="hawks" class="tab-pane fade">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.hawks + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.hawks + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="wildcats" class="tab-pane fade">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.wildcats + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.wildcats + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="serpents" class="tab-pane fade">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.serpents + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.serpents + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="blobfish" class="tab-pane fade">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.blobfish + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.blobfish + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="dragons" class="tab-pane fade">' +
                        '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.dragons + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                        '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.dragons + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>'
                );
                $('#spreadsheet').show();
            });
            
            
            // Cacti
            Tabletop.init({key: secretInfo.cacti, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Cacti';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
            // Hawks
            Tabletop.init({key: secretInfo.hawks, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Hawks';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
            // Wildcats
            Tabletop.init({key: secretInfo.wildcats, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Wildcats';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
            // Serpents
            Tabletop.init({key: secretInfo.serpents, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Serpents';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
            // Blobfish
            Tabletop.init({key: secretInfo.blobfish, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Blobfish';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
            // Dragons
            Tabletop.init({key: secretInfo.dragons, callback: function (data) {
                data.forEach(curData => {
                    curData.patrol = 'Dragons';
                });
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            
        }, function() {
            Singulr.loadPage('login.html?redir=directory.html');
        });
        
        
        
        window.globalData = [];
        $(document).ready(function() {
            $('#password').focus();
        });
        
        
        
        $('#search-query').keypress(function(e){
            if(e.keyCode === 13) {
                $('#search-btn').click();
            }
        });
        
        
        $('#search-btn').click(function() {
            let userquery = $('#search-query').val();
            if (userquery === '') return;
            
            
            userquery = userquery.toLowerCase();
            //console.log(userquery);
            let query = [];
            
            if (userquery.search(' ') > 0) {
                query = userquery.split(' ');
            } else {
                query[0] = userquery;
                query[1] = null;
                // If more than one space use only first 2
                if (query[2] !== undefined) query = query.splice(0, 2);
            }
            if (query[1] === '') query[1] = null;
            
            //console.log(window.globalData);
            //console.log(query);
            
            // Split the names into first and last names
            let patrolnames = [];
            for (let curGlobalData of window.globalData) {
                let fullname = curGlobalData['Scout\'s Full Name (last name first):'];
                let name;
                if (fullname.search(', ') > 0) {
                    name = fullname.split(', ');
                    let temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                } else if (fullname.search(' ') > 0) {
                    name = fullname.split(' ');
                } else if (fullname.search(',') > 0) {
                    name = fullname.split(',');
                    let temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                } else {
                    name = 'ERROR';
                    console.error('Unable to split given full name into first and last name');
                }
                name[0] = name[0].toLowerCase();
                name[1] = name[1].toLowerCase();
                patrolnames.push(name);
            }
            //console.log(patrolnames);
            
            // Search for patrolnames for query
            let results = [];
            // score lower is better
            let score = [];
            for (let i = 0; i < patrolnames.length; i++) {
                // Only first/last name
                if (query[1] === null) {
                    if (patrolnames[i][0] === query[0] || patrolnames[i][1] === query[0]) {
                        score.push({id: i, score: 0});
                    } else {
                        let diff = compare(query[0], patrolnames[i][0]) < compare(query[0], patrolnames[i][1]) ?
                                   compare(query[0], patrolnames[i][0]) : compare(query[0], patrolnames[i][1]);
                        if (diff < query[0].length / 2) {
                            score.push({id: i, score: diff + 1});
                        }
                    }
                // If direct match set score to 0
                } else if (patrolnames[i][0] === query[0] && patrolnames[i][1] === query[1]) {
                    score.push({id: i, score: 0});
                    break;
                // First and last name
                } else {
                    let diff = compare(query[0], patrolnames[i][0]) + compare(query[1], patrolnames[i][1]);
                    if (diff < (query[0].length + query[1].length) / 2) {
                        score.push({id: i, score: diff + 1});
                    }
                }
            }
            score.sort(function(a, b) {
                return parseFloat(a.score) - parseFloat(b.score);
            });
            
            // Make sure scores list has items
            if (score[0]) {
                let firstScore = score[0].score;
                for (let i = 0; i < score.length; i++) {
                    // If direct match of query
                    if (score[i].score === firstScore) {
                        results.push(score[i].id);
                    } else if (score[i].score !== firstScore) {
                        break;
                    // Otherwise display up to 3 names
                    } else if (i < 3) {
                        results.push(score[i].id);
                    }
                }
            }
            
            //console.log(window.globalData);
            
            
            // Display search results
            $('#detail').hide();
			
      	    $('#results').hide();
          	if (results.length === 0) {
          	    console.log('1');
          	    $('#no-result').html('Your search - <b>' + userquery + '</b> - did not match any names.');
          	    $('#no-result').show();
          	} else {
          	    console.log('2');
                $('#no-result').hide();
                $('#results > tbody').html('');
                for (let result of results) {
                    console.log(result);
                    let name = window.globalData[result]['Scout\'s Full Name (last name first):'];
                    $('#results > tbody').append(`
                        <tr>
                            <td><a onclick="showfullinfo(${result})">${name}</a></td>
                            <td>${window.globalData[result]['Scout\'s Cell Phone']}</td>
                        </tr>
                    `);
                }
                $('#results').show();
          	}
      	    console.log('3');
        });
        
        
        function showfullinfo(id) {
            console.log(id);
            
            $('#results').hide();
            $('#detail').show().html('').append(`
                <a onclick="$('#results').show();$('#detail').hide();">Back</a><br><br>
                Name:                               ${window.globalData[id]['Scout\'s Full Name (last name first):']}<br>
                Email: <a href="mailto:             ${window.globalData[id]['Scout\'s E-mail:']}">     ${window.globalData[id]['Scout\'s E-mail:']}</a><br>
                Cell Phone: <a href="tel:           ${window.globalData[id]['Scout\'s Cell Phone']}">  ${window.globalData[id]['Scout\'s Cell Phone']}</a><br>
                Home Phone: <a href="tel:           ${window.globalData[id]['Scout\'s Home Phone']}">  ${window.globalData[id]['Scout\'s Home Phone']}</a><br>
                Patrol:                             ${window.globalData[id].patrol}<br><br>
                Father\'s Cell Phone: <a href="tel: ${window.globalData[id]['Father\'s Cell Phone']}"> ${window.globalData[id]['Father\'s Cell Phone']}</a><br>
                Father\'s E-mail: <a href="mailto:  ${window.globalData[id]['Father\'s E-mail']}">     ${window.globalData[id]['Father\'s E-mail']}</a><br>
                Mother\'s Cell Phone: <a href="tel: ${window.globalData[id]['Mother\'s Cell Phone']}"> ${window.globalData[id]['Mother\'s Cell Phone']}</a><br>
                Mother\'s E-mail: <a href="mailto:  ${window.globalData[id]['Mother\'s E-mail']}">     ${window.globalData[id]['Mother\'s E-mail']}</a><br>
            `);
        }
    </script>

</body>

</html>
