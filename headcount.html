<!DOCTYPE html>
<html>

<head>

    <title>Headcounts - Troop 485</title>

</head>

<body>

    <div class="container">

        <div class="row">
            <div class="box">
                <div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center">Headcounts</h2>
                    <hr>
                </div>
                <div class="col-md-12">
                    <div class="collector">
                        <table id="response-table" class="table">
                            <tbody>
                                <tr>
                                    <td><b>If your name is here then you already filled this form.</b></td>
                                </tr>
                            </tbody>
                        </table>
                        <form class="headcount-form form-horizontal" style="margin-left: 20px; width: 30%;" role="form">
                            <div class="input-group" id="headcount-name-group">
                                <label class="control-label" for="headcount-name">Name:</label>
                                <input type="text" id="headcount-name" class="form-control" maxlength="30">
                            </div>
                            <div class="input-group">
                                <label class="control-label" for="headcount-coming">Are you coming?</label>
                                <br>
                                <div class="btn-group" data-toggle="buttons">
                                    <label class="btn btn-default active">
                    <input type="radio" name="headcount-coming" checked="checked" value="yes" /> Yes
                                    </label>
                                    <label class="btn btn-default">
                    <input type="radio" name="headcount-coming" value="no" /> No
                                    </label>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="control-label" for="headcount-adults">Adults coming: </label>
                                <input type="number" id="headcount-adults" class="form-control" min="0" max="10" value="0">
                            </div>
                            <div class="input-group">
                                <label class="control-label" for="headcount-notes">Notes you want to add: </label>
                                <input type="text" id="headcount-notes" class="form-control">
                            </div>
                            <br>
                            <button type="submit" id="headcount-submit" class="btn btn-default">Submit</button>
                        </form>
                    </div>
                    <div class="thank-you" style="display: none;">
                        <p>Thank you. Your reponse has been recieved. </p>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- /.container -->

    
    <script>
        auth(function() {}, function() {
            Singulr.loadPage('login.html?redirect=') + window.location.href.replace(/^(?:\/\/|[^\/]+)*\//, '');
        });
        
        
        var id = getUrlVars()["id"];
        if (id === undefined) {
            console.log("id undefined!");
            alert("Please use the url given by your SiC!");
            window.location = "home.html";
        } else {
            var authFireRef = new Firebase("https://t485auth.firebaseio.com");
            var email = authFireRef.getAuth().google.email;
            
            var fireRef = new Firebase("https://t485.firebaseio.com/headcount/" + id + "/responses");
        }

        var table = document.getElementById("response-table");

        fireRef.on("child_added", function(snapshot) {
            var response = snapshot.val();

            var row = table.insertRow(-1);
            if (response.name === undefined) {
                row.insertCell(0).innerHTML = "";
            } else {
                row.insertCell(0).innerHTML = response.name;
            }
        });

        $("form").submit(function(){
            addHeadcount($("#headcount-name").val(), $(this).serializeArray()[0].value, $("#headcount-adults").val(), $("#headcount-notes").val());
            return false;
        });

        function addHeadcount(name, coming, adults, notes) {
            // Shortest "realistic" name: Hi Li
            if (name === "" || name <= 5) {
                $("#headcount-name-group").attr("class", "has-error has-feedback")
                console.log(name);
            } else {
                console.log(name);
                if (coming === "yes") {
                    fireRef.push({"name": name, "coming": true, "adults": adults, "notes": notes, "email": email});
                } else {
                    fireRef.push({"name": name, "coming": false, "adults": adults, "notes": notes, "email": email});
                }
                $(".collector").hide();
                $(".thank-you").show();
            }
        }

        function getUrlVars() {
            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                vars[key] = value;
            });
            return vars;
        }
    </script>

</body>

</html>
