<html>

<head>
    <title>Update t485 Calendar</title>
</head>

<body>
    <div id="authorize-div" style="display: none">
        <span>Authorize access to Google Calendar API</span>
        <!--Button for the user to click to initiate auth sequence -->
        <button id="authorize-button" onclick="checkAuth()">Authorize</button>
    </div>


    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase.js"></script>
    <script>
        firebase.initializeApp({
            apiKey: 'AIzaSyAvhRMDTAxHRqIM0-RpHxPjZtMn7S_H7K4',
            authDomain: 't485.firebaseapp.com',
            databaseURL: 'https://t485.firebaseio.com',
            storageBucket: 'project-2556333409340273878.appspot.com',
            messagingSenderId: '510743665020'
        });


        function checkAuth() {
            gapi.auth.authorize({
                'client_id': '684146679883-qfbhqhkv147jhcsadvc7qe7vjier80r4.apps.googleusercontent.com',
                'scope': 'https://www.googleapis.com/auth/calendar.readonly',
                'immediate': true
            }, function (authResult) {
                var authorizeDiv = document.getElementById('authorize-div');
                if (authResult && !authResult.error) {
                    // Hide auth UI, then load client library.
                    authorizeDiv.style.display = 'none';
                    gapi.client.load('calendar', 'v3', function() {
                        var request = gapi.client.calendar.events.list({
                            'calendarId': 'bsa485@gmail.com',
                            'timeMin': (new Date()).toISOString(),
                            'showDeleted': false,
                            'singleEvents': true,
                            'maxResults': 30,
                            'orderBy': 'startTime'
                        });

                        request.execute(function(resp) {
                            var events = resp.items;
                            if (events.length > 0) {
                                for (i = 0; i < events.length; i++) {
                                    var event = events[i];
                                    console.log(event);
                                    // var when = event.start.dateTime || event.start.date;
                                }

                                firebase.database().ref('/calendar').set(events);
                            } else {
                                throw new Error('No upcoming events found!');
                            }
                        });
                    });
                } else {
                    // Show auth UI, allowing the user to initiate authorization by
                    // clicking authorize button.
                    authorizeDiv.style.display = 'inline';
                }
            });
        }
    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
</body>

</html>