<!DOCTYPE html>
<html>

<head>
    
    <script class="singulr-ignore" src="js/singulr-page.js"></script>
    
    <title>Resource - Troop 485</title>

</head>

<body>

    <div class="container">

        <div class="row">
            <div class="box col-sm-6">
                <hr>
                <h2 class="intro-text text-center">Resources</h2>
                <hr>
                <ul>
                    <li><a onclick="openModal(event, 'https://docs.google.com/document/d/1IC1fttf7tEZhezKfNKs0ADtHOQjgyBcMSqjQ_75zUKk/mobilebasic')">Council Resource</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/document/d/1dtMPUhKv6eOfKaxk3iMwnRbovgu0yZt6J0mH8wPdBfY/mobilebasic')">Things to Remember</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/presentation/embed?id=15e_mFNG0x4JIhqbCOZ3CDkVm_nrmEnXYE1RFOEQKd-w&start=false&loop=false')">Advancement Presentation (By Calvin Ho)</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/document/d/1ssoNp8eQqNzkeJAefQdLk6aqu5bEMGarUHX9RvpV1BU/mobilebasic')">Resume Template</a></li>
                    <li><a onclick="openModal(event, 'https://troop8.org/sites/troop8.org/files/BSA_Fieldbook.pdf')">BSA Fieldbook (67 MB)</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/presentation/embed?id=1cqU9DQ0c4RXcm0GJ-gJJ8pRP8Ah3WsYApBlaLbrnRhw&start=false&loop=false')">Year End Party Presentation</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/document/d/1a56ZOlhhT1MT7QGXwLSzmsD5l1cahH44O6kUFNTAJ3I/mobilebasic')">Packing List</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/gview?url=http://www.arcconsultinggroup.com/downloads/finance/Patrol%20Leader%20Handbook%2032502.pdf&embedded=true')">Patrol Leader Handbook</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/document/d/16ft2MS85ZYynyJC9lMIo6Kp8yaJQfcGmY62ayj97_uo/mobilebasic')">TLT 2016 - Lecture Notes</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/presentation/embed?id=16vDoqikgorGn4utl1sHBkMhXqbEbvwtGkJ5xMMfbm-o&start=false&loop=false')">2016 Advancement Update</a></li>
                    <li><a onclick="openModal(event, 'https://docs.google.com/viewer?srcid=0Bz_nBTtnwG9-MkVlS19xNGZpR2pQTG1uU1l0cXNoSkVwS1Jz&pid=explorer&efh=false&a=v&chrome=false&embedded=true')">New Scout Requirements 2016 Insert</a></li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="box col-sm-6">
                <hr>
                <h2 class="intro-text text-center">More Resources</h2>
                <hr>
                <div id="resource-list"></div>
            </div>
        </div>

        <div class="row">
            <div class="box col-md-12">
                <hr>
                <h2 class="intro-text text-center">Add <strong>FileS</strong></h2>
                <hr>
                <p>
                    You can upload your own resources. Be sure to provide a
                    meaningful event name or title. Please note that the title
                    of the file you upload is the name people see. If you want
                    to delete a file, email the webmaster with your event
                    name/title.
                </p>
                <form>
                    <div class="form-group">
                        <label for="event-name">Event name/title:</label>
                        <input type="text" class="form-control" id="event-name" required>
                    </div>
                    <div class="form-group">
                        <label for="files">File upload (you can select multiple)</label>
                        <input type="file" id="files" name="files[]" multiple class="form-control-file" required>
                    </div>
                    <div id="upload-progress"></div>
                    <div class="form-group">
                        <input type="submit" id="submit" value="Submit" class="btn btn-default">
                    </div>
                </form>
            </div>
        </div>

    </div>
    <!-- /.container -->
    
    
    <!-- Modal -->
    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="myModal" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button aria-hidden="true" class="close" data-dismiss="modal" type="button">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Content Unavaliable</h4>
                </div>
                
                <div class="modal-body">
                    <iframe frameborder="0" height="90%" id="ifr" name="ifr" src="" width="90%">Unfortunately, this content is unavaliable at this time. Please give feedback for this bug, and view the document on your google drive.</iframe>
                </div>
                
                <div class="modal-footer">
                    <a class="btn btn-primary" href="https://google.com" id="mdlk" target="_blank" type="button">Open in new tab</a>
                    <button class="btn btn-primary" onclick="requestFullScreen();">Fullscreen mode</button>
                    <button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    
    
    <script>
        auth(function() {}, function() {
            sessionStorage.setItem('auth-redirect', 'resources.html');
            Singulr.loadPage('login.html?redirect=resources.html');
        });
        
        
        
        var storageRef = firebase.storage().ref();
        var ref = firebase.database().ref();
        
        
        
        ref.child('resourceUrls').on('child_added', function(snapshot) {
            var response = snapshot.val();
            var listElement = document.getElementById('resource-list');
            var eventName = response.event;
            var resourceUrls = response.urls.split(',');
            var resourceNames = response.names.split(',');
            
            var p = document.createElement('p');
            var h4 = document.createElement('h4');
            h4.innerHTML = eventName;
            p.appendChild(h4);
            
            var list = document.createElement('ul');
            
            for (var i = 0; i < resourceUrls.length; i++) {
                var listItem = document.createElement('li');
                var a = document.createElement('a');
                a.href = resourceUrls[i];
                a.innerHTML = resourceNames[i];
                a.addEventListener('click', (function(i) {
                    return function(e) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        
                        openModal(undefined, resourceUrls[i], resourceNames[i]);
                    };
                })(i));
                    
                
                listItem.appendChild(a);
                list.appendChild(listItem);
            }
            
            p.appendChild(list);
            
            listElement.appendChild(p);
        });
        
        
        
        
        document.getElementById('submit').onclick = function(e) {
            e.preventDefault();
            
            var files = document.getElementById('files').files;
            if (files.length === 0 || document.getElementById('event-name').value === '') {
                alert(files.length === 0 ?
                    'No file provided!' :
                    (document.getElementById('event-name').value === '' ?
                        'Please provide a meaningful event name/title!' :
                        ''));
                return;
            }
            
            var loadedFiles = new Array(files.length);
            var downloadURLs = [];
            var downloadNames = [];
            
            
            for (var i = 0; i < files.length; i++) {
                uploadFile(files[i], i, function(downloadURL, i) {
                    loadedFiles[i] = true;
                    
                    downloadURLs.push(downloadURL);
                    downloadNames.push(files[i].name);
                    console.log(downloadURL);
                    
                    for (var j = 0; j < files.length; j++) {
                        if (loadedFiles[j] === undefined) return;
                    }
                    
                    
                    // all files are loaded
                    console.log('all done!');
                    
                    ref.child('resourceUrls').push({
                        event: document.getElementById('event-name').value,
                        names: downloadNames.toString(),
                        urls: downloadURLs.toString()
                    });
                    
                    alert('File(s) uploaded successfully!');
                    // reload page
                    Singulr.loadPage('resources.html');
                });
            }
        };
        
        
        function uploadFile(file, i, callback) {
            var uploadTask = storageRef.child('resources/' + file.name).put(file);
            window.ut = uploadTask;

            uploadTask.on('state_changed', (function(i) {
                return function(snapshot) {
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    updateProgressBarAndPercent(document.getElementById('up' + i).childNodes[1], document.getElementById('up' + i).childNodes[2], progress);
                };
            })(i), (function(i) {
                return function(error) {
                    // Handle unsuccessful uploads
                    if (error.code === 'storage/canceled') {
                        return;
                    }
                    console.error(error.message);
                    alert('An error occured. Files were not uploaded.');
                };
            })(i), (function(i) {
                return function() {
                    // Handle successful uploads on complete
                    callback(uploadTask.snapshot.downloadURL, i);
                };
            })(i));
            
            
            
            var uploadProgress = document.getElementById('upload-progress');
            
            
            // create progress bar
            var uploadContainer = document.createElement('div');
            uploadContainer.setAttribute('class', 'upload-container');
            uploadContainer.setAttribute('id', 'up' + i);
            
            var uploadName = document.createElement('div');
            uploadName.setAttribute('class', 'upload-name');
            uploadName.innerHTML = file.name;
            uploadContainer.appendChild(uploadName);
            
            var uploadPercent = document.createElement('div');
            uploadPercent.setAttribute('class', 'upload-percent');
            uploadContainer.appendChild(uploadPercent);
            
            var uploadProgressBar = document.createElement('div');
            uploadProgressBar.setAttribute('class', 'upload-progress-bar');
            updateProgressBarAndPercent(uploadPercent, uploadProgressBar, 0);
            uploadContainer.appendChild(uploadProgressBar);
            
            var uploadCancel = document.createElement('div');
            uploadCancel.setAttribute('class', 'upload-cancel');
            uploadCancel.innerHTML = 'X';
            uploadCancel.addEventListener('click', (function(uploadTask, i) {
                return function() {
                    // user canceled download
                    uploadTask.cancel();
                    
                    // slide up the element then remove for smoother removal
                    $('#up' + i).slideUp(function() {
                        $(this).remove();
                    });
                };
            })(uploadTask, i));
            uploadContainer.appendChild(uploadCancel);
            
            
            uploadProgress.appendChild(uploadContainer);
        }
        
        
        
        function updateProgressBarAndPercent(percent, progressBar, progress) {
            // rounds progress to 2 decimal places and makes sure 1.50 turns into 1.5
            progress = +progress.toFixed(2);
            progressBar.style.width = progress + '%';
            percent.innerHTML = progress + '%';
        }
        
        
        
        
        function openModal(e, url, name) {
            var title;
            if (name === undefined && e !== undefined) {
                title = (e.target.tagName === 'A' ? title = e.target.innerHTML : e.target.attributes.alt.nodeValue);
            } else {
                title = name;
            }
            
            $('#myModalLabel').html(title);
            $('#ifr').attr('src', url);
            $('#mdlk').attr('href', url);
            $('#myModal').modal('show');
        }
        
        function requestFullScreen() {
            var el = document.getElementById("ifr");
            // Supports most browsers and their versions.
            var requestMethod = el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullScreen;
        
            if (requestMethod) {
                requestMethod.call(el);
            // Older IE.
            } else if (typeof window.ActiveXObject !== "undefined") {
                var wscript = new ActiveXObject("WScript.Shell");
        
                if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                }
            }
        }
    </script>

</body>

</html>
