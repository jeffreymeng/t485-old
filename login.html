<!DOCTYPE html>
<html>

<head>
    
    <script class="singulr-ignore" src="js/singulr-page.js"></script>
    
    <title>Log In - Troop 485</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">

</head>

<body>

    <div class="container">

        <div class="row">
            <div class="box">
                <div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center">Log In</h2>
                    <hr>
                </div>
                <div class="col-md-12">
                    <p>
                        <div id="sign-in"></div>
                    </p>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
    <!-- /.container -->
    
    
    <script>
        var redirectUrl = getQuery('redir') || 'home.html';
        var email;
        var password;
        
        
        gapi.signin2.render('sign-in', {
            'scope': 'email',
            'width': 240,
            'height': 50,
            'longtitle': true,
            'theme': 'dark',
            'onsuccess': function (googleUser) {
                email = googleUser.getBasicProfile().getEmail();
                // change password generation method?
                password = window.btoa(email);
                
                // console.log('email: ' + email + ' password: ' + password);
                firebase.auth().signInWithEmailAndPassword(email, password).then(function() {
                    // Login succeeded
                    $.get('members', function(response) {
                        if (response !== null) {
                            var members = response.split('\n');
                            
                            // Check if email is on approved list
                            if (members.indexOf(email) > -1) {
                                Singulr.loadPage(redirectUrl);
                            } else {
                                alert('Sorry, but you are not authorized to view this page.');
                                Singulr.loadPage('home.html');
                            }
                        }
                    });
                }).catch(function(error) {
                    console.error(error.message);
                });
            },
            'onfailure': function (error) {
                console.error(error);
            }
        });
        
        
        
        /* Update directory */
        
        // Updated 6/22/16, 215 members (213 on Firebase)
        // Regex: ,.+$
        /*
            // remove old members
            $.get('members', function(response) {
                var emails = response.split('\n');
                
                for (var i = 0; i < emails.length; i++) {
                    var email = emails[i];
                    var password = window.btoa(email);
                    
                    firebase.auth().signInWithEmailAndPassword(email, password).then(function() {
                        firebase.auth().currentUser.delete().catch(function(e) {
                            // error happended
                            console.error(e);
                        });
                    });
                }
            });
            
            // add new members
            $.get('membersnew', function(response) {
                var emails = response.split('\n');
                
                for (var i = 0; i < emails.length; i++) {
                    var email = emails[i];
                    var password = window.btoa(email);
                    
                    firebase.auth().createUserWithEmailAndPassword(email, password);
                }
            });
            
            // check if all emails have a log in
            $.get('members', function(response) {
                var emails = response.split('\n');
                
                signIn(0)
                
                function signIn(i) {
                    firebase.auth().signInWithEmailAndPassword(emails[i], window.btoa(emails[i])).then(function() {
                        firebase.auth().signOut().then(function() {
                            if (emails.length < i) signIn(i++)
                            else {
                                console.log('all done!');
                            }
                        })
                    }).catch(function(e) {
                        console.error(e);
                    });
                }
            });
        */
    </script>

</body>

</html>
