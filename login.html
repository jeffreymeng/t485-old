<!DOCTYPE html>
<html>

<head>
    
    <script id="singulr-ignore">var a=window.location.href;window.location.href='/index.html?'+encodeURIComponent(a.match(/[^\/](\/[\w\%\-\_]+(\.[a-zA-Z]+)?)+(?:(?=\#|\?)|$)/)[0].substr(1))</script>
    
    <title>Log In - Troop 485</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <script src="js/gapi.js"></script>

</head>

<body>

    <div class="container">

        <div class="row">
            <div class="box">
                <div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center">Log In</h2>
                    <hr>
                </div>
                <div class="col-md-12">
                    <p>
                        <div id="my-signin2"></div>
                    </p>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
    <!-- /.container -->
    
    
    <script>
    var redirectUrl = sessionStorage.getItem("auth-redirect") || 'https://t485.org';
    
    function redirectUser(url) {
        Singulr.loadPage(url);
    }
    
    function onSuccess(googleUser) {
        console.log('Logged in as: ' + googleUser.getBasicProfile().getEmail());
        var members;
        $.get('members', function(response) {
            members = response.split('\n');
            if (googleUser !== null) {
                // Login succeeded
                localStorage.setItem("userEmail", googleUser.getBasicProfile().getEmail())
                localStorage.setItem("userInfo", googleUser)
                var email = googleUser.getBasicProfile().getEmail();
                
                // Check if email is on approved list
                if (members.indexOf(email) > -1) {
                    redirectUser(redirectUrl);
                }
                else {
                    alert('Sorry, but you are not authorized to view this page.');
                    redirectUser('home.html');
                }
            }
        });
    
    
    }
    
    function onFailure(error) {
        console.log(error);
    }
    
    function renderButton() {
        gapi.signin2.render('my-signin2', {
            'scope': 'profile email',
            'width': 240,
            'height': 50,
            'longtitle': true,
            'theme': 'dark',
            'onsuccess': onSuccess,
            'onfailure': onFailure
        });
    }
    
    renderButton();
    </script>

</body>

</html>
