<!DOCTYPE html>
<html>

<head>
    <style>
        .spinner {
            width: 40px;
            height: 40px;
            position: relative;
            margin: 100px auto;
        }
        
        .double-bounce1,
        .double-bounce2 {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #333;
            opacity: 0.6;
            position: absolute;
            top: 0;
            left: 0;
            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }
        
        .double-bounce2 {
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }
        
        @-webkit-keyframes sk-bounce {
            0%,
            100% {
                -webkit-transform: scale(0.0)
            }
            50% {
                -webkit-transform: scale(1.0)
            }
        }
        
        @keyframes sk-bounce {
            0%,
            100% {
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            }
            50% {
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }
        
        .spinner {
            width: 100px;
            height: 100px;
            background-color: red;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
        }
        body {
            background-color:#2c3e50;
        }
        h1 p {
            text-align: center;
            font-family: Arial;
        }
    </style>
</head>

<body>
    <br>
    <br>
    <h1>Initalizing login</h1>
    <p>This may take up to 15 seconds with a normal internet connection</p>
    <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAvhRMDTAxHRqIM0-RpHxPjZtMn7S_H7K4",
            authDomain: "t485.firebaseapp.com",
            databaseURL: "https://t485.firebaseio.com",
            storageBucket: "project-2556333409340273878.appspot.com",
            messagingSenderId: "510743665020"
        };
        firebase.initializeApp(config);
    </script>


    <script>
        // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
        function getQuery(e) {
            e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var c = new RegExp("[\\?&]" + e + "=([^&#]*)"),
                n = c.exec(location.search);
            return null === n ? "" : decodeURIComponent(n[1].replace(/\+/g, " "))
        }

        let redirectUrl = getQuery('redir') || 'index.html';
        let provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/userinfo.email');

        firebase.auth().getRedirectResult().then(result => {
            console.log(result);
            // This gives you a Google Access Token. You can use it to access the Google API.
            let token = result.credential.accessToken;
            // The signed-in user info.
            let user = result.user;

            let email = user.providerData[0].email;

            var request = new XMLHttpRequest();
            request.open('GET', 'members', true);

            request.onreadystatechange = function() {
                if (this.readyState === 4) {
                    if (this.status >= 200 && this.status < 400) {
                        // Success!
                        var response = this.responseText;
                        let members = response.split('\n');

                        // Check if email is on approved list
                        if (members.indexOf(email) > -1) {
                            window.location.href = redirectUrl;
                        }
                        else {
                            alert('Your email address is not a member of t485. Please try again with a diffrent email address, or contact the webmaster if you believen this is a mistake. You will be redirected back to the home page after closing this popup.');
                            // reload page
                            window.location.href = "/index.html";
                        }
                    }
                    else {
                        console.log("error")
                    }
                }
            };

            request.send();
            request = null;

            // ...
        }).catch(error => {
            // Handle Errors here.
            let errorCode = error.code;
            let errorMessage = error.message;
            // The email of the user's account used.
            let email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            let credential = error.credential;
            console.log(error);
            firebase.auth().signInWithRedirect(provider);

        });
    </script>

</body>

</html>