<!DOCTYPE html>
<html>

<head>
    <style>
        .spinner {
            width: 40px;
            height: 40px;
            position: relative;
            margin: 100px auto;
        }
        
        .double-bounce1,
        .double-bounce2 {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #fff;
            opacity: 0.6;
            position: absolute;
            top: 0;
            left: 0;
            -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
            animation: sk-bounce 2.0s infinite ease-in-out;
        }
        
        .double-bounce2 {
            -webkit-animation-delay: -1.0s;
            animation-delay: -1.0s;
        }
        
        @-webkit-keyframes sk-bounce {
            0%,
            100% {
                -webkit-transform: scale(0.0)
            }
            50% {
                -webkit-transform: scale(1.0)
            }
        }
        
        @keyframes sk-bounce {
            0%,
            100% {
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            }
            50% {
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }
        
        .spinner {
            width: 100px;
            height: 100px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
        }
        
        body {
            background-color: #2c3e50;
            text-align: center;
        }
        
        h1,
        p {
            font-family: Arial;
        }
        
        .hidden {
            display:none;
        }
    </style>
</head>

<body>
    <noscript>
        Javascrpt must be enabled to use the login feature of T485. Please whitelist javascript for this website or the content below will not work.
    </noscript>
    <br>
    <br>
    <h1>Initalizing login<span id="testing" class="hidden">(Testing Mode, will not redirect)</span></h1>
    <p>This may take up to 15 seconds with a normal internet connection. <a id="cancel" class="btn btn-danger">Click here to cancel and return to the main page</a>, or <a href="https://t485.org" class="text-danger">Force cancel(if cancel link is broken)</a></p>
    <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAvhRMDTAxHRqIM0-RpHxPjZtMn7S_H7K4",
            authDomain: "t485.firebaseapp.com",
            databaseURL: "https://t485.firebaseio.com",
            storageBucket: "project-2556333409340273878.appspot.com",
            messagingSenderId: "510743665020"
        };
        firebase.initializeApp(config);
    </script>


    <script>
        // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
        function getQuery(e) {
            e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var c = new RegExp("[\\?&]" + e + "=([^&#]*)"),
                n = c.exec(location.search);
            return null === n ? "" : decodeURIComponent(n[1].replace(/\+/g, " "))
        }
        if (window.location.hash = "#testing" || getQuery("testing") === null || getQuery("testing") === true) {
            $("#testing").removeClass("hidden");
        }
        else {
            let redirectUrl = getQuery('redir') || 'index.html';
            let provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/userinfo.email');
            $("#cancel").click(function() {
                localStorage.setItem("signin-in-progress", "false");
                firebase.auth().signOut().then(function() {
                    window.location.href = "/";
                }).catch(function(error) {
                    // An error happened.
                    window.location.href = "/";
                });
            });
            firebase.auth().getRedirectResult().then(result => {
                localStorage.setItem("signin-in-progress", "false");
                console.log(result);
                // This gives you a Google Access Token. You can use it to access the Google API.
                let token = result.credential.accessToken;
                // The signed-in user info.
                let user = result.user;

                let email = user.providerData[0].email;

                var request = new XMLHttpRequest();
                request.open('GET', 'members', true);

                request.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        if (this.status >= 200 && this.status < 400) {
                            // Success!
                            var response = this.responseText;
                            let members = response.split('\n');

                            // Check if email is on approved list
                            if (members.indexOf(email) > -1) {
                                window.location.href = redirectUrl;
                            }
                            else {
                                if (confirm('Your email address is not a member of t485. Please try again with a diffrent email address, or contact the webmaster if you believen this is a mistake. Do you want to try again?(OK for yes, Cancel to be redirected to the home page)')) {
                                    localStorage.setItem("signin-in-progress", "true");
                                    firebase.auth().signInWithRedirect(provider);
                                }
                                else {
                                    window.location.href = "/index.html"
                                }
                                // reload page
                                window.location.href = "/index.html";
                            }
                        }
                        else {
                            console.log("error")
                        }
                    }
                };

                request.send();
                request = null;

                // ...
            }).catch(error => {
                // Handle Errors here.
                let errorCode = error.code;
                let errorMessage = error.message;
                // The email of the user's account used.
                let email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                let credential = error.credential;
                console.log(error);
                if (localStorage.getItem("signin-in-progress") !== "true") {
                    localStorage.setItem("signin-in-progress", "true");
                    firebase.auth().signInWithRedirect(provider);
                }
                else {
                    if (alert("Authentication failed with message:" + error.message + "(Code: " + error.code + ") Please contact the webmaster if this was not expected. Do you want to try again?(OK for yes, Cancel to be redirected to the home page)")) {
                        localStorage.setItem("signin-in-progress", "true");
                        firebase.auth().signInWithRedirect(provider);
                    }
                    else {
                        window.location.href = "/index.html"
                    }
                }
            });
        }
    </script>

</body>

</html>