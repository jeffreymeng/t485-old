<!DOCTYPE html>
<html>

<head>

</head>

<body>
    Initalizing login...

    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAvhRMDTAxHRqIM0-RpHxPjZtMn7S_H7K4",
            authDomain: "t485.firebaseapp.com",
            databaseURL: "https://t485.firebaseio.com",
            storageBucket: "project-2556333409340273878.appspot.com",
            messagingSenderId: "510743665020"
        };
        firebase.initializeApp(config);
    </script>


    <script>
        // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
        function getQuery(e) {
            e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var c = new RegExp("[\\?&]" + e + "=([^&#]*)"),
                n = c.exec(location.search);
            return null === n ? "" : decodeURIComponent(n[1].replace(/\+/g, " "))
        }

        let redirectUrl = getQuery('redir') || 'index.html';
        let provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/userinfo.email');

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                firebase.auth().getRedirectResult().then(result => {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    let token = result.credential.accessToken;
                    // The signed-in user info.
                    let user = result.user;

                    let email = user.providerData[0].email;

                    var request = new XMLHttpRequest();
                    request.open('GET', 'members', true);

                    request.onreadystatechange = function() {
                        if (this.readyState === 4) {
                            if (this.status >= 200 && this.status < 400) {
                                // Success!
                                var response = JSON.parse(this.responseText);
                                let members = response.split('\n');

                                // Check if email is on approved list
                                if (members.indexOf(email) > -1) {
                                    window.location.href = redirectUrl;
                                }
                                else {
                                    alert('Your email address is not a member of t485. Please try again with a diffrent email address, or contact the webmaster if you believen this is a mistake. You will be redirected back to the home page after closing this popup.');
                                    // reload page
                                    window.location.href = "/index.html";
                                }
                            }
                            else {
                                console.log("error")
                            }
                        }
                    };

                    request.send();
                    request = null;
                    $.get('members', response => {
                        if (response) {

                        }
                    });
                    // ...
                }).catch(error => {
                    // Handle Errors here.
                    let errorCode = error.code;
                    let errorMessage = error.message;
                    // The email of the user's account used.
                    let email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    let credential = error.credential;
                    console.log(error);

                });
            }
            else {
                firebase.auth().signInWithRedirect(provider);
            }
        });
    </script>

</body>

</html>