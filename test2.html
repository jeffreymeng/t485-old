<!DOCTYPE html>
<html lang="en">

<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Join Troop 485 in Cupertino to experience an excellent Scouting experience">
    <meta name="author" content="Richard Liu">
    
    <link rel="apple-touch-icon" sizes="144x144" href="favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="favicons/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="favicons/manifest.json">
    <meta name="theme-color" content="#008000">
    
    <title>Google API Test Page</title>
    
    <!-- Bootstrap Core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="css/t485.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Josefin+Slab:100,300,400,600,700,100italic,300italic,400italic,600italic,700italic" rel="stylesheet" type="text/css">

</head>

<body>

    <a href="index.html"><img src="img/header.gif" id="header" alt="Troop 485"></a>

    <!-- Navigation -->
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- navbar-brand is hidden on larger screens, but visible when the menu is collapsed -->
                <a class="navbar-brand" href="index.html">T485</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a href="about.html">About</a>
                    </li>
                    <li>
                        <a href="calendar.html">Calendar</a>
                    </li>
                    <li>
                        <a href="new-scout.html">New Scout</a>
                    </li>
                    <li>
                        <a href="pictures.html">Pictures</a>
                    </li>
                    <li class="dropdown">
                        <a>FAQ <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="faq.html">FAQ</a></li>
                            <li><a href="merit-badges.html">Merit Badges</a></li>
                            <li><a href="eagle.html">Path to Eagle</a></li>
                            <li><a href="smc.html">SMC &amp; BOR</a></li>
                            <li><a href="plc.html">What is PLC?</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a>Resources <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="resources.html">Resources</a></li>
                            <li><a href="meeting-minutes.html">Meeting Minutes</a></li>
                            <li><a href="books.html">Books</a></li>
                            <li><a href="troop-jobs.html">Troop Jobs</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a>Directory <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="directory.html">Directory</a></li>
                            <li><a href="contact.html">Enter Contact Information</a></li>
                        </ul>
                    </li>
                    <li>
                        <a class="login" id="login-btn">Login</a>
                    </li>
                    <li><div id="profile"></div></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
    
    <a href="#" id="toTop"></a>

    <div class="alert alert-info alert-dismissible" role="alert">
        <a class="close" data-dismiss="alert">×</a>
        <span class="glyphicon glyphicon-info-sign"></span>  Click <a href="feedback.html" style="color: darkred;">here</a> to submit feedback to help me improve the website!
    </div>

    <!-- https://accounts.google.com/o/oauth2/auth?response_type=token&scope=profile&redirect_uri=http%3A%2F%2Ft485.org&client_id=484093697294-ptjocjkbkl629v80iuv555e2d04gtq6a.apps.googleusercontent.com -->
    <div class="container">

        <div class="row login">
            <div class="box">
                <div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center">Google Test Page</h2>
                    <hr>
                </div>
                <div class="col-md-12">
                    <p>Work in progress</p>
                    <p>Displays login-only content with redirection using firebase login.</p>
                    <p>Click the sign in link above.</p>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        
        <div class="login-content" style="display: none;">
            <div class="protected">
                <div class="row" id="search">
                    <div class="box col-xs-12">
                        <hr>
                        <h2 class="intro-text text-center">Search</h2>
                        <hr>
                        <p>Click on the name for more information.</p>
                        <p>Notice someone's name is missing? Click <a href="feedback.html">here</a> to submit the bug.</p>
                        <div class="input-group col-xs-12">
                            <input type="text" class="form-control" placeholder="Type a name..." id="search-query">
                            <span class="input-group-btn" style="vertical-align: top">
                                <button class="btn btn-default" type="button" id="search-btn">
                                    <i class="glyphicon glyphicon-search"></i>
                                </button>
                            </span>
                        </div>
                        <table class="table" id="results" style="display: none;">
                            <thead>
                                <tr>
                                    <th class="col-xs-3">Name</th>
                                    <th class="col-xs-3">Cell Phone</th>
                                    <th class="col-xs-3">Father's Cell Phone</th>
                                    <th class="col-xs-3">Mother's Cell Phone</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="detail" style="display: none;"></div>
                    </div>
                </div>
        
                <div class="row" id="spreadsheet-confirm">
                    <div class="box">
                        <button type="button" id="spreadsheet-confirm-btn" class="btn btn-default">Show full directory</button>
                    </div>
                </div>
        
                <div class="row" id="spreadsheet" style="display: none;">
                    <div class="box">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#cacti">Cacti</a></li>
                            <li><a data-toggle="tab" href="#wildcats">Wildcats</a></li>
                            <li><a data-toggle="tab" href="#hawks">Hawks</a></li>
                            <li><a data-toggle="tab" href="#serpents">Serpents</a></li>
                            <li><a data-toggle="tab" href="#old-contact">Old Directory</a></li>
                        </ul>
        
                        <div class="tab-content" id="spreadsheet-content"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- /.container -->

    <footer>
        <div class="container">
            <div class="box">
                <div class="col-lg-12 text-center">
                    <p>Copyright © 2015 Troop 485, Silicon Valley Monterey Bay Council, Boy Scouts of America</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script src="js/t485.js"></script>
    <script src="js/tabletop.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- Firebase -->
    <script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
    
    <!-- Clicky Web Analytics -->
    <script src="https://static.getclicky.com/js"></script>
    <script>try{clicky.init(100869133)}catch(e){}</script>
    <noscript><img alt="Clicky" src="https://in.getclicky.com/100869133ns.gif"></noscript>

    <script>
        /* global getCookie */
        /* global Firebase */
        
        
        if (getCookie('googlelogin') === 'true') {
            $('.login').css('display', 'none');
            $('.login-content').css('display', 'block');
        }
        
        $('#login-btn').click(auth);
        
        
        
        window.members = [];
        var ref = new Firebase('https://t485auth.firebaseio.com');
            
        ref.child('members').on('value', function(snapshot) {
            console.log('read succeeded');
            window.members = snapshot.val();
        }, function(errorObject) {
            console.log('The read failed: ' + errorObject.code);
        });
        
            
        ref.onAuth(function(authData) {
            // Login succeeded
            console.log(authData);
            var email = authData.google.email;
            console.log('login succeeded');
            
            // Check if email is on approved list
            if (window.members.indexOf(email) > -1) {
                $('.login').css('display', 'none');
                $('.login-content').css('display', 'block');
                
                // Create cookie with no expiration date so cookie is deleted when session ends.
                document.cookie = 'googlelogin=true';
                console.log('logged in');
                initTabletop();
            } else {
                alert("You are not authorized to view this page.");
            }
        });
        
        
        function auth() {
            ref.authWithOAuthRedirect('google', function(error) {
               if (error) {
                   console.log('Login failed! ' + error);
               } 
            }, {
                remember: 'sessionOnly',
                scope: 'email'
            });
        }
        
        
        
/*

_|_|_|    _|                                  _|                                          _|_|_|                  _|            
_|    _|      _|  _|_|    _|_|      _|_|_|  _|_|_|_|    _|_|    _|  _|_|  _|    _|      _|          _|_|      _|_|_|    _|_|    
_|    _|  _|  _|_|      _|_|_|_|  _|          _|      _|    _|  _|_|      _|    _|      _|        _|    _|  _|    _|  _|_|_|_|  
_|    _|  _|  _|        _|        _|          _|      _|    _|  _|        _|    _|      _|        _|    _|  _|    _|  _|        
_|_|_|    _|  _|          _|_|_|    _|_|_|      _|_|    _|_|    _|          _|_|_|        _|_|_|    _|_|      _|_|_|    _|_|_|  
                                                                                _|                                              
                                                                            _|_|

*/
        
        
        
        /* global Tabletop */
        
        
        $("#spreadsheet-confirm-btn").click(function () {
            $("#spreadsheet-confirm").css("display", "none");
            $("#spreadsheet-content").html(
                "<div id=\"cacti\" class=\"tab-pane fade in active\">" +
                    "<a href=\"https://docs.google.com/spreadsheets/d/1FUlVVgMz1IgP68LExESAFwokIGc5zWUq6mEk5auKiSU/edit?usp=drive_web\" target=\"_blank\">Edit Spreadsheet</a>" +
                    "<iframe src=\"https://docs.google.com/spreadsheets/d/1FUlVVgMz1IgP68LExESAFwokIGc5zWUq6mEk5auKiSU/pubhtml?widget=true&amp;headers=false\"></iframe>" +
                "</div>" +
                "<div id=\"wildcats\" class=\"tab-pane fade\">" +
                    "<a href=\"https://docs.google.com/spreadsheets/d/1pEWKoQjXaekpDKfZSkAuKt0WCDKNfBIckMbDV-5m31Y/edit?usp=drive_web\" target=\"_blank\">Edit Spreadsheet</a>" +
                    "<iframe src=\"https://docs.google.com/spreadsheets/d/1pEWKoQjXaekpDKfZSkAuKt0WCDKNfBIckMbDV-5m31Y/pubhtml?widget=true&amp;headers=false\"></iframe>" +
                "</div>" +
                "<div id=\"hawks\" class=\"tab-pane fade\">" +
                    "<a href=\"https://docs.google.com/spreadsheets/d/1NUCXRoB3Z2Su-KCG5bTNna3nxNEYHO3KK3n3lIL0wTk/edit?usp=drive_web\" target=\"_blank\">Edit Spreadsheet</a>" +
                    "<iframe src=\"https://docs.google.com/spreadsheets/d/1NUCXRoB3Z2Su-KCG5bTNna3nxNEYHO3KK3n3lIL0wTk/pubhtml?widget=true&amp;headers=false\"></iframe>" +
                "</div>" +
                "<div id=\"serpents\" class=\"tab-pane fade\">" +
                    "<a href=\"https://docs.google.com/spreadsheets/d/1GHWUQD86AGYW5H4M-YnU3c97gFMayzmdVLf2iG8ioEc/edit?usp=drive_web\" target=\"_blank\">Edit Spreadsheet</a>" +
                    "<iframe src=\"https://docs.google.com/spreadsheets/d/1GHWUQD86AGYW5H4M-YnU3c97gFMayzmdVLf2iG8ioEc/pubhtml?widget=true&amp;headers=false\"></iframe>" +
                "</div>" +
                "<div id=\"old-contact\" class=\"tab-pane fade\">" +
                    "<p>This is the old directory. Use this one until the patrol leaders update their patrol's directory.</p>" +
                    "<iframe src=\"https://docs.google.com/spreadsheets/d/1vG2y2euWgG3ASuSpBC9oD5ufZ8YiL4Q-HlPYyKaZ_o0/pubhtml?widget=true&amp;headers=false\"></iframe>" +
                "</div>"
            );
            $("#spreadsheet").css("display", "block");
        });


        window.globalData = [];
        $(document).ready(function() {
            $("#password").focus();
        });
        
        function initTabletop() {
            // Cacti
            Tabletop.init({key: "1FUlVVgMz1IgP68LExESAFwokIGc5zWUq6mEk5auKiSU", callback: function (data, t) {
                for (var i = 0; i < data.length; i++) {
                    data[i].patrol = "Cacti";
                }
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            // Hawks
            Tabletop.init({key: "1NUCXRoB3Z2Su-KCG5bTNna3nxNEYHO3KK3n3lIL0wTk", callback: function (data, t) {
                for (var i = 0; i < data.length; i++) {
                    data[i].patrol = "Hawks";
                }
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            // Wildcats
            Tabletop.init({key: "1pEWKoQjXaekpDKfZSkAuKt0WCDKNfBIckMbDV-5m31Y", callback: function (data, t) {
                for (var i = 0; i < data.length; i++) {
                    data[i].patrol = "Wildcats";
                }
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
            // Serpents
            Tabletop.init({key: "1GHWUQD86AGYW5H4M-YnU3c97gFMayzmdVLf2iG8ioEc", callback: function (data, t) {
                for (var i = 0; i < data.length; i++) {
                    data[i].patrol = "Serpents";
                }
                window.globalData.push.apply(window.globalData, data);
            }, simpleSheet: true});
        }
        
        $("#search-query").keypress(function(e){
            if(e.keyCode === 13) {
                $("#search-btn").click();
            }
        });
        $("#search-btn").click(function() {
            var userquery = $("#search-query").val();
            $("#search-query").val("");
            userquery = userquery.toLowerCase();
            //console.log(userquery);
            var query = [];
            
            if (userquery.search(" ") > 0) {
                query = userquery.split(" ");
            } else {
                query[0] = userquery;
                query[1] = null;
                // If more than one space
                if (query[2] !== undefined) return;
            }
            if (query[0] === '') query[1] = null;

            //console.log(window.globalData);
            //console.log(query);

            // Split the names into first and last names
            var patrolnames = [];
            for (var i = 0; i < window.globalData.length; i++) {
                var fullname = window.globalData[i]["Scout's Full Name (last name first):"];
                var name;
                if (fullname.search(", ") > 0) {
                    name = fullname.split(", ");
                    var temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                } else if (fullname.search(" ") > 0) {
                    name = fullname.split(" ");
                } else if (fullname.search(",") > 0) {
                    name = fullname.split(",");
                    var temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                } else {
                    name = "ERROR";
                    console.error("Unable to split given full name into first and last name");
                }
                name[0] = name[0].toLowerCase();
                name[1] = name[1].toLowerCase();
                patrolnames.push(name);
            }
            //console.log(patrolnames);

            // Search for patrolnames for query
            var results = [];
            // score lower is better
            var score = [];
            for (i = 0; i < patrolnames.length; i++) {
                // Only first/last name
                if (query[1] === null) {
                    if (patrolnames[i][0] === query[0] || patrolnames[i][1] === query[0]) {
                        score.push({id: i, score: 0});
                    } else {
                        var diff = compare(query[0], patrolnames[i][0]) < compare(query[0], patrolnames[i][1]) ?
                                   compare(query[0], patrolnames[i][0]) : compare(query[0], patrolnames[i][1]);
                        if (diff < query[0].length / 2) {
                            score.push({id: i, score: diff + 1});
                        }
                    }
                // If direct match set score to 0
                } else if (patrolnames[i][0] === query[0] && patrolnames[i][1] === query[1]) {
                    score.push({id: i, score: 0});
                }
            }
            score.sort(function(a, b) {
                return parseFloat(a.score) - parseFloat(b.score);
            });

            // Make sure scores list has items
            if (!(score[0] === undefined)) {
                var firstScore = score[0].score;
                for (var i = 0; i < score.length; i++) {
                    // If direct match of query
                    if (score[i].score === firstScore) {
                        results.push(score[i].id);
                    } else if (score[i].score !== firstScore) {
                        break;
                    // Otherwise display up to 3 names
                    } else if (i < 3) {
                        results.push(score[i].id);
                    }
                }
            }

            //console.log(window.globalData);
				
          	
            // Display search results
            $("#results").css("display", "block");
            $("#detail").css("display", "none");
            $("#results > tbody").html("");
            for (var i = 0; i < results.length; i++) {
                var name = window.globalData[results[i]]["Scout's Full Name (last name first):"];
                $("#results > tbody").append(
                    "<tr><td><a onclick=\"showfullinfo(" + results[i] + ")\">" + name
                 + "</a></td><td>"  + window.globalData[results[i]]["Scout's Cell Phone"]
                 + "</td><td>"      + window.globalData[results[i]]["Father's Cell Phone"]
                 + "</td><td>"      + window.globalData[results[i]]["Mother's Cell Phone"] + "</td></tr>");
            }
        });

        function showfullinfo(id) {
            $("#results").css("display", "none");
            $("#detail").css("display", "block").html("").append(
                "Name: "                + window.globalData[id]["Scout's Full Name (last name first):"] + "<br>" +
                "Email: "               + window.globalData[id]["Scout's E-mail:"] + "<br>" +
                "Cell Phone: "          + window.globalData[id]["Scout's Cell Phone"] + "<br>" +
                "Home Phone: "          + window.globalData[id]["Scout's Home Phone"] + "<br>" +
                "Patrol: "              + window.globalData[id]["patrol"] + "<br>" + "<br>" +
                "Father's Cell Phone: " + window.globalData[id]["Father's Cell Phone"] + "<br>" +
                "Father's E-mail: "     + window.globalData[id]["Father's E-mail"] + "<br>" + "<br>" +
                "Mother's Cell Phone: " + window.globalData[id]["Mother's Cell Phone"] + "<br>" +
                "Mother's E-mail: "     + window.globalData[id]["Mother's E-mail"] + "<br>"
            );
        }

        // Code from https://en.wikibooks.org/wiki/Algorithm_Implementation/Strings/Levenshtein_distance#JavaScript
        // Compressed using http://javascript-minifier.com/
        function compare(t,n){if(0===t.length)return n.length;if(0===n.length)return t.length;var r,e=[];for(r=0;r<=n.length;r++)e[r]=[r];var h;for(h=0;h<=t.length;h++)e[0][h]=h;for(r=1;r<=n.length;r++)for(h=1;h<=t.length;h++)n.charAt(r-1)==t.charAt(h-1)?e[r][h]=e[r-1][h-1]:e[r][h]=Math.min(e[r-1][h-1]+1,Math.min(e[r][h-1]+1,e[r-1][h]+1));return e[n.length][t.length]}
    </script>
    
</body>

</html>